---
title:
    | 
    | Ecosystem Context for Stock Assessments:
    | Atlantic menhaden
#date: "`r format(Sys.time(), '%B %d, %Y')`"
author: "Ecosystem Dynamics and Assessment Branch"
always_allow_html: yes
bibliography: "atlantic-menhaden_bib.bib"
link-citations: true
site: "bookdown::bookdown_site"
output:
  bookdown::gitbook:
    lib_dir: "book_assets"
    config:
      toc:
        collapse: yes
        after: |
          <li><a href="https://bookdown.org" target="_blank">Published with bookdown</a></li>
---

```{r, include = FALSE}
## Load packages
# library(ecsa)
library(dplyr)
library(ggplot2)
library(plotly)
library(DT)
library(jpeg)
library(patchwork)
library(ggthemes)
library(AICcmodavg)
library(stringr)
library(ecotrend)
library(magrittr)
library(raster)
library(stars)
library(dplyr)
library(here)
library(zoo)
library(gt)

knitr::opts_chunk$set(echo = F, message = F ,warning = F, fig.align = 'center')

## Read in stock area vectors

all_stock_season <- readr::read_csv(here::here("data/stock_data/stock_list.csv"),
                                 col_types = readr::cols(
                                   common_name = readr::col_character(),
                                   sci_name = readr::col_character(),
                                   cc_name = readr::col_character(),
                                   stock_name = readr::col_character(),
                                   species_code = readr::col_character(),
                                   svspp = readr::col_double(),
                                   stock_season = readr::col_character(),
                                   strata = readr::col_double()
                                 ))
#swept area estimates
spring_sae <- read.csv(here::here("data-raw/spring_sae_tb_sum.csv"), stringsAsFactors = F)
fall_sae <- read.csv(here::here("data-raw/fall_sae_tb_sum.csv"), stringsAsFactors = F)


#zooplankton lookup table
zoo_lookup <- read.csv(here::here("data-raw/zooplankton_lookup.csv"), stringsAsFactors = F)

## Put all mustaches here
common_name <- "Atlantic menhaden"
stock_code <- "36"
stock_name <- "atlantic-menhaden"
cc_name <- "atlantic-menhaden"
stock_subarea <- ""
# svspp <- "{{SVSPP}}"


source(here::here("R/map_strata.R"))
source(here::here("R/get_strata.R"))
source(here::here("R/crop_to_strata.R"))
source(here::here("R/stars_to_series.R"))
source(here::here("R/tab_plotly.R"))
source(here::here("R/create_buttons.R"))
source(here::here("R/STARS_v18.R"))
source(here::here("R/gls_summary.R"))
source(here::here("docs/atlantic-menhaden/R/plot_sae.R"))


#Function to rank time series by group mean. Returns top N groups
rank_by_group <- function(df, group, N, join_with){
  out <- df %>% 
    dplyr::group_by(Grouping = get(group)) %>% 
    dplyr::summarise(M = mean(Mean, na.rm = T)) %>% 
    top_n(N) %>% 
    arrange(desc(M)) %>% 
    mutate(id = 1:N) 
  return(out)
}

N <- 5
alpha <- 0.05

strata <- all_stock_season %>%   
  dplyr::filter(stock_name == !!stock_name)

svspp_ <- strata %>% pull(svspp) %>% unique()

stock_season <- strata %>% pull(stock_season) %>% unique()

#Get unique analytical treatment for SAE processing
treatments <- spring_sae %>%
  dplyr::filter(svspp == svspp_) %>% 
  pull(treatment) %>% 
  unique()

#Get menhaden habitat area estimates
hab_area <- read.csv(
  here::here("docs/atlantic-menhaden/atlantic-menhaden_data/spr fall .25 occ hab.csv"),
  stringsAsFactors = F)

#Chesapeake Bay recruitment index
ches_bay_rec <- read.csv(
  here::here("docs/atlantic-menhaden/atlantic-menhaden_data/CHL polyhaline april.csv"),
  stringsAsFactors = F)

```


# Introduction

This report provides contextual ecosystem information for Atlantic menhaden (*Brevoortia tyrannus*) on the Northeast U.S. Continental Shelf. Data extractions for spring and fall are confined to the Atlantic menhaden stock area based on respective survey strata sets. The information is intended to span a range of potential factors affecting the productivity and distribution of Atlantic menhaden, including: surface and bottom temperature and salinity, chlorophyll concentrations, indices of habitat, diet composition, and abundance of key zooplankton prey of larval Atlantic menhaden. These factors can be used to qualitatively inform the interpretation of population status and/or quantitatively to improve model responsiveness to ecosystem factors. The range and complexity of ecosystem data makes it unlikely to find the most relevant and comprehensive factor variables with a first evaluation; this process will require an iterative approach of evaluation and feedback. Additional indices can be included to address the needs of the working group.

### Summary {-#summary}

Substantial changes have occurred the coast environment supporting the menhaden population. Thermal condition have changed in both spring and fall season, with great rate of change in fall temperatures. Further physical change in the environment can be seen in shift in salinity during the spring. There has also been change in lower trophic level productivity with a significant decline in fall chlorophyll concentration. Zooplankton taxa utilized by menhaden show varying patterns of time series change, with some of the principal taxa increase and other in decline. Zooplankton biomass has not declined during the spring, which would suggest the food resources for menhaden larvae has remained abundant. However, fall zooplankton biomass has decline over the most recent decade and may be a factor for adult feeding. Abundance estimates based on a habitat model suggest the stock continues to be a high level and that regional abundances patterns may have changed.  


### Strata definition {-#strata-definition}

```{r strata-map, eval = T, echo = FALSE, fig.cap= "Strata map for Atlantic menhaden (*Brevoortia tyrannus*) on the NE shelf", message = FALSE, warning = FALSE, fig.align='center'}
# all_strata <- map_strata(stock_name = stock_name,
#            common_name = common_name,
#            stock_season = stock_season,
#            strata = strata,
#            overwrite = FALSE,
#            save_plot = FALSE)

## General mapping parameters
xmin = -77
xmax = -65
ymin = 35
ymax = 45

xlims <- c(xmin, xmax)
ylims <- c(ymin, ymax)
crs <-  "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0" 

## Download data layers

## 2) North America layer
ne_countries <- rnaturalearth::ne_countries(scale = 10,
                                            continent = "North America",
                                            returnclass = "sf") %>% 
  sf::st_transform(crs = crs)

## 3) State layer
ne_states <- rnaturalearth::ne_states(country = "united states of america",
                                      returnclass = "sf") %>% 
  sf::st_transform(crs = crs)


n_s_strata <- all_stock_season %>% dplyr::filter(svspp == svspp_,
                                   stringr::str_detect(stock_name, "north|south")) %>% 
  tidyr::separate(., stock_name, into = c("stock_name1","custom"), sep = "_")

n_strata <- n_s_strata %>% filter(custom == "north") %>% pull(strata)
s_strata <- n_s_strata %>% filter(custom == "south") %>% pull(strata)
strata_spring <- n_s_strata %>% filter(stock_season == "fall") %>% pull(strata)
strata_fall <- n_s_strata %>% filter(stock_season == "spring") %>% pull(strata)


strata_int <- sf::st_read(here::here("data/strata_shapefiles/BTS_Strata.shp"),
                             quiet = TRUE) %>% 
    dplyr::mutate(SEASON = dplyr::case_when(STRATA %in% base::intersect(strata_spring,
                                                                        strata_fall) ~ "spring and fall",
                                            STRATA %in% strata_spring ~ "spring",
                                            STRATA %in% strata_fall ~ "fall",
                                            TRUE ~ "BTS Strata"),
                  N_S = dplyr::case_when(STRATA %in% n_strata ~ "north",
                                            STRATA %in% s_strata ~ "south",
                                            TRUE ~ "BTS Strata")) %>% 
    dplyr::select(SEASON, N_S, geometry)

ggplot2::ggplot() +
    ggplot2::geom_sf(data = strata_int, ggplot2::aes(fill = SEASON), size = 0.05, color = "grey40") +
    ggplot2::geom_sf(data = strata_int, ggplot2::aes(color = N_S), size = 0.2, alpha = 0.1, show.legend = "line") +
    ggplot2::geom_sf(data = ne_countries, color = "grey60", size = 0.25) +
    ggplot2::geom_sf(data = ne_states, color = "grey60", size = 0.05) +
    scale_fill_manual(values = c("spring and fall" = "#b2df8a",
                                 "spring" = "#1f78b4",
                                 "BTS Strata" = "#9ec9e04d"))+
    scale_color_manual(values = c("BTS Strata" = "grey",
                                  "north" = "#fc8d62",
                                  "south" = "#7570b3")) +
    guides(color = guide_legend(title = "North/South\n Delineation",
                                override.aes = list(size = 1,
                                                    alpha = 1)),
           fill = guide_legend(title = "Seasonal Stock\n Strata")) +
    ggplot2::coord_sf(crs = crs, xlim = xlims, ylim = ylims) +
    ggplot2::labs(title = sprintf("%s", common_name),
                  fill = "Season") +
    ggplot2::theme_bw()+
    ggplot2::theme(legend.key.width = ggplot2::unit(2, "cm"))

```


_Last updated on `r format(Sys.Date(), format = "%B %e %Y")`._

# Temperature

An optimal interpolation procedure was used to estimate NE Shelf surface and bottom temperatures for two seasonal time frames (see [methods](https://noaa-edab.github.io/ECSA/#sec:methodstempsalin)). The temperature estimates were standardized to April 3 and October 11 for spring and fall over the period 1968-2018. Surface and bottom temperature within the `r common_name` stock areas are shown below.

## Bottom Temperature {-#bottom-temperature}

Thermal conditions on the Northeast Shelf have changed in recent decades and these changes are reflected in change in bottom water temperatures in the stock areas. In both spring and fall, bottom water temperature have significantly increased, with the suggestion of abrupt changes in temperature early in the time series. The rate of increase has been twice as high in the fall. This index reflect conditions of the inner shelf, so it reflects thermal conditions at relatively shallow depths and would likely have relevance to menhaden.

```{r bot_temp_process}
spring_bottom_temp <- 
  stars_to_series(r = "bot_temp_spring_spdf.rdata",
                stock_name = stock_name, 
                common_name = common_name,
                stock_season = stock_season,
                data_season = "spring",
                measure_name = "bottom_temp") %>% 
  dplyr::filter(Time >= 1968) %>% 
  mutate(season = "Spring") %>% 
  ecotrend::glsMs(Mean ~ Time,
                data = .,
                diagnostic = T,
                fit_model  = T) 


STARS_in <- spring_bottom_temp$fit %>% 
  dplyr::select(-fit) %>% 
  as.matrix()

if (spring_bottom_temp$`selection summary`$pval[1] < 0.05){
  spring_mod <- spring_bottom_temp$model
  
  spring_bottom_temp <- spring_bottom_temp$fit %>% 
    dplyr::select(Time = time, 
                  Series = series,
                  Trend = fit)
  
  summ_ <- gls_summary(mod = spring_mod)
  trend <- summ_$Value[1]
  lci <- summ_$Value[2]
  uci <- summ_$Value[3]

  spring_title <- sprintf("Spring\nTrend:%s (%s, %s)", trend, lci, uci)

} else {
    spring_bottom_temp <- spring_bottom_temp$fit %>% 
      dplyr::select(Time = time, 
                Series = series)
    spring_title <- "Spring"
}

spring_bottom_temp %<>%  
  left_join(.,STARS(mat.in = STARS_in),by = "Time") %>% 
  dplyr::select(-Data, -RSI, -Regime.Number,
                `Regime mean` = Regime.Mean) %>% 
  dplyr::select(which(sapply(.,var)!=0))

spring_min <- min(spring_bottom_temp$Time)

fall_bottom_temp <- 
  stars_to_series(r = "bot_temp_fall_spdf.rdata",
               stock_name = stock_name,
               common_name = common_name,
               stock_season = stock_season,
               data_season = "fall",
                measure_name = "bottom_temp") %>% 
  dplyr::filter(Time >= 1968) %>% 
  mutate(season = "fall") %>% 
  dplyr::distinct() %>% 
  ecotrend::glsMs(Mean ~ Time,
                data = .,
                diagnostic = T,
                fit_model  = T) 



STARS_in <- fall_bottom_temp$fit %>% 
  dplyr::select(-fit) %>% 
  as.matrix()

if (fall_bottom_temp$`selection summary`$pval[1] < 0.05){

  fall_mod <- fall_bottom_temp$model
  
  fall_bottom_temp <- fall_bottom_temp$fit %>% 
      dplyr::select(Time = time, 
                Series = series,
                Trend = fit)
  
  summ_ <- gls_summary(mod = fall_mod)
  trend <- summ_$Value[1]
  lci <- summ_$Value[2]
  uci <- summ_$Value[3]
  
  fall_title <- sprintf("Fall\nTrend:%s (%s, %s)", trend, lci, uci)
} else {
    fall_bottom_temp <- fall_bottom_temp$fit %>% 
      dplyr::select(Time = time, 
                Series = series)
    fall_tile <- "Fall"
}


fall_bottom_temp %<>%
  left_join(.,STARS(mat.in = STARS_in),by = "Time") %>% 
  dplyr::select(-Data, -RSI, -Regime.Number,
                `Regime mean` = Regime.Mean) %>% 
  dplyr::select(which(sapply(.,var)!=0))

fall_min <- min(fall_bottom_temp$Time)

if (fall_min > spring_min) {
  plot_min <- spring_min
} else {
  plot_min <- fall_min
}
```


```{r bot_temp_spring_plt, fig.height=3}

spring_bottom_temp_plt <- 
  tab_plotly(spring_bottom_temp, series.name = "Temperature") %>% 
  layout(title = spring_title,
         # title = sprintf("Spring\nTrend:%s (%s, %s)", trend, lci, uci),
         yaxis = list(title = "Temperature (&deg;C)",
                      hoverformat = '.3f', mirrow = FALSE, showline = TRUE),
         xaxis = list(range = c(plot_min, max(spring_bottom_temp$Time)),
                      title = "", mirror = FALSE, showline = TRUE),
         showlegend = T, legend = list(orientation = 'h'))


spring_bottom_temp_plt
```

```{r bot_temp_fall_plt, fig.height=3}
fall_bottom_temp_plt <- 
  tab_plotly(fall_bottom_temp, series.name = "Temperature") %>% 
  layout(title = fall_title,
    #title = sprintf("Fall\nTrend:%s (%s, %s)", trend, lci, uci),
         yaxis = list(title = "Temperature (&deg;C)",
                      hoverformat = '.3f',
                      mirror = FALSE,
                      showline = TRUE),
         xaxis = list(range = c(plot_min, max(fall_bottom_temp$Time)),
                      title = "", mirror = FALSE, showline = TRUE,
                      mirror = FALSE,
                      showline = TRUE),
         showlegend = T, legend = list(orientation = 'h'))


fall_bottom_temp_plt
```



## Surface Temperature {-#surface-temperature}

There does not appear to be any trend associated with spring surface temperature conditions, however, fall temperature have increased over time. Furthermore, the change point in fall conditions in 2011 may be related to the cumulative warming that marked the extreme warming in 2012. 

```{r surf_temp_process}
spring_surface_temp <- 
  stars_to_series(r = "surf_temp_spring_spdf.rdata",
                stock_name = stock_name,
                common_name = common_name,
                stock_season = stock_season,
                data_season = "spring",
                measure_name = "surface_temp") %>% 
  dplyr::filter(Time >= 1968) %>% 
  mutate(season = "Spring") %>% 
  ecotrend::glsMs(Mean ~ Time,
                data = .,
                diagnostic = T,
                fit_model  = T) 


STARS_in <- spring_surface_temp$fit %>% 
  dplyr::select(-fit) %>% 
  as.matrix()

if (spring_surface_temp$`selection summary`$pval[1] < 0.05){
  spring_mod <- spring_surface_temp$model

  spring_surface_temp <- spring_surface_temp$fit %>% 
      dplyr::select(Time = time, 
                Series = series,
                Trend = fit)
  
  summ_ <- gls_summary(mod = spring_mod)
  trend <- summ_$Value[1]
  lci <- summ_$Value[2]
  uci <- summ_$Value[3]

  spring_title <- sprintf("Spring\nTrend:%s (%s, %s)", trend, lci, uci)
  
} else {
    spring_surface_temp <- spring_surface_temp$fit %>% 
      dplyr::select(Time = time, 
                Series = series)
    spring_title <- "Spring"
}

spring_surface_temp %<>%  
  left_join(.,STARS(mat.in = STARS_in),by = "Time") %>% 
  dplyr::select(-Data, -RSI, -Regime.Number,
                `Regime mean` = Regime.Mean) %>% 
  dplyr::select(which(sapply(.,var)!=0))

spring_min <- min(spring_surface_temp$Time)

fall_surface_temp <- 
  stars_to_series(r = "surf_temp_fall_spdf.rdata",
                stock_name = stock_name,
                common_name = common_name,
                stock_season = stock_season,
                data_season = "fall",
                measure_name = "surface_temp") %>% 
  dplyr::filter(Time >= 1968) %>% 
  mutate(season = "fall") %>% 
  dplyr::distinct() %>% 
  ecotrend::glsMs(Mean ~ Time,
                data = .,
                diagnostic = T,
                fit_model  = T) 



STARS_in <- fall_surface_temp$fit %>% 
  dplyr::select(-fit) %>% 
  as.matrix()

if (fall_surface_temp$`selection summary`$pval[1] < 0.05){
  fall_mod <- fall_surface_temp$model
  
  fall_surface_temp <- fall_surface_temp$fit %>% 
      dplyr::select(Time = time, 
                Series = series,
                Trend = fit)
  
  summ_ <- gls_summary(mod = fall_mod)
  trend <- summ_$Value[1]
  lci <- summ_$Value[2]
  uci <- summ_$Value[3]
  
  fall_title <- sprintf("Fall\nTrend:%s (%s, %s)", trend, lci, uci)
} else {
    fall_surface_temp <- fall_surface_temp$fit %>% 
      dplyr::select(Time = time, 
                Series = series)
    fall_title <- "Fall"
}


fall_surface_temp %<>%
  left_join(.,STARS(mat.in = STARS_in),by = "Time") %>% 
  dplyr::select(-Data, -RSI, -Regime.Number,
                `Regime mean` = Regime.Mean) %>% 
  dplyr::select(which(sapply(.,var)!=0))

fall_min <- min(fall_surface_temp$Time)

if (fall_min > spring_min) {
  plot_min <- spring_min
} else {
  plot_min <- fall_min
}
```

```{r surf_temp_spring_plt, fig.height=3}

spring_surface_temp_plt <- 
  tab_plotly(spring_surface_temp, series.name = "Temperature") %>% 
  layout(title = spring_title,
         #title = sprintf("Spring\nTrend:%s (%s, %s)", trend, lci, uci),
         yaxis = list(title = "Temperature (&deg;C)",
                      hoverformat = '.3f', mirrow = FALSE, showline = TRUE),
         xaxis = list(range = c(plot_min, max(spring_surface_temp$Time)),
                      title = "", mirror = FALSE, showline = TRUE),
         showlegend = T, legend = list(orientation = 'h'))



# print(paste0("Trend: ", trend, " Up95%CI: ", uci, " Low95%CI: ",lci))

spring_surface_temp_plt
```

```{r surf_temp_fall_plt, fig.height=3}


fall_surface_temp_plt <- 
  tab_plotly(fall_surface_temp, series.name = "Temperature") %>% 
  layout(title = fall_title,
    #title = sprintf("Fall\nTrend:%s (%s, %s)", trend, lci, uci),
         yaxis = list(title = "Temperature (&deg;C)",
                      hoverformat = '.3f', mirrow = FALSE, showline = TRUE),
         xaxis = list(range = c(plot_min, max(fall_surface_temp$Time)),
                      title = "", mirror = FALSE, showline = TRUE),
         showlegend = T, legend = list(orientation = 'h'))




# print(paste0("Trend: ", trend, " Up95%CI: ", uci, " Low95%CI: ",lci))

fall_surface_temp_plt
```


# Salinity

An optimal interpolation procedure was used to estimate NE Shelf surface and bottom salinity for two seasonal time frames (see [methods](#methods)). Though collected with temperature data, reliable instrumentation limits this time series to 1992-2018. The salinity estimates were standardized to April 3 and October 11 for spring and fall. Surface and bottom salinities within the Atlantic menhaden stock areas are shown below.

## Bottom Salinity {-#bottom-salinity}

There is a long-term trend in spring bottom salinity in the stock area and the suggestion of an abrupt change in salinity around the year 2000. This change point would correspond to other changes in the ecosystem around that time [@morse2017]. The fall bottom salinity does not appear to have a long-term trend, however, there are two change points present in the time series. The first around 1999 and a second change around the year 2012, which may be related to the changes in thermal conditions associated with the temperature conditions in 2012 [@mills2013].


```{r bot_sal_process}
spring_bottom_sal <- 
  stars_to_series(r = "bot_sal_spring_spdf.rdata",
                stock_name = stock_name, 
                common_name = common_name, 
                stock_season = stock_season,
                data_season = "spring",
                measure_name = "bottom_sal") %>% 
  mutate(season = "Spring") %>% 
  ecotrend::glsMs(Mean ~ Time,
                data = .,
                diagnostic = T,
                fit_model  = T)

STARS_in <- spring_bottom_sal$fit %>% 
  dplyr::select(-fit) %>% 
  as.matrix()

if (spring_bottom_sal$`selection summary`$pval[1] < 0.05){
  spring_mod <- spring_bottom_sal$model

  spring_bottom_sal <- spring_bottom_sal$fit %>% 
      dplyr::select(Time = time, 
                Series = series,
                Trend = fit)
  
  summ_ <- gls_summary(mod = spring_mod)
  trend <- summ_$Value[1]
  lci <- summ_$Value[2]
  uci <- summ_$Value[3]
  
  spring_title <- sprintf("Spring\nTrend:%s (%s, %s)", trend, lci, uci)
  
} else {
    spring_bottom_sal <- spring_bottom_sal$fit %>% 
      dplyr::select(Time = time, 
                Series = series)
    
  spring_title <- "Spring"
}

spring_bottom_sal %<>%
  left_join(.,STARS(mat.in = STARS_in),by = "Time") %>% 
  dplyr::select(-Data, -RSI, -Regime.Number,
                `Regime mean` = Regime.Mean) %>% 
  dplyr::select(which(sapply(.,var)!=0))

spring_min <- min(spring_bottom_sal$Time)

fall_bottom_sal <- 
  stars_to_series(r = "bot_sal_fall_spdf.rdata",
               stock_name = stock_name, 
               common_name = common_name, 
               stock_season = stock_season,
               data_season = "fall",
                measure_name = "bottom_sal") %>% 
  mutate(season = "fall") %>% 
  dplyr::distinct() %>% 
  ecotrend::glsMs(Mean ~ Time,
                data = .,
                diagnostic = T,
                fit_model  = T) 



STARS_in <- fall_bottom_sal$fit %>% 
  dplyr::select(-fit) %>% 
  as.matrix()

if (fall_bottom_sal$`selection summary`$pval[1] < 0.05){
fall_mod <- fall_bottom_sal$model

  fall_bottom_sal <- fall_bottom_sal$fit %>% 
      dplyr::select(Time = time, 
                Series = series,
                Trend = fit)
  
  summ_ <- gls_summary(mod = fall_mod)
  trend <- summ_$Value[1]
  lci <- summ_$Value[2]
  uci <- summ_$Value[3]
  
  fall_title <- sprintf("Fall\nTrend:%s (%s, %s)", trend, lci, uci)
  
} else {
    fall_bottom_sal <- fall_bottom_sal$fit %>% 
      dplyr::select(Time = time, 
                Series = series)
  
    fall_title <- "Fall"
  
}

fall_bottom_sal %<>%
  left_join(.,STARS(mat.in = STARS_in),by = "Time") %>% 
  dplyr::select(-Data, -RSI, -Regime.Number,
                `Regime mean` = Regime.Mean) %>% 
  dplyr::select(which(sapply(.,var)!=0))

fall_min <- min(fall_bottom_sal$Time)

if (fall_min > spring_min) {
  plot_min <- spring_min
} else {
  plot_min <- fall_min
}
```


```{r bot_sal_spring_plt, fig.height=3}


spring_bottom_sal_plt <- 
  tab_plotly(spring_bottom_sal, series.name = "Salinity") %>% 
  layout(#title = "Spring",
    title = spring_title,
         yaxis = list(title = "Salinity (PSU)",
                      hoverformat = '.3f', mirrow = FALSE, showline = TRUE),
         xaxis = list(range = c(plot_min, max(spring_bottom_sal$Time)),
                      title = "", mirror = FALSE, showline = TRUE),
         showlegend = T, legend = list(orientation = 'h'))

spring_bottom_sal_plt
```

```{r bot_sal_fall_plt, fig.height=3}

fall_bottom_sal_plt <- 
  tab_plotly(fall_bottom_sal, series.name = "Salinity") %>% 
  layout(title = "Fall",
    #title = sprintf("Fall\nTrend:%s (%s, %s)", trend, lci, uci),
         yaxis = list(title = "Salinity (PSU)",
                      hoverformat = '.3f', mirrow = FALSE, showline = TRUE),
         xaxis = list(range = c(plot_min, max(fall_bottom_sal$Time)),
                      title = "", mirror = FALSE, showline = TRUE),
         showlegend = T, legend = list(orientation = 'h'))

fall_bottom_sal_plt
```



## Surface Salinity {-#surface-salinity}

The spring surface salinity, like the bottom conditions, also show a long-term increasing trend and a change point in 2013. The fall surface salinity time series was without trend or any change points. These changes in salinity conditions are likely indicators of changes in source water on the shelf and may have ramifications for patterns of primary production.

```{r surf_sal_process}
spring_surface_sal <- 
  stars_to_series(r = "surf_sal_spring_spdf.rdata",
                stock_name = stock_name, 
                common_name = common_name, 
                stock_season = stock_season,
                data_season = "spring",
                measure_name = "surface_sal") %>% 
  mutate(season = "Spring") %>% 
  ecotrend::glsMs(Mean ~ Time,
                data = .,
                diagnostic = T,
                fit_model  = T) 

STARS_in <- spring_surface_sal$fit %>% 
  dplyr::select(-fit) %>% 
  as.matrix()

if (spring_surface_sal$`selection summary`$pval[1] < 0.05){
  spring_mod <- spring_surface_sal$model
  
  
  spring_surface_sal <- spring_surface_sal$fit %>% 
      dplyr::select(Time = time, 
                Series = series,
                Trend = fit)
  


  summ_ <- gls_summary(mod = spring_mod)
  trend <- summ_$Value[1]
  lci <- summ_$Value[2]
  uci <- summ_$Value[3]
  
  spring_title <- sprintf("Spring\nTrend:%s (%s, %s)", trend, lci, uci)
} else {
    spring_surface_sal <- spring_surface_sal$fit %>% 
      dplyr::select(Time = time, 
                Series = series)
      spring_title <- "Spring"

}

spring_surface_sal %<>%
  left_join(.,STARS(mat.in = STARS_in),by = "Time") %>% 
  dplyr::select(-Data, -RSI, -Regime.Number,
                `Regime mean` = Regime.Mean) %>% 
  dplyr::select(which(sapply(.,var)!=0))

spring_min <- min(spring_surface_sal$Time)

fall_surface_sal <- 
  stars_to_series(r = "surf_sal_fall_spdf.rdata",
                stock_name = stock_name, 
                common_name = common_name, 
                stock_season = stock_season,
                data_season = "fall",
                measure_name = "surface_sal") %>% 
  mutate(season = "fall") %>% 
  dplyr::distinct() %>% 
  ecotrend::glsMs(Mean ~ Time,
                data = .,
                diagnostic = T,
                fit_model  = T) 

STARS_in <- fall_surface_sal$fit %>% 
  dplyr::select(-fit) %>% 
  as.matrix()

if (fall_surface_sal$`selection summary`$pval[1] < 0.05){
  fall_mod <- fall_surface_sal$model
  
  fall_surface_sal <- fall_surface_sal$fit %>% 
      dplyr::select(Time = time, 
                Series = series,
                Trend = fit)
  
  
  summ_ <- gls_summary(mod = fall_mod)
  trend <- summ_$Value[1]
  lci <- summ_$Value[2]
  uci <- summ_$Value[3]
  
  fall_title <- sprintf("Fall\nTrend:%s (%s, %s)", trend, lci, uci)
} else {
    fall_surface_sal <- fall_surface_sal$fit %>% 
      dplyr::select(Time = time, 
                Series = series)
    fall_title <- "Fall"
}

fall_surface_sal %<>%
  left_join(.,STARS(mat.in = STARS_in),by = "Time") %>% 
  dplyr::select(-Data, -RSI, -Regime.Number,
                `Regime mean` = Regime.Mean) %>% 
  dplyr::select(which(sapply(.,var)!=0))

fall_min <- min(fall_surface_sal$Time)

if (fall_min > spring_min) {
  plot_min <- spring_min
} else {
  plot_min <- fall_min
}
```

```{r surf_sal_spring_plt, fig.height=3}
spring_surface_sal_plt <- 
  tab_plotly(spring_surface_sal, series.name = "Salinity") %>% 
  layout(title = spring_title,
         #title = sprintf("Spring\nTrend:%s (%s, %s)", trend, lci, uci),
         yaxis = list(title = "Salinity (PSU)",
                      hoverformat = '.3f', mirrow = FALSE, showline = TRUE),
         xaxis = list(range = c(plot_min, max(spring_surface_sal$Time)),
                      title = "", mirror = FALSE, showline = TRUE),
         showlegend = T, legend = list(orientation = 'h'))

spring_surface_sal_plt
```

```{r surf_sal_fall_plt, fig.height=3}
fall_surface_sal_plt <- 
  tab_plotly(fall_surface_sal, series.name = "Salinity") %>% 
  layout(title = fall_title,
    #title = sprintf("Fall\nTrend:%s (%s, %s)", trend, lci, uci),
         yaxis = list(title = "Salinity (PSU)",
                      hoverformat = '.3f', mirrow = FALSE, showline = TRUE),
         xaxis = list(range = c(plot_min, max(fall_surface_sal$Time)),
                      title = "", mirror = FALSE, showline = TRUE),
         showlegend = T, legend = list(orientation = 'h'))

fall_surface_sal_plt
```



# Chlorophyll

## Stock area {-#stock-area}

The concentration of chlorophyll is an indicator of lower trophic level productivity and may be of particular importance to menhaden considering both juvenile and adults directly utilize phytoplankton as a food resource. Chlorophyll concentration was extracted for the spring and fall stock areas using a merged sensor data set. The data set included measurements made with the Sea-viewing Wide Field of View Sensor (SeaWiFS), Moderate Resolution Imaging Spectroradiometer on the Aqua satellite (MODIS), Medium Resolution Imaging Spectrometer (MERIS), and Visible and Infrared Imaging/Radiometer Suite (VIIRS) sensors during the period 1997-2016. The data were a merged product using the Garver, Siegel, Maritorena Model (GSM) algorithm @maritorena2010 obtained from the Hermes GlobColour [website](hermes.acri.fr/index.php). There is no apparent trend in spring chlorophyll concentration; however, there is a significant trend in fall chlorophyll associated with a regime change in levels in 2013. In recent years, fall chlorophyll has been at the lowest levels in this time series.


```{r chl_processing}
spring_chl <- 
stars_to_series(r = "chlorophyll_conc.rdata",
              stock_name = stock_name, 
              common_name = common_name, 
              stock_season = stock_season,
              data_season = "spring",
                measure_name = "biomass",
                process_to_season = "spring")$spring %>% 
  mutate(season = "Spring") %>% 
    dplyr::distinct() %>% 
  ecotrend::glsMs(Mean ~ Time,
                data = .,
                diagnostic = T,
                fit_model  = T)

STARS_in <- spring_chl$fit %>% 
  dplyr::select(-fit) %>% 
  as.matrix()

if (spring_chl$`selection summary`$pval[1] < 0.05){
  spring_chl <- spring_chl$fit %>% 
      dplyr::select(Time = time, 
                Series = series,
                Trend = fit)
  
  summ_ <- gls_summary(mod = spring_mod)
  trend <- summ_$Value[1]
  lci <- summ_$Value[2]
  uci <- summ_$Value[3]

  spring_title <- sprintf("Spring\nTrend:%s (%s, %s)", trend, lci, uci)
} else {
    spring_chl <- spring_chl$fit %>% 
      dplyr::select(Time = time, 
                Series = series)
}

spring_chl %<>%
  left_join(.,STARS(mat.in = STARS_in),by = "Time") %>% 
  dplyr::select(-Data, -RSI, -Regime.Number,
                `Regime mean` = Regime.Mean) %>% 
  dplyr::select(which(sapply(.,var)!=0))

spring_min <- min(spring_chl$Time)

fall_chl <- 
stars_to_series(r = "chlorophyll_conc.rdata",
                stock_name = stock_name, 
                common_name = common_name, 
                stock_season = stock_season,
                data_season = "fall",
                measure_name = "biomass",
                process_to_season = "fall")$fall %>% 
  mutate(season = "fall") %>% 
    dplyr::distinct() %>% 
  ecotrend::glsMs(Mean ~ Time,
                data = .,
                diagnostic = T,
                fit_model  = T)

STARS_in <- fall_chl$fit %>% 
  dplyr::select(-fit) %>% 
  as.matrix()

if (fall_chl$`selection summary`$pval[1] < 0.05){
  fall_chl <- fall_chl$fit %>% 
      dplyr::select(Time = time, 
                Series = series,
                Trend = fit)
} else {
    fall_chl <- fall_chl$fit %>% 
      dplyr::select(Time = time, 
                Series = series)
}

fall_chl %<>%
  left_join(.,STARS(mat.in = STARS_in),by = "Time") %>% 
  dplyr::select(-Data, -RSI, -Regime.Number,
                `Regime mean` = Regime.Mean) %>% 
  dplyr::select(which(sapply(.,var)!=0))

fall_min <- min(fall_chl$Time)



if (fall_min > spring_min) {
  plot_min <- spring_min
} else {
  plot_min <- fall_min
}
```

```{r spring_chl_plt, fig.height=3}
spring_chl_plt <- 
  tab_plotly(spring_chl, series.name = "CHL") %>% 
  layout(title = sprintf("Spring\nTrend:%s (%s, %s)", trend, lci, uci),
         yaxis = list(title = "Chlorophyll (mg m<sup>-3</sup>)",
                      hoverformat = '.3f', mirrow = FALSE, showline = TRUE),
         xaxis = list(range = c(plot_min, max(spring_chl$Time)),
                      title = "", mirror = FALSE, showline = TRUE),
         showlegend = T, legend = list(orientation = 'h'))
spring_chl_plt 
```

```{r fall_chl_plt, fig.height=3}
fall_chl_plt <- 
  tab_plotly(fall_chl, series.name = "CHL") %>% 
  layout(title = sprintf("Fall\nTrend:%s (%s, %s)", trend, lci, uci),
         yaxis = list(title = "Chlorophyll (mg m<sup>-3</sup>)",
                      hoverformat = '.3f', mirrow = FALSE, showline = TRUE),
         xaxis = list(range = c(plot_min, max(fall_chl$Time)),
                      title = "", mirror = FALSE, showline = TRUE),
         showlegend = T, legend = list(orientation = 'h'))

fall_chl_plt
```

## Chesapeake Bay recruitment index {-#chesapeake-bay-recruitment-index}

Recruitment is a complex process in marine fishes and in the case of menhaden, it has been long recognized that recruitment variability is related to the life history of larval menhaden on the continental shelf, the successful egress into estuarine nursery areas, and the growth and survival of post-metamorphic juveniles in nursery habitats. Particular attention was focused on the later source of variably in @houde2016, which suggested the development of spring bloom conditions may factor into the success of a year class. This study utilized local sources of data to describe the dependency of year class strength on primary production and phytoplankton biomass

A proxy index for this relationship is developed here based on satellite remote sensing data. Time series of chlorophyll concentration for the oligohaline, mesohaline, and polyhaline segments of the bay were extracted from the merged dataset described above.

```{r ches_bay_rec}
ches_bay_rec_plt <- ches_bay_rec %>%
        dplyr::select(Time = Year, Series = CHL) %>% 
        tab_plotly(., series.name = "CHL") %>% 
        layout(title = "Chesapeake Bay CHL",
         yaxis = list(title = "Chlorophyll (mg m<sup>-3</sup>)",
                      hoverformat = '.3f', mirrow = FALSE, showline = TRUE),
         showlegend = T, legend = list(orientation = 'h'))

ches_bay_rec_plt
```


Based on the most recent menhaden assessment, the chlorophyll time series overlaps the recruitments series for the years 1998-2016, noting that the two largest year classes during that period appear to have occurred in 2005 and 2010 (based on age-0 numbers). The correlation between April polyhaline chlorophyll concentration and recruitment was 0.43 (P = .066). The polyhaline chlorophyll time series was at its highest value in 2005 and among its highest values in 2010; the 2011 chlorophyll concentration was also among the highest values, but it not associated with a strong recruitment. Time series from other portions the estuary were not correlated with the recruitment signal. Finally, it is worth noting that the 2019 chlorophyll concentration was the third highest in the time series. If the remote sensing series is capturing a part of the recruitment signal, 2019 may be a large year class and the index may provide some forecast skill for recruitment events.

# Zooplankton

Menhaden consume zooplankton during all their life history stages, but have a dependency on zooplankton as larval fish and a preference for zooplankton as adults [@friedland2011]. @june1971 characterize larval menhaden feeding in context to metamorphosis, partitioning their sampling between marine and estuarine waters. In marine water, the diet consisted predominantly of copepods and mainly the genera *Centropages* and *Acartia*. In estuarine waters, the copepod genera *Acartia* and *Temora* played larger roles along with other zooplankton species. These samples were collected over two years. @lozano2011 analyzed the feeding of larval menhaden over three seasons and found they utilized copepods, cladocerans, barnacle nauplii, bivalve larvae, ostracods, decapods, polychaetes, tunicate larvae, metatrochophores, and digested material. 

The most commonly encountered copepod genera were *Centropages*, *Acartia*, *Temora*, *Caligus*, and *Labidocera*. Though identifications were not made to species, it is likely *Centropages typicus*, *Acartia tonsa*, and *Temora longicornis* were the most important prey species. Numerically, the most important prey were copepods, which accounted for approximately 46-70% of the prey, followed by barnacle nauplii and cladocerans, which ranged from 10-30% of the diet. After the metamorphosis from larval particle feeding to filter feeding, the nature of their gill raker feeding apparatus would suggest they would feed on any size zooplankton and not be limited by any minimum size like some herring species [@friedland2006]. So generally, whatever taxa are abundant would likely be a useful prey resource for both larval or adult fish.

## Copepod abundance {-#copepod-abundance}


```{r zoo_cope_spring, fig.height=5}
spring_zoo_1yr_cope <- stars_to_series(r <- "zoo_spring_rasters_1yr.rdata",
                stock_name = stock_name, 
                common_name = common_name, 
                stock_season = stock_season,
                data_season = "spring",
                measure_name = "zoo",
                group_regex = "[^A-Z_](.*)(?=_)") %>% 
  mutate(season = "spring") %>% 
  left_join(.,zoo_lookup, by = "Grouping") %>% 
  dplyr::filter(copepod == "y") %>% 
  dplyr::select(-Grouping, -season, -copepod) %>%
  tidyr::spread(full_name, Mean)


spring_zoo_5yr_cope <- stars_to_series(r <- "zoo_spring_rasters_5yr.rdata",
                stock_name = stock_name, 
                common_name = common_name, 
                stock_season = stock_season,
                data_season = "spring",
                measure_name = "zoo",
                group_regex = "[^A-Z_](.*)(?=_)") %>% 
  mutate(season = "spring") %>% 
  left_join(.,zoo_lookup, by = "Grouping") %>% 
  dplyr::filter(copepod == "y") %>% 
  dplyr::select(-Grouping, -season, -copepod) %>%
  dplyr::mutate(full_name = paste0(full_name, " smooth")) %>% 
  tidyr::spread(full_name, Mean)

spring_cope <- left_join(spring_zoo_1yr_cope,
                         spring_zoo_5yr_cope,
                         by = "Time")

#I'm sorry I wrote this....
buttons <- create_buttons(spring_cope)
buttons[[1]]$args[[1]]$visible <- c(F,T,T,rep(F,30))
buttons[[2]]$args[[1]]$visible <- c(F,rep(F,2),T,T,rep(F,28))
buttons[[3]]$args[[1]]$visible <- c(F,rep(F,4),T,T,rep(F,26))
buttons[[4]]$args[[1]]$visible <- c(F,rep(F,6),T,T,rep(F,24))
buttons[[5]]$args[[1]]$visible <- c(F,rep(F,8),T,T,rep(F,22))
buttons[[6]]$args[[1]]$visible <- c(F,rep(F,10),T,T,rep(F,20))
buttons[[7]]$args[[1]]$visible <- c(F,rep(F,12),T,T,rep(F,18))
buttons[[8]]$args[[1]]$visible <- c(F,rep(F,14),T,T,rep(F,16))

spring_cope_plt <-
  tab_plotly(spring_cope, add_smoother = T, showlegend = F) %>% 
  layout(title = "Spring copepod abundance",
         yaxis = list(title = "Abundance (log num m<sup>-3</sup>)",
                      hoverformat = '.3f', mirrow = FALSE, showline = TRUE),
         updatemenus = 
        
        list(
           list(
            buttons = list(buttons[[1]],buttons[[2]],buttons[[3]]),
                      type = "buttons",
                      direction = "right",
                      xanchor = "center",
                      yanchor = "top",
                      pad = list("r"= 0, "t"= 10, "b" = 10),
                      x = 0.5,
                      y = -0.2
                      ),
          list(
           buttons = list(buttons[[4]],buttons[[5]],buttons[[6]]),
                      type = "buttons",
                      direction = "right",
                      xanchor = "center",
                      yanchor = "top",
                      pad = list("r"= 0, "t"= 10, "b" = 10),
                      x = 0.5,
                      y = -0.3
                      ),
          list(
           buttons = list(buttons[[7]],buttons[[8]]),
                      type = "buttons",
                      direction = "right",
                      xanchor = "center",
                      yanchor = "top",
                      pad = list("r"= 0, "t"= 10, "b" = 10),
                      x = 0.5,
                      y = -0.4
                      )
                     )
                    )

spring_cope_plt
```


```{r zoo_cope_fall, fig.height=5}
fall_zoo_1yr_cope <- stars_to_series(r <- "zoo_fall_rasters_1yr.rdata",
                stock_name = stock_name, 
                common_name = common_name, 
                stock_season = stock_season,
                data_season = "fall",
                measure_name = "zoo",
                group_regex = "[^A-Z_](.*)(?=_)") %>% 
  mutate(season = "fall") %>% 
  left_join(.,zoo_lookup, by = "Grouping") %>% 
  dplyr::filter(copepod == "y") %>% 
  dplyr::select(-Grouping, -season, -copepod) %>%
  tidyr::spread(full_name, Mean)


fall_zoo_5yr_cope <- stars_to_series(r <- "zoo_fall_rasters_5yr.rdata",
                stock_name = stock_name, 
                common_name = common_name, 
                stock_season = stock_season,
                data_season = "fall",
                measure_name = "zoo",
                group_regex = "[^A-Z_](.*)(?=_)") %>% 
  mutate(season = "fall") %>% 
  left_join(.,zoo_lookup, by = "Grouping") %>% 
  dplyr::filter(copepod == "y") %>% 
  dplyr::select(-Grouping, -season, -copepod) %>%
  dplyr::mutate(full_name = paste0(full_name, " smooth")) %>% 
  tidyr::spread(full_name, Mean)

fall_cope <- left_join(fall_zoo_1yr_cope,
                         fall_zoo_5yr_cope,
                         by = "Time")

#I'm sorry I wrote this....
buttons <- create_buttons(fall_cope)
buttons[[1]]$args[[1]]$visible <- c(F,T,T,rep(F,30))
buttons[[2]]$args[[1]]$visible <- c(F,rep(F,2),T,T,rep(F,28))
buttons[[3]]$args[[1]]$visible <- c(F,rep(F,4),T,T,rep(F,26))
buttons[[4]]$args[[1]]$visible <- c(F,rep(F,6),T,T,rep(F,24))
buttons[[5]]$args[[1]]$visible <- c(F,rep(F,8),T,T,rep(F,22))
buttons[[6]]$args[[1]]$visible <- c(F,rep(F,10),T,T,rep(F,20))
buttons[[7]]$args[[1]]$visible <- c(F,rep(F,12),T,T,rep(F,18))
buttons[[8]]$args[[1]]$visible <- c(F,rep(F,14),T,T,rep(F,16))

fall_cope_plt <-
  tab_plotly(fall_cope, add_smoother = T, showlegend = F) %>% 
  layout(title = "Fall copepod abundance",
         yaxis = list(title = "Abundance (log num m<sup>-3</sup>)",
                      hoverformat = '.3f', mirrow = FALSE, showline = TRUE),
         updatemenus = 
        
        list(
           list(
            buttons = list(buttons[[1]],buttons[[2]],buttons[[3]]),
                      type = "buttons",
                      direction = "right",
                      xanchor = "center",
                      yanchor = "top",
                      pad = list("r"= 0, "t"= 10, "b" = 10),
                      x = 0.5,
                      y = -0.2
                      ),
          list(
           buttons = list(buttons[[4]],buttons[[5]],buttons[[6]]),
                      type = "buttons",
                      direction = "right",
                      xanchor = "center",
                      yanchor = "top",
                      pad = list("r"= 0, "t"= 10, "b" = 10),
                      x = 0.5,
                      y = -0.3
                      ),
          list(
           buttons = list(buttons[[7]],buttons[[8]]),
                      type = "buttons",
                      direction = "right",
                      xanchor = "center",
                      yanchor = "top",
                      pad = list("r"= 0, "t"= 10, "b" = 10),
                      x = 0.5,
                      y = -0.4
                      )
                     )
                    )

fall_cope_plt
```

## Non-copepod zooplankton abundance {-#non-copepod-zooplankton-abundance}

```{r zoo_spring_noncope, fig.height=5}
spring_zoo_1yr_noncope <- stars_to_series(r <- "zoo_spring_rasters_1yr.rdata",
                stock_name = stock_name, 
                common_name = common_name, 
                stock_season = stock_season,
                data_season = "spring",
                measure_name = "zoo",
                group_regex = "[^A-Z_](.*)(?=_)") %>% 
  mutate(season = "spring") %>% 
  left_join(.,zoo_lookup, by = "Grouping") %>% 
  dplyr::filter(copepod == "n") %>% 
  dplyr::select(-Grouping, -season, -copepod) %>%
  tidyr::spread(full_name, Mean)

spring_zoo_5yr_noncope <- stars_to_series(r <- "zoo_spring_rasters_5yr.rdata",
                stock_name = stock_name, 
                common_name = common_name, 
                stock_season = stock_season,
                data_season = "spring",
                measure_name = "zoo",
                group_regex = "[^A-Z_](.*)(?=_)") %>% 
  mutate(season = "spring") %>% 
  left_join(.,zoo_lookup, by = "Grouping") %>% 
  dplyr::filter(copepod == "n") %>% 
  dplyr::select(-Grouping, -season, -copepod) %>%  
  dplyr::mutate(full_name = paste0(full_name, " smooth")) %>% 
  tidyr::spread(full_name, Mean)

spring_noncope <- left_join(spring_zoo_1yr_noncope, spring_zoo_5yr_noncope, by = "Time")

buttons <- create_buttons(spring_noncope)
buttons[[1]]$args[[1]]$visible <- c(F,T,T,rep(F,36))
buttons[[2]]$args[[1]]$visible <- c(F,rep(F,2),T,T,rep(F,32))
buttons[[3]]$args[[1]]$visible <- c(F,rep(F,4),T,T,rep(F,29))
buttons[[4]]$args[[1]]$visible <- c(F,rep(F,6),T,T,rep(F,27))
buttons[[5]]$args[[1]]$visible <- c(F,rep(F,8),T,T,rep(F,25))
buttons[[6]]$args[[1]]$visible <- c(F,rep(F,10),T,T,rep(F,23))
buttons[[7]]$args[[1]]$visible <- c(F,rep(F,12),T,T,rep(F,21))
buttons[[8]]$args[[1]]$visible <- c(F,rep(F,14),T,T,rep(F,19))
buttons[[9]]$args[[1]]$visible <- c(F,rep(F,16),T,T,rep(F,17))
buttons[[10]]$args[[1]]$visible <- c(F,rep(F,18),T,T,rep(F,15))

spring_noncope_plt <-
  tab_plotly(spring_noncope, add_smoother = T) %>% 
  layout(title = "Spring non-copepod zoo. abundance",
         yaxis = list(title = "Abundance (log num m<sup>-3</sup>)",
                      hoverformat = '.3f', mirrow = FALSE, showline = TRUE),
         showlegend = F,
         updatemenus = 
        
        list(
           list(
            buttons = list(buttons[[1]],buttons[[2]],buttons[[3]],buttons[[4]]),
                      type = "buttons",
                      direction = "right",
                      xanchor = "center",
                      yanchor = "top",
                      pad = list("r"= 0, "t"= 10, "b" = 10),
                      x = 0.5,
                      y = -0.2
                      ),
          list(
           buttons = list(buttons[[5]],buttons[[6]],buttons[[7]]),
                      type = "buttons",
                      direction = "right",
                      xanchor = "center",
                      yanchor = "top",
                      pad = list("r"= 0, "t"= 10, "b" = 10),
                      x = 0.5,
                      y = -0.3
                      ),
          list(
           buttons = list(buttons[[8]],buttons[[9]],buttons[[10]]),
                      type = "buttons",
                      direction = "right",
                      xanchor = "center",
                      yanchor = "top",
                      pad = list("r"= 0, "t"= 10, "b" = 10),
                      x = 0.5,
                      y = -0.4
                      )
                     )
                    )

spring_noncope_plt
```

```{r zoo_fall_noncope, fig.height=5}
fall_zoo_1yr_noncope <- stars_to_series(r <- "zoo_fall_rasters_1yr.rdata",
                stock_name = stock_name, 
                common_name = common_name, 
                stock_season = stock_season,
                data_season = "fall",
                measure_name = "zoo",
                group_regex = "[^A-Z_](.*)(?=_)") %>% 
  mutate(season = "fall") %>% 
  left_join(.,zoo_lookup, by = "Grouping") %>% 
  dplyr::filter(copepod == "n") %>% 
  dplyr::select(-Grouping, -season, -copepod) %>%
  tidyr::spread(full_name, Mean)

fall_zoo_5yr_noncope <- stars_to_series(r <- "zoo_fall_rasters_5yr.rdata",
                stock_name = stock_name, 
                common_name = common_name, 
                stock_season = stock_season,
                data_season = "fall",
                measure_name = "zoo",
                group_regex = "[^A-Z_](.*)(?=_)") %>% 
  mutate(season = "fall") %>% 
  left_join(.,zoo_lookup, by = "Grouping") %>% 
  dplyr::filter(copepod == "n") %>% 
  dplyr::select(-Grouping, -season, -copepod) %>%  
  dplyr::mutate(full_name = paste0(full_name, " smooth")) %>% 
  tidyr::spread(full_name, Mean)

fall_noncope <- left_join(fall_zoo_1yr_noncope, fall_zoo_5yr_noncope, by = "Time")

buttons <- create_buttons(fall_noncope)
buttons[[1]]$args[[1]]$visible <- c(F,T,T,rep(F,36))
buttons[[2]]$args[[1]]$visible <- c(F,rep(F,2),T,T,rep(F,32))
buttons[[3]]$args[[1]]$visible <- c(F,rep(F,4),T,T,rep(F,29))
buttons[[4]]$args[[1]]$visible <- c(F,rep(F,6),T,T,rep(F,27))
buttons[[5]]$args[[1]]$visible <- c(F,rep(F,8),T,T,rep(F,25))
buttons[[6]]$args[[1]]$visible <- c(F,rep(F,10),T,T,rep(F,23))
buttons[[7]]$args[[1]]$visible <- c(F,rep(F,12),T,T,rep(F,21))
buttons[[8]]$args[[1]]$visible <- c(F,rep(F,14),T,T,rep(F,19))
buttons[[9]]$args[[1]]$visible <- c(F,rep(F,16),T,T,rep(F,17))
buttons[[10]]$args[[1]]$visible <- c(F,rep(F,18),T,T,rep(F,15))

fall_noncope_plt <-
  tab_plotly(fall_noncope, add_smoother = T) %>% 
  layout(title = "Fall non-copepod zoo. abundance",
         yaxis = list(title = "Abundance (log num m<sup>-3</sup>)",
                      hoverformat = '.3f', mirrow = FALSE, showline = TRUE),
         showlegend = F,
         updatemenus = 
        
        list(
           list(
            buttons = list(buttons[[1]],buttons[[2]],buttons[[3]],buttons[[4]]),
                      type = "buttons",
                      direction = "right",
                      xanchor = "center",
                      yanchor = "top",
                      pad = list("r"= 0, "t"= 10, "b" = 10),
                      x = 0.5,
                      y = -0.2
                      ),
          list(
           buttons = list(buttons[[5]],buttons[[6]],buttons[[7]]),
                      type = "buttons",
                      direction = "right",
                      xanchor = "center",
                      yanchor = "top",
                      pad = list("r"= 0, "t"= 10, "b" = 10),
                      x = 0.5,
                      y = -0.3
                      ),
          list(
           buttons = list(buttons[[8]],buttons[[9]],buttons[[10]]),
                      type = "buttons",
                      direction = "right",
                      xanchor = "center",
                      yanchor = "top",
                      pad = list("r"= 0, "t"= 10, "b" = 10),
                      x = 0.5,
                      y = -0.4
                      )
                     )
                    )

fall_noncope_plt
```


# Habitat and abundance

## Occurrence probability {-#occurrence-probability}

The probability of occurrence was estimated using random forest classification models (see [methods](#methods)). The mean annual probabilities were extracted for the spring and fall stock definition areas. These data provide an estimate of the potential use of the habitat associated with the stock definition. The most dramatic change in occupancy probability occurred in the spring. In the beginning of the time series, occupancy probability was less than 0.08 and has increase to well over 0.1 in recent decades. This suggest greater utilization of the continental shelf by menhaden during the spring period. Fall occupancy has remained relatively constant of the time series range between 0.12-0.13. 

```{r occ_prob, fig.height=4}
spring_occ_prob <- 
  stars_to_series(r = "occurrence_prob_spring.rdata",
                stock_name = stock_name, 
                common_name = common_name, 
                stock_season = stock_season,
                data_season = "spring",
                measure_name = "occurrence") %>% 
  dplyr::select(Spring = Mean,
                Time)

fall_occ_prob <- 
  stars_to_series(r = "occurrence_prob_fall.rdata",
                stock_name = stock_name, 
                common_name = common_name, 
                stock_season = stock_season,
                data_season = "fall",
                measure_name = "occurrence") %>% 
  dplyr::select(Fall = Mean,
                Time)

occ_prob <- spring_occ_prob %>% 
  left_join(.,fall_occ_prob, by  = "Time") %>% 
  dplyr::select(Time, Spring, Fall)

occ_prob_plt <- occ_prob %>% 
  tab_plotly(.) %>% 
  layout(title = "Occupancy Probability", 
         yaxis = list(title = "Occupancy probability",
                      hoverformat = '.3f', mirrow = FALSE, showline = TRUE))

occ_prob_plt
```

## Habitat area {-#habitat-area}

The area of the Northeast Shelf with an estimated occurrence probability for menhaden of 0.25 was determined for the stock area and the ecosystem. The area of habitat with the stock area generally ranged from 2,000-4,000 km<sup>2</sup> with a notable peak in habitat associated with 2012 spring conditions. With the exception of 2012, spring habitat appear to have been represent by a larger area during the 1980s. Fall habitat has increase in recent years and was also at high levels in the early 1980s. The fall habitat area for menhaden over the ecosystem is larger than the areas restricted to the stock definition. Fall habitat approached 5,000 km<sup>2</sup> reflecting a greater use of the ecosystem during the warmer part of the year. The spring habitat over the ecosystem were similar to the stock area dimensions.

### Stock area  {-#stock-area}

```{r stock_hab_area, fig.height=4}
hab_area_sa <- hab_area %>% 
  dplyr::select(Time = Year, Spring = spr_sa, Fall = fall_sa ) %>% 
  tab_plotly(.) %>% 
  layout(title = "Stock habitat area", 
         yaxis = list(title = "Habitat area (km <sup>2</sup>)",
                      hoverformat = '.3f', mirrow = FALSE, showline = TRUE))
hab_area_sa
```

### Ecosystem {-#ecosystem}

```{r ecosys_hab_area, fig.height=4}
hab_area_eco <- hab_area %>% 
  dplyr::select(Time = Year, Spring = spr_eco, Fall = fal_eco) %>% 
  tab_plotly(.) %>% 
  layout(title = "Ecosystem habitat area", 
         yaxis = list(title = "Habitat area (km <sup>2</sup>)",
                      hoverformat = '.3f', mirrow = FALSE, showline = TRUE))
hab_area_eco
```

However, the habitat size in the fall has changed with distinct periods of high and low habitat area and there is the suggestion of an increasing trend in habitat over time. The fall stock area habitat peaked in 1983, was lowest in the late 1990sm and has been increasing since 2000. The habitat has increased in size by about is approximately 50,000 km <sup>2</sup> to 80,000 km <sup>2</sup>, noting a decrease in 2017. The fall habitat has increased approximately 15% within the stock area and approximately 20% over the ecosystem.

## Minimum Population Size {-#minimum-population-size}

Estimates of the numbers and biomass minimum population size of menhaden stocks was determined by re-stratifying the habitat each year depending on the distribution of occupancy habitat (see [methods](#methods) for details). The procedure provides eight populations size estimates for each stock, by season, based on the use of three estimation options. The estimates are denoted by a three-letter code (Y/N|Y/N|Y/N) where the first position indicates whether data were interpolated over habitat strata. The second position indicates whether the trawl data applied to the estimate was limited to the stations made in the stock area only or if trawls from other areas were used as well. The third position indicates whether the trawl data were subjected to a test for outliers, in which outliers were eliminated. 

Of the eight treatment options, the four that included outlier testing and elimination were found to produce many missing values; hence, the abundance and biomass estimates were based on the four other treatments (NNN, NYN, YNN, and YYN). The spring minimum population size in numbers suggests the stock continues the trend of high abundance that began with the 2005 recruitment. When disaggregated by northern and southern subareas, it appear the southern subunit approximates the unit abundance for most of the time series. 

In recent years, the southern subareas appears to have declined whereas the northern subarea is closer to the unit population size. Similar trends in the relative role of the subareas can be seen the minimum biomass estimates as well; the southern subarea approximates the unit early in the time series and in recent years the northern subarea estimate the unit. Collectively, both the abundance and biomass data suggest a shift in spring population distribution, with more of the population now distribution in the northern subareas. The time series trends in both abundance and biomass appear to be positive, however, the recent biomass peak level are higher than the peak biomass in the 1980. This is not the case when comparing the recent and 1980s peaks in abundance. The fall population estimates are dissimilar to the spring estimates in terms of both localized abundance and trends. The fall data suggest an abundance peak in the early 2000s that is not seen in the spring data. Furthermore, a peak in fall biomass does not accompany this peak in abundance. The fall data do not suggest any trend in abundance or biomass in the unit estimate or the in the subareas estimates either. The fall unit estimate is most closely approximate by the northern subarea estimate in all cases.


```{r sae_processing}


# Change parameters of moving average. `fill = "extend"` will do linear interpolation over gaps in moving average. Change length of window with the k parameter
fill = "extend"
k <- 2

spring_biomass_sae <- 
  plot_sae(data_season = "spring",
         exclude_treatments = treatments[stringr::str_detect(treatments, "Y$")],
         biomass_ = "yes",
         include_zeros = F,
         svspp_ = svspp_,
         k = k,
         fill = fill,
         legend_title = "")


spring_numbers_sae <- 
  plot_sae(data_season = "spring",
         exclude_treatments = treatments[stringr::str_detect(treatments, "Y$")],
         biomass_ = "no",
         include_zeros = F,
         svspp_ = svspp_,
         k = k,
         fill = fill,
         include_legend = F)

fall_biomass_sae <- 
  plot_sae(data_season = "fall",
         exclude_treatments = treatments[stringr::str_detect(treatments, "Y$")],
         biomass_ = "yes",
         include_zeros = F,
         svspp_ = svspp_,
         k = k,
         fill = fill,
         legend_title = "")


fall_numbers_sae <- 
  plot_sae(data_season = "fall",
         exclude_treatments = treatments[stringr::str_detect(treatments, "Y$")],
         biomass_ = "no",
         include_zeros = F,
         svspp_ = svspp_,
         k = k,
         fill = fill,
         include_legend = F)

```

### Spring numbers and biomass {-#spring-numbers-and-biomass}

```{r spring_sae_plt, fig.height = 6}
spring_sae_plt <- subplot(
          spring_biomass_sae,
          spring_numbers_sae,
          shareX = F, 
          nrows = 2,
          margin = 0.05,
          titleY = TRUE) %>% 
   add_annotations(text="Habitat\narea", xref="paper", yref="paper",
                  x=1.02, xanchor="left",
                  y=0.8, yanchor="bottom",  
                  legendtitle=TRUE, showarrow=FALSE ) %>%
  layout( legend=list(y=0.8, yanchor="top" ) )
spring_sae_plt
```

### Fall numbers and biomass {-#fall-numbers-and-biomass}

```{r fall_sae_plt, fig.height = 6}
fall_sae_plt <- subplot(
          fall_biomass_sae,
          fall_numbers_sae,
          shareX = F, 
          nrows = 2,
          margin = 0.05,
          titleY = TRUE) %>% 
   add_annotations(text="Habitat\narea", xref="paper", yref="paper",
                  x=1.02, xanchor="left",
                  y=0.8, yanchor="bottom",   
                  legendtitle=TRUE, showarrow=FALSE ) %>%
  layout( legend=list(y=0.8, yanchor="top" ) )
fall_sae_plt
```

The fall population estimates are dissimilar to the spring estimates in terms of both localized abundance and trends. The fall data suggest an abundance peak in the early 2000s that is not seen in the spring data. Furthermore, a peak in fall biomass does not accompany this peak in abundance. The fall data do not suggest any trend in abundance or biomass in the unit estimate or the in the subareas estimates either. The fall unit estimate is most closely approximate by the northern subarea estimate in all cases.



# Methods {#methods}

## Surface and Bottom Temperature and Salinity {#sec:methodstempsalin}

### Study System
The U.S. Northeast Shelf ecosystem, which roughly aligns with the boundaries of the Northeast U.S. Continental Shelf Large Marine Ecosystem (LME), is the study area for the surface and bottom thermal environments. Surface and bottom temperatures were estimated over a 0.1° latitude/longitude grid, termed the estimation grid, which circumscribes the range of ecosystem assessment areas in the [region](#fig:study-area). The difference between the extents of the estimation grid from the extent of the LME relate to the resource management programs that are the sources of the data, which are focused on fishery management needs in the region. 

### Data Source
Temperature and salinity were collected on the Northeast Shelf as part of ongoing resource and ecosystem surveys conducted by the Northeast Fisheries Science Center. Water column temperatures have been collected contemporaneously to trawl tows associated with a bottom trawl survey beginning in the fall of 1963 and five years later during spring [@Despres1988]. In addition, the ecosystem has been surveyed by multiple sampling programs with varying sampling designs. The two most comprehensive monitoring programs over the study period were the MARMAP (1977-1987) and the Ecosystem Monitoring Program or EcoMon (1992-present) programs, both serving as shelf-wide surveys of the ecosystem [@Sherman1998; @Kane2007]. Temperature measurements were made with a mix of Conductivity Temperature and Depth (CTD) instruments, analog XBT, digital XBT, mechanical BT, glass thermometers (bottle temps) and trawl mounted temperature loggers instruments collecting either water column profiles or temperatures  measured at targeted depths. Salinity measurements used in this analysis was limited to 1992-2017 when CTD instrument were used. Surface and bottom temperatures were identified from these measurements. Temperatures representing the spring period include data collected during the months of February to June; however, 99% of the samples were collected during the months of March to May. Likewise, the fall period samples include data collected during September to December, with 99% of the samples collected during September to November. The total number of surface temperature measurements were 14,540 and 14,666 for spring and fall, respectively; and, 14,450 and 14,656 for spring and fall bottom temperature, respectively. On average, there were 290 temperature measurements by season, depth, and year. The number of salinity observation per year were similar.

### Interpolation Procedure
Seasonal surface and bottom temperature fields were estimated using an optimal interpolation approach. The optimal interpolation combined a climatological depiction of temperature and an annual estimates based on the data for a particular depth and season. (There were a number of precursor steps that are described below.). 
The surveys used to collect the data were conducted during the same period each year, however, there was variation in survey timing. To account for this, temperatures were standardized to a collection date of April 3 for spring surveys and October 11 for fall using linear regression for each depth and season over the sample grid (see Appendix, [Figure A1](#fig:doc_correction)). For each depth and season, annual shelf-wide mean temperatures were calculated using the data from sample grid locations with at least 80% of the time series present. The annual observations were then transformed to anomalies by subtracting the appropriate annual mean. All anomalies for a season and depth were combined over years into a single anomaly field or climatology. 

The annual estimate of temperature for a depth and season was imputed by used universal kriging to estimate the temperature over the estimation grid with depth as a covariate. The kriging yielded temperature estimates and a variance estimate over the same grid. The optimal interpolation field was assembled by combining the annual estimate and information from the anomaly climatology. The climatology was re-leveled from anomaly values to temperatures by adding back the appropriate annual mean. For each location in the estimation grid, temperature was calculated as a weighted mean between the kriged annual estimate and the releveled climatology. The weightings in the calculations were partitioned based on the variance field of the annual kriging. The field was divided into quartiles from low to high variance with the weighting ratio of annual:climatology temperatures of 4:1, 3:1, 2:1, and 1:1, respectively. Hence, in areas of low variance the weighted mean was based on a weighting of 4:1, which would reflect a higher contribution of information from the annual estimate and thus be closer to an observation. In areas with high variance, the weighting ratio of 1:1 would reflect a greater effect of the climatology in determining the interpolation estimate. 

The optimal interpolation temperature fields were evaluated using cross validation and a comparison to external data. The performance of optimal interpolation was compared to the predictive skill of using either the climatology or annual interpolation alone by doing ten random cross validations of each treatment. Each random draw of training and test sets sampled 3% of the data for the test set, or about 500 observations per draw. The temperature fields were fit with the training data and compared with the test set data. The lowest error rates were realized with the optimal interpolation contrasted with highest predictive error associated with fields based on the climatology alone (see Appendix, [Figure A2](#fig:cross_val)). The spatial distribution of error had distinct depth and seasonal patterns. The spatial errors associated with the surface estimates were generally low with the exception of a few locations along the shelf break between latitudes 39-41°N; the spatial error in the bottom temperature varied by season, and was concentrated along the shelf break in spring and across the shelf between latitudes 36-40°N in fall (see Appendix, [Figure A3](#fig:oi_mae)). The optimal interpolation data were also compared to external data from other collection programs. The absolute errors between surface temperature data collected by satellites and the interpolation had interquartile ranges of approximately ±0.75°C (see Appendix, [Figure A4](#fig:oi_compare)). The absolute error in a comparison of interpolated bottom temperature to opportunist sampling was approximately ±0.75°C for spring bottom temperature and approximately 0.75-1.0°C in the fall. Salinity was estimated in the same way with the exception of collection correction, which was deemed unnecessary for the salinity data.

### {#fig:study-area}

```{r study area, echo = F, fig.align="center", fig.cap = "Map of the study system with half-degree sample grid (blue lines) and extent of estimation grid shown in beige points (a). Major features of the study system with shelf break marked in purple line (b). 100m depth shown as dashed line."}
knitr::include_graphics('data/images/ECSA_study_area.jpg')
```

## Chlorophyll data {#methodschl}
Chlorophyll a concentration ([Chl]) data extracted from satellite remote-sensing databases based on measurements made with the Sea-viewing Wide Field of View Sensor (SeaWiFS), Moderate Resolution Imaging Spectroradiometer on the Aqua satellite (MODIS), Medium Resolution Imaging Spectrometer (MERIS), and Visible and Infrared Imaging/Radiometer Suite (VIIRS) sensors. We used the Garver, Siegel, Maritorena Model (GSM) merged data product at 100 km (equivalent to a 1° grid) and 8-day spatial and temporal resolutions, respectively, obtained from the 
[Hermes GlobColour website](www.hermes.acri.fr/index.php). These four sensors provide an overlapping time series of [Chl] during the period 1997 to 2018 and were combined based on a bio-optical model inversion algorithm (Maritorena et al. 2010). 

## Zooplankton abundance {#methodszoo}
Zooplankton abundance is measured by the Ecosystem Monitoring Program (EcoMon), which conducts shelf-wide bimonthly surveys of the NES ecosystem [@Kane2007]. Zooplankton and ichthyoplankton are collected throughout the water column to a maximum depth of 200 m using paired 61-cm Bongo samplers equipped with 333-micron mesh nets. Sample location in this survey is based on a randomized strata design, with strata defined by bathymetry and along-shelf location. Plankton taxa are sorted and identified. We used the bio-volume of the 18 most abundant taxonomic categories as potential predictor variables [(Table 2)](#fig:habitatdesc). The zooplankton sample time series has some missing values, which necessitated the removal of spring data for the years 1989, 1990, 1991, and 1994 and fall data for the years 1989, 1990, and 1992. The data for each seasonal time frame was interpolated to a complete field over the estimation grid using ordinary kriging. 

### {#fig:zooptab}

```{r zooptab, echo=F, message=FALSE, warnings=FALSE, results='asis'}
tabl <- "
|Variable name|Full name|
|:----------|:-----------|
|acarspp|*Acartia* spp. |
|calfin|*Calanus finmarchicus* |
|chaeto|*Chaetognatha*|
|cham|*Centropages hamatus* |
|cirr|*Cirripedia*|
|ctyp|*Centropages typicus* |
|echino|*Echinodermata*|
|evadnespp|*Evadne* spp.|
|gas|*Gastropoda*|
|hyper|*Hyperiidea*|
|larvaceans|*Appendicularians*|
|mlucens|*Metridia lucens* |
|oithspp|*Oithona* spp. |
|para|*Paracalanus* parvus |
|penilia|*Penilia* spp.|
|pseudo|*Pseudocalanus* spp. |
|salps|*Salpa*|
|tlong|*Temora longicornis*| 
"
df<-suppressWarnings(readr::read_delim(tabl, delim="|"))
df<-df[-c(1,2) ,c("Variable name","Full name")]
knitr::kable(
  df, booktabs = TRUE,
  caption = 'Variable and species names for the 18 most abundant zooplankton taxa in EcoMon survey data.'
)
```

## Occupancy models {#methodsocc}

Occupancy and productivity habitats for Atlantic menhaden were estimated with random forest classification and regression models using a suite of static and dynamic predictor variables. Variation in species presence or absence and biomass across space, bathymetry factors, productivity factors, and climate factors were tested. Models were constructed separately for spring and fall seasons. The response variables were the occurrence and catch-per-unit-effort of Atlantic menhaden in the Northeast Fisheries Science Center bottom trawl survey, which is a fishery-independent survey on the Northeast US Shelf. The survey is conducted in the spring and fall of the year and is based on a stratified random design, which provides both spatial and temporal depictions of fish and macroinvertebrate abundances [@Grosslein1969]. The independent or predictor variable set included physical environment variables, habitat descriptors, zooplankton variables, and remote sensing variables; the variables will be described in more detail below. Occupancy models were fit as two-factor classification models (absence as 0; presence as 1) using the randomForest R package [@randomForest].

Prior to fitting the model, the independent variable set was first tested for multi-collinearity among the predictors and correlated variables were eliminated (R package @rfUtilities-package, version 2.1-3). From this reduced set of predictors, the final model variables were selected utilizing the model selection criteria of [@Murphy2010] as implemented in rfUtilities. Productivity models were fit as regression models with log10 transformed biomass-per-unit-effort as the response variable and the same starting set of predictor variables as in the occupancy models. As with the occupancy models, independent variables were tested for multi-collinearity and the model selection criteria was applied. Habitat was estimated from the model fits over a standard 0.1° grid, which circumscribes the range of ecosystem assessment areas [in the region](#fig:study-area). 

Three types of visualizations were created from the output of the tree models. The first visualization was used to see the average probability of occupancy over space and the rate of change (Sen's slope) in occupancy over the years. The second visualization was used to see the mean occupancy gradient magnitude, or frontal strength and the rate of change (Sen's slope) in occupancy gradient magnitude over the years. Gradient magnitude was calculated by calculating the median of the occupancy probabilities with a moving window and then summing those medians with a moving window with a matrix of weights. The third visualization was used to see the average biomass over space and the rate of change (Sen's slope) in biomass over the years. Trends in total occupancy habitat area, with occupancy probabilities of 25, 50, and 75% over time were plotted as well by calculating the sum of the area with occupancy probabilities at each percentage during each year. 

**Following from the 2018 ECSA for summer flounder, the methodology was changed by the conversion of salinity, surface and bottom, from a dynamic variable to a static variable. By so doing, the fitting period is extended from 1992-2017 to 1976-2018. Dynamic salinity data was limited by the time series of modern instrumentation, which began in 1992. In the 2018 model fits, dynamic salinity was not an important variable in any species model; hence, conversion to a static variable was of little consequence.**

### Minimum swept area abundance based on habitat informed dynamic re-stratification 

Estimates of the numbers and biomass minimum population size of stocks was determined by re-stratifying the habitat each year depending on the distribution of occupancy habitat. The habitat area was restricted to the portion of the shelf associated with the stock based on the roster of bottom trawl strata consider to comprise the stock area. To raise an annual estimate, the habitat was partitioned into ten intervals based on the probability of occurrence from the species distribution model. The partitions were based on equal intervals of occurrence probability; hence, the size of each habitat strata could vary. The trawl catch per unit effort values were assigned to the appropriate habitat strata based on the habitat score where the trawl was made. Once the requisite trawl hauls associated with a habitat strata were identified, a mean catch per unit effort was determined and raised to a total minimum population estimate for that stratum assuming a constant trawl path area of 0.024 km <sup>2</sup>. The total population was the sum of the estimates for the ten strata.

$Total\;numbers\;or\;biomass =\sum_{i=1}^{10} (strata\;area/trawl\;path\;area) * mean\;CPUE$

These estimates were conditioned on three options intended to ameliorate some of the issues associated with the variability in survey catch rates. The first allowed for the application of catch per unit effort data from either the stock area only or including tows from outside the stock area if they were collected in areas with habitat scores matching the probability from the intervals in the stock area. It was felt this may enhance the estimate by increasing the sample size for key strata. The second option provided the choice of performing a test for outliers on the trawl catch per unit effort data. The boxplot command in R was used to identify the outliers for removal. The last option involved whether to apply a smoothing across the mean catch per unit effort estimates in each strata. If the option was invoked, a loess smoother (span = 0.75) was applied to generate the smoothed catch rates; the procedure also had the benefit of interpolating and extrapolating a rate to a habitat strata that may not have had catch samples associated with it. Therefore, for each species/stock, an estimate of seasonal total abundance or biomass minimum population size will have eight realizations that test the sensitively of the calculations to these three formulation choices.


### Predictor Variables
Static variables were kept constant over years where dynamic variables varied annually. Hence, the length of the time series of model fits is constrained by the shortest dynamic variable time series to meet the requirement of complete cases in the Random Forest fitting. The fitting time series was constrained to 1992 – 2016, which was determined by the length of the station salinity data. 

### Physical environment
Station data included observations made contemporaneously to survey bottom trawl stations. Depth of the station was used as a static variable in the analysis. The observed depth was used in model fitting where model predictions were based on depths from the ETOPO1 dataset, which provided Northeast Shelf bathymetry at a resolution of 0.0167° [(below)](#fig:occ_grid).

### {#fig:occ_grid}

```{r occ_grid, fig.align="center", fig.cap = "Estimation grid for predictor variable and habitat estimates, grid location spaced by 0.1° longitude and latitude.", echo = F, out.width=switch(knitr::opts_knit$get("rmarkdown.pandoc.to"), latex = "0.5\\linewidth", html = '500')}
knitr::include_graphics("data/images/ECSA_occ_grid.png")
```

Surface and bottom water temperature and salinity were used as dynamic variables in the analysis. Temperature and salinity on the NE Shelf was collected using Conductivity/Temperature/Depth (CTD) instruments with the most complete sample coverage associated with spring (February –April) and fall (September-November) time frames. Surface and bottom temperatures were used to develop date of collection corrections using linear regression for each time frame. Temperatures were standardized to a collection date of April 3 for spring collections and October 11 for fall. A date of collection correction was not indicated for salinity data. The observed date-corrected temperature (°C) and uncorrected salinity data (PSU) was used in model fitting. 

Model predictions were based on temperature and salinity fields using an optimal interpolation approach where annual data were combined with a climatology by season. For a half degree grid of the ecosystem, mean bottom temperature or salinity was calculated by year and season. For grid locations that had data for at least 80% of the time series, the data from those locals were used to calculate a seasonal mean. The annual seasonal means were used to calculate anomalies, which were combined over the time series to provide seasonal, surface and bottom anomaly climatologies. 

Returning to the raw data, the observations for a year, season, and depth were then used to estimate an annual field using universal kriging with depth as a covariate. The kriging was done on a standard 0.1° grid using the automap [@automap, version 1.0-14]. The annual field was then combined with the climatology anomaly field, adjusted by the annual mean, using the variance field from the kriging as the basis for a weighted mean between the two. The variance field was divided into quartiles with the first quartile (lowest kriging variance) carrying a weighting of 4:1 between the annual and climatology values. Hence, the optimal interpolated field at these locations were skewed towards the annual data reflecting their proximity to actual data locations and low kriging variance associated with them. The weighting ratio shifted to 1:1 in the highest variance quartile reflecting less information from the annual field and more from the climatology.

### Habitat Descriptors
Habitat descriptors are a series of static variables that reflect the shape and complexity of benthic habitats. Since the response variables for these models are derived from bottom trawl gear, naturally the range of candidate taxa for modelling is skewed to benthic organisms, making these descriptors particularly relevant. Most of the variables are based on depth measurement, including the complexity, BBI, VRM, Prcurv, rugostity, seabedforms, slp, and slpslp variables [(Table 1)](#fig:habitatdesc). The soft-sed variable is based on benthic sediment grain size and the vorticity variable is based on current estimates.

### Zooplankton Data
Zooplankton abundance is measured by the Ecosystem Monitoring Program (EcoMon), which conducts shelf-wide bimonthly surveys of the NES ecosystem [@Kane2007]. Zooplankton and ichthyoplankton are collected throughout the water column to a maximum depth of 200 m using paired 61-cm Bongo samplers equipped with 333-micron mesh nets. Sample location in this survey is based on a randomized strata design, with strata defined by bathymetry and along-shelf location. Plankton taxa are sorted and identified. We used the bio-volume of the 18 most abundant taxonomic categories as potential predictor variables [(Table 2)](#fig:habitatdesc). The zooplankton sample time series has some missing values which were ameliorated by summing data over five-year time steps for each seasonal time frame and interpolating a complete field using ordinary kriging. Thus, for example, the data for spring 2000 would include the available data from 1998-2002 tows. 

### Remote Sensing Data
Chlorophyll concentration and SST from remote sensing sources were applied in the habitat models as static variables. Chlorophyll and SST were summarized as monthly means with their associated gradient magnitude or frontal fields. The basis for the chlorophyll concentration was measurements made with the Sea-viewing Wide Field of View Sensor (SeaWiFS), Moderate Resolution Imaging Spectroradiometer on the Aqua satellite (MODIS), Medium Resolution Imaging Spectrometer (MERIS), and Visible and Infrared Imaging/Radiometer Suite (VIIRS) sensors during the period 1997-2016. The data is a merged product using the Garver, Siegel, Maritorena Model (GSM) algorithm obtained from the [Hermes GlobColour website](www.hermes.acri.fr/index.php). 

These four sensors provide an overlapping time series of chlorophyll concentration during the period and were combined based on a bio-optical model inversion algorithm (Maritorena et al. 2010). Monthly SST fields were based on data from the MODIS Terra sensor data available from the [Ocean Color Website](http://oceancolor.gsfc.nasa.gov/cms/). From these data, mean monthly fields were generated for both chlorophyll and SST. There are a range of methods used to identify fronts [@Belkin2009] in oceanographic data that usually apply some focal filter to reduce noise and identify gradient magnitude with a Sobel filter. These calculations were done in R using the raster package [@raster, version 2.6-7] using a 3 by 3 mean focal filter and a Sobel filter to generate x and y derivatives, which are then used to calculate gradient magnitude. 

### Model Selection Criteria and Variable Importance

The habitat models were evaluated for fit based on out-of-bag classification accuracy. For occupancy models accuracy, AUC (Area Under the ROC Curve), and Cohen’s Kappa were calculated using the irr R package [@irr, version 0.84]. For regression models, the variance explained by the model, mean absolute error, the root mean square error, and bias were calculated using the Metrics R package [@metrics, version 0.1.3]. To evaluate variable importance in both occupancy and regression models, we plotted the number of times a variable was the root variable versus the mean minimum node depth for the variable, highlighting the top ten important variables using the randomForestExplainer R package [@randomForestExplainer, version 0.9]. For occupancy models we also plotted the Gini index decrease versus accuracy decrease, whereas for the regression models we plotted node purity increase versus MSE increase, also highlighting the top ten most important variables. 

### {#fig:habitatdesc}

```{r habitatdesc, echo = F, results='asis', message=F, warning=F}
tab <- '
|Variables|Notes|References|
|:-----------------------|:-----------------------|:-----------------------|
|Complexity - Terrain Ruggedness Index|The difference in elevation values from a center cell and the eight cells immediately surrounding it. Each of the difference values are squared to make them all positive and averaged. The index is the square root of this average.|@Riley1999|
|Namera bpi|BPI is a second order derivative of the surface depth using the TNC Northwest Atlantic Marine Ecoregional Assessment ("NAMERA") data with an inner radius=5 and outer radius=50.|@Lundblad2006|
|Namera_vrm|Vector Ruggedness Measure (VRM) measures terrain ruggedness as the variation in three-dimensional orientation of grid cells within a neighborhood based the TNC Northwest Atlantic Marine Ecoregional Assessment ("NAMERA") data.|@Hobson1972; @Sappington2007|
|Prcurv (2 km, 10 km, and 20 km)|Benthic profile curvature at 2km, 10km and 20 km spatial scales was derived from depth data.|@Winship2018|
|Rugosity|A measure of small-scale variations of amplitude in the height of a surface, the ratio of the real to the geometric surface area.|@Friedman2012|
|seabedforms|Seabed topography as measured by a combination of seabed position and slope.|[http://www.northeastoceandata.org/]()|
|Slp (2 km, 10 km, and 20 km)|Benthic slope at 2km, 10km and 20km spatial scales.|@Winship2018|
|Slpslp (2 km, 10 km, and 20 km)|Benthic slope of slope at 2km, 10km and 20km spatial scales|@Winship2018|
|soft_sed|Soft-sediments is based on grain size distribution from the USGS usSeabed: Atlantic coast offshore surficial sediment data.|[http://www.northeastoceandata.org/]()|
|Vort (fall - fa; spring - sp; summer - su; winter - wi)|Benthic current vorticity at a 1/6 degree (approx. 19 km) spatial scale.|@Kinlan2016|
'
df<-readr::read_delim(tab, delim="|")
df<-df[-c(1,2,3) ,c("Variables","Notes","References")]
knitr::kable(
  df, booktabs = TRUE,
  caption = 'Habitat descriptors used in occupancy model parameterization.'
)
```

## Diet composition {#sec:methodsdiet}
NEFSC bottom-trawl sampling occurs twice annually in the spring (March-May) and fall (September-November). The survey area encompasses about 293,000 square km of continental shelf from Cape Hatteras, NC, to Nova Scotia, Canada in depths from 8-400 m. Food habits sampling has been conducted since 1973. 

Stomachs are collected at sea by NEFSC, and have been primarily analyzed at sea since 1981. Total stomach volume is estimated, each prey item is identified and sorted to the lowest possible taxonomic level, and the proportion of each prey item is estimated. Detailed methods are described in @link_overview_2000.
Prey composition percent by weight was calculated using a weighted mean ($\overline{W_{ijs}}$) [@link_overview_2000; @smith_trophic_2010] to estimate mean weight of prey $i$ in predator $j$ for statistical group $s$. Note: Prey volumes are used as proxies for prey weight. It may be calculated as

$$ \overline{W_{ijs}} = \frac{\sum_{t=1}^{N_{ts}}N_{jts}\overline{w_{ijts}}}{N_{ts}} $$

where $t$ represents an individual bottom trawl tow, $N_{jts}$ is the number of predator $j$ stomachs in tow $t$ for statistical group $s$, $N_{ts}$ is the number of tows in statistical group $s$, and
                
$$ \overline{w_{ijts}} = \frac{\sum_{k=1}^{N_{jts}}w_{ijtsk}}{N_{jts}} $$
            
## Appendix 

### Date of collection correction
The dates of survey data collection varied by year. To date correct temperature measurements, regressions were estimated between temperature and day of the year over the sample grid (0.5° grid) by season and depth. Spring data were transformed to a temperature representing April 3 and fall to October 11 based on the slope estimates shown in the maps in [Figure A1](#fig:doc_correction). 

### {#fig:doc_correction}

```{r doc_correction, fig.align = "center", echo = F, fig.width=6, fig.cap = "**Figure A1**: Spring (a) and fall (b) linear slope coefficients used to date correct surface temperature to standard spring and fall dates; same for spring (c) and fall (d) bottom temperature correction."}
par(mar=c(0,0,0,0), xpd=NA, mgp=c(0,0,0), oma=c(0,0,0,0), ann=F, mfrow = c(2,2))
a <-jpeg::readJPEG(here::here('data/images/ECSA_doc_correction_a.jpg'))
b <-jpeg::readJPEG(here::here('data/images/ECSA_doc_correction_b.jpg'))
c <-jpeg::readJPEG(here::here('data/images/ECSA_doc_correction_c.jpg'))
d <-jpeg::readJPEG(here::here('data/images/ECSA_doc_correction_d.jpg'))
plot.new()
usr<-par("usr")
 
#fill plot with images
rasterImage(a, usr[1], usr[3], usr[2], usr[4])
rasterImage(b, usr[1]+1.1, usr[3], usr[2]+1.1, usr[4])
rasterImage(c, usr[1], usr[3]-1.1, usr[2], usr[4]-1.1)
rasterImage(d, usr[1]+1.1, usr[3]-1.1, usr[2]+1.1, usr[4]-1.1)
```

<br>

### Cross validation performance of temperature interpolation
A series of random draws of training and test sets were taken to evaluate the predictive skill of the estimation procedure. A set of climatology, annual interpolation, or optimal interpolation fields were estimated using the training set and compared to the held-out test set. 

#### {#fig:cross_val}

```{r cross_val, fig.align="center", fig.cap = "**Figure A2**: Mean and 95% confidence intervals of squared errors for spring (a) and fall (b) surface temperature estimates based on climatology, annual interpolation, and optimal interpolation (OI); same data for spring (c) and fall (d) bottom temperature estimates.", echo = F}
knitr::include_graphics(here::here("data/images/ECSA_crossval_temp_oi.png"))
```

<br>

The distribution of errors from the optimal interpolation test sets were evaluated spatially to determine where the larger errors occurred and what ecosystem features they are associated with.

### {#fig:oi_mae}
```{r oi_mae, fig.align = "center", echo = F, fig.width=5.75, fig.cap = "**Figure A3**: Mean absolute error by 0.1 degree latitude and longitude intervals for spring (a) and fall (b) surface temperature; same data for spring (c) and fall (d) bottom temperature. Red indicates a positive error where blue indicates negative."}
par(mar=c(0,0,0,0), xpd=NA, mgp=c(0,0,0), oma=c(0,0,0,0), ann=F, mfrow = c(2,2))
a <-jpeg::readJPEG(here::here('data/images/ECSA_oi_error_dist_a.jpg'))
b <-jpeg::readJPEG(here::here('data/images/ECSA_oi_error_dist_b.jpg'))
c <-jpeg::readJPEG(here::here('data/images/ECSA_oi_error_dist_c.jpg'))
d <-jpeg::readJPEG(here::here('data/images/ECSA_oi_error_dist_d.jpg'))
plot.new()
usr<-par("usr")
 
#fill plot with images
rasterImage(a, usr[1], usr[3], usr[2], usr[4])
rasterImage(b, usr[1]+1.1, usr[3], usr[2]+1.1, usr[4])
rasterImage(c, usr[1], usr[3]-1.1, usr[2], usr[4]-1.1)
rasterImage(d, usr[1]+1.1, usr[3]-1.1, usr[2]+1.1, usr[4]-1.1)
```

<br>

### Comparisons to external data sources

Sea surface temperature estimated in this study were compared to the [OISST dataset](https://www.ncdc.noaa.gov/oisst) serving as a source of data for external comparison. The OISST data for April 3 (spring) and October 11 (fall) over the period 1982-2017 were extracted on the same 0.5° grid used in the study. Time series of matching spring and fall temperatures were differenced (external minus interpolation data) and presented in the figure below (sample size for surface spring and fall data were 5220 and 5365, respectively). The interquartile range for the surface comparisons were generally symmetric around zero with differences between 0.5-1°C. Bottom temperature estimated in this study were compared to the data from a cooperative data collection program for external comparison. The “Environmental Monitors on Lobster Traps” [(EMOLT)](http://comet.nefsc.noaa.gov/erddap/tabledap/eMOLT.html) is a cooperative research program that collects bottom temperatures. The data for spring and fall were extracted from rasters of the study data to match the extremal data. The external data covered the period 1968-2017, with 360 data points for the spring and 728 for the fall. Spring bottom comparisons yielded the smallest interquartile range of differences less than 0.5°C, where fall comparisons were slightly larger and biased to lower interpolation estimates compared to the external data.

### {#fig:oi_compare}

```{r oi_compare, fig.align="center", fig.cap = "**Figure A4**: Box plots (box: interquartile range, whisker: 5-95% range, square symbol: mean, line: median) of the difference between external and interpolation data.", echo = F}
knitr::include_graphics("data/images/ECSA_oi_compare.png")
```


`r if (knitr::is_html_output()) '# References {-}'`

