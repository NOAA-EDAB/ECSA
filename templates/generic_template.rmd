---
title:
    | 
    | Ecosystem Context for Stock Assessments:
    | {{COMMON_NAME}}
date: "`r format(Sys.time(), '%B %d, %Y')`"
always_allow_html: yes
site: "bookdown::bookdown_site"
output:
  bookdown::gitbook:
    lib_dir: "book_assets"
---

```{r setup, include = FALSE}
## Load packages
# library(ecsa)
library(dplyr)
library(ggplot2)
# library(gridExtra)
library(DT)
library(jpeg)
library(patchwork)
library(ggiraph)
library(ggthemes)
library(cowplot)
library(stringr)

knitr::opts_chunk$set(echo = F, message = F, warning = F, fig.align = 'center')


# Load in survey data, right now it is only for summer flounder
# load("data/df_survdat.rda")
# colnames(survdat)
# colnames(df_survdat)

# load("data/Survdat.RData")
# tt <- survdat

## Read in stock area vectors
# all_stock_area2 <- read.csv("data/seasonal_stock_strata.csv")

## Read in stock area vectors
all_stock_area <- read.csv("data/stock_data/stock_list.csv", stringsAsFactors = FALSE)


## Put all mustaches here
stock_code <- "{{SPECIES_CODE}}"
# common_name <- "{{COMMON_NAME}}"
cc_name <- "{{CC_NAME}}"
# svspp <- "{{SVSPP}}"
# gg_int <- as.logical("{{INTERACTIVE}}")

source("R/map_strata.R")
source("R/get_strata.R")
source("R/crop_to_strata.R")
source("R/stars_to_series.R")

strata <- all_stock_area %>% 
  dplyr::filter(sp == stock_code)

```


## Overview 

### Introduction
This report provides contextual ecosystem information for {{COMMON_NAME}} (*{{SCI_NAME}}*) on the Northeast U.S. Continental Shelf. Data extractions for spring and fall are confined to the {{COMMON_NAME}} stock area based on respective survey strata sets. The information is intended to span a range of potential factors affecting the productivity and distribution of {{COMMON_NAME}}, including: surface and bottom temperature and salinity, chlorophyll concentrations, indices of habitat, diet composition, and abundance of key zooplankton prey of larval {{COMMON_NAME}}. These factors can be used to qualitatively inform the interpretation of population status and/or quantitatively to improve model responsiveness to ecosystem factors. The range and complexity of ecosystem data makes it unlikely to find the most relevant and comprehensive factor variables with a first evaluation; this process will require an iterative approach of evaluation and feedback. Additional indices can be included to address the needs of the working group.

#### Summary

* Add summary point 
* Add summary point 
* Add summary point 

### Strata definition
```{r strata-map, eval = TRUE, echo = FALSE, fig.cap= "Strata map for {{COMMON_NAME}} (*{{SCI_NAME}}*) on the NE shelf", message = FALSE, warning = FALSE, fig.align='center'}

map_strata(stock_code = stock_code, strata = strata, overwrite = FALSE, save_plot = FALSE)
```


#### A note on data flow:

Data sets in the template `Rmarkdown` file for this document are first passed to the `stars_to_series` function. This function first tries to clip the stars data cube into the shape of the seasonal stock area. If the first guess at the seasonal stock area (passed through the title of the .rdata file) is missing, the function returns environmental information in the available stock area for the opposing season. 

Therefore, if a spring data set is provided, but only a fall stock area is available, then the spring data is returned for the fall stock area. A third seasonal designation exists in the data ("both"). If this is the case, the environmental information is provided for those areas.

### Bottom Temperature

```{r bot_temp, fig.height=3}
spring_bottom_temp <- 
  stars_to_series(r = "bot_temp_spring_spdf.rdata",
                stock_code = stock_code,
                measure_name = "bottom_temp") %>% 
  ggplot() +
  geom_line(aes(x = Time, y = Mean))

fall_bottom_temp <- 
  stars_to_series(r = "bot_temp_fall_spdf.rdata",
                stock_code = stock_code,
                measure_name = "bottom_temp") %>% 
  ggplot() +
  geom_line(aes(x = Time, y = Mean))

spring_bottom_temp + fall_bottom_temp
```

### Surface Temperature

```{r surf_temp, fig.height=3}
spring_surface_temp <- 
  stars_to_series(r = "surf_temp_spring_spdf.rdata",
                stock_code = stock_code,
                measure_name = "surface_temp") %>% 
  ggplot() +
  geom_line(aes(x = Time, y = Mean))

fall_surface_temp <- 
  stars_to_series(r = "surf_temp_fall_spdf.rdata",
                stock_code = stock_code,
                measure_name = "surface_temp") %>% 
  ggplot() +
  geom_line(aes(x = Time, y = Mean))

spring_surface_temp + fall_surface_temp
```

### Bottom Salinity

```{r bot_sal, fig.height=3}
spring_bottom_sal <- 
  stars_to_series(r = "bot_sal_spring_spdf.rdata",
                stock_code = stock_code,
                measure_name = "bottom_sal") %>% 
  ggplot() +
  geom_line(aes(x = Time, y = Mean))

fall_bottom_sal <- 
  stars_to_series(r = "bot_sal_fall_spdf.rdata",
                stock_code = stock_code,
                measure_name = "bottom_sal") %>% 
  ggplot() +
  geom_line(aes(x = Time, y = Mean))

spring_bottom_sal + fall_bottom_sal
```

### Surface Salinity

```{r surf_sal, fig.height=3}
spring_surface_sal <- 
  stars_to_series(r = "surf_sal_spring_spdf.rdata",
                stock_code = stock_code,
                measure_name = "surface_sal") %>% 
  ggplot() +
  geom_line(aes(x = Time, y = Mean))

fall_surface_sal <- 
  stars_to_series(r = "surf_sal_fall_spdf.rdata",
                stock_code = stock_code,
                measure_name = "surface_sal") %>% 
  ggplot() +
  geom_line(aes(x = Time, y = Mean))

spring_surface_sal + fall_surface_sal
```
_Last updated on `r format(Sys.Date(), format = "%B %e %Y")`._
