---
title:
    | 
    | Ecosystem Context for Stock Assessments:
    | {{COMMON_NAME}}
date: "`r format(Sys.time(), '%B %d, %Y')`"
always_allow_html: yes
site: "bookdown::bookdown_site"
output:
  bookdown::gitbook:
    lib_dir: "book_assets"
    config:
      toc:
        collapse: none
        after: |
          <li><a href="https://bookdown.org" target="_blank">Published with bookdown</a></li>
---

```{r setup, include = FALSE}
## Load packages
# library(ecsa)
library(dplyr)
library(ggplot2)
library(plotly)
library(DT)
library(jpeg)
library(patchwork)
library(ggthemes)
library(cowplot)
library(stringr)

knitr::opts_chunk$set(echo = F, message = F, warning = F, fig.align = 'center')


## Read in stock area vectors
all_stock_area <- read.csv("data/stock_data/stock_list.csv", stringsAsFactors = FALSE)


## Put all mustaches here
stock_code <- "{{SPECIES_CODE}}"
common_name <- "{{COMMON_NAME}}"
cc_name <- "{{CC_NAME}}"
# svspp <- "{{SVSPP}}"
# gg_int <- as.logical("{{INTERACTIVE}}")

source("R/map_strata.R")
source("R/get_strata.R")
source("R/crop_to_strata.R")
source("R/stars_to_series.R")
source("R/tab_plotly.R")
source("R/tab_plotly_zoo.R")
source("R/create_buttons.R")

#Function to rank time series by group mean. Returns top N groups
rank_by_group <- function(df, group, N, join_with){
  out <- df %>% 
    dplyr::group_by(Grouping = get(group)) %>% 
    dplyr::summarise(M = mean(Mean, na.rm = T)) %>% 
    top_n(N) %>% 
    arrange(desc(M)) %>% 
    mutate(id = 1:N) 
  return(out)
}

N <- 5

strata <- all_stock_area %>% 
  dplyr::filter(sp == stock_code)



```


# Overview 

### Introduction
This report provides contextual ecosystem information for {{COMMON_NAME}} (*{{SCI_NAME}}*) on the Northeast U.S. Continental Shelf. Data extractions for spring and fall are confined to the {{COMMON_NAME}} stock area based on respective survey strata sets. The information is intended to span a range of potential factors affecting the productivity and distribution of {{COMMON_NAME}}, including: surface and bottom temperature and salinity, chlorophyll concentrations, indices of habitat, diet composition, and abundance of key zooplankton prey of larval {{COMMON_NAME}}. These factors can be used to qualitatively inform the interpretation of population status and/or quantitatively to improve model responsiveness to ecosystem factors. The range and complexity of ecosystem data makes it unlikely to find the most relevant and comprehensive factor variables with a first evaluation; this process will require an iterative approach of evaluation and feedback. Additional indices can be included to address the needs of the working group.

#### Summary

* Add summary point 
* Add summary point 
* Add summary point 

### Strata definition
```{r strata-map, eval = TRUE, echo = FALSE, fig.cap= "Strata map for {{COMMON_NAME}} (*{{SCI_NAME}}*) on the NE shelf", message = FALSE, warning = FALSE, fig.align='center'}

map_strata(stock_code = stock_code, strata = strata, overwrite = FALSE, save_plot = FALSE)
```


#### A note on data flow:

Data sets in the template `Rmarkdown` file for this document are first passed to the `stars_to_series` function. This function takes stacks of raster layers and crops them into the shape of the seasonal stock area. If the first guess at the seasonal stock area (passed through the title of the `.rdata` file) fails, the function returns environmental information in the available stock area for the opposing season. 

Therefore, if a spring data set is provided, but only a fall stock area is available, then the spring data is returned for the fall stock area. A third seasonal designation exists in the data ("both"). In this case, the environmental information is provided for combined spring and fall stock areas.

_Last updated on `r format(Sys.Date(), format = "%B %e %Y")`._

# Temperature

An optimal interpolation procedure was used to estimate NE Shelf surface and bottom temperatures for two seasonal time frames (see [methods](https://noaa-edab.github.io/ECSA/#sec:methodstempsalin)). The temperature estimates were standardized to April 3 and October 11 for spring and fall over the period 1968-2018. Surface and bottom temperature within the `r common_name` stock areas are shown below.

### Bottom Temperature

```{r bot_temp, fig.height=4}
spring_bottom_temp <- 
  stars_to_series(r = "bot_temp_spring_spdf.rdata",
                stock_code = stock_code,
                measure_name = "bottom_temp") %>% 
  mutate(season = "Spring")

fall_bottom_temp <- 
  stars_to_series(r = "bot_temp_fall_spdf.rdata",
                stock_code = stock_code,
                measure_name = "bottom_temp") %>% 
  mutate(season = "Fall")

bottom_temp_plt<- rbind(spring_bottom_temp,
                fall_bottom_temp) %>% 
  tidyr::spread(season, Mean) %>% 
  tab_plotly(.,title = "Bottom Temperature", ylab = "Temperature (&deg;C)")
bottom_temp_plt 
```

### Surface Temperature

```{r surf_temp, fig.height=4}
spring_surface_temp <- 
  stars_to_series(r = "surf_temp_spring_spdf.rdata",
                stock_code = stock_code,
                measure_name = "surface_temp")  %>% 
  mutate(season = "Spring")

fall_surface_temp <- 
  stars_to_series(r = "surf_temp_fall_spdf.rdata",
                stock_code = stock_code,
                measure_name = "surface_temp")  %>% 
  mutate(season = "Fall")

surface_temp_plt <- rbind(spring_surface_temp,
                fall_surface_temp) %>% 
  tidyr::spread(season, Mean) %>% 
  tab_plotly(.,title = "Surface Temperature", ylab = "Temperature (&deg;C)")
surface_temp_plt
```

# Salinity

An optimal interpolation procedure was used to estimate NE Shelf surface and bottom salinity for two seasonal time frames (see [methods](https://noaa-edab.github.io/ECSA/#sec:methodstempsalin)). Though collected with temperature data, reliable instrumentation limits this time series to 1992-2018. The salinity estimates were standardized to April 3 and October 11 for spring and fall. Surface and bottom salinities within the `r common_name` stock areas are shown below.

### Bottom Salinity

```{r bot_sal, fig.height=4}
spring_bottom_sal <- 
  stars_to_series(r = "bot_sal_spring_spdf.rdata",
                stock_code = stock_code,
                measure_name = "bottom_sal") %>% 
  mutate(season = "Spring")

fall_bottom_sal <- 
  stars_to_series(r = "bot_sal_fall_spdf.rdata",
                stock_code = stock_code,
                measure_name = "bottom_sal")  %>% 
  mutate(season = "Fall")

bottom_sal_plt <- rbind(spring_bottom_sal,
                fall_bottom_sal) %>% 
  tidyr::spread(season, Mean) %>% 
  tab_plotly(.,title = "Bottom Salinity", ylab = "Salinity (PSU)")

bottom_sal_plt
```

### Surface Salinity

```{r surf_sal, fig.height=4}
spring_surface_sal <- 
  stars_to_series(r = "surf_sal_spring_spdf.rdata",
                stock_code = stock_code,
                measure_name = "surface_sal") %>% 
  mutate(season = "Spring")

fall_surface_sal <- 
  stars_to_series(r = "surf_sal_fall_spdf.rdata",
                stock_code = stock_code,
                measure_name = "surface_sal")  %>% 
  mutate(season = "Fall")

surface_sal_plt <- rbind(spring_surface_sal,
                fall_surface_sal) %>% 
  tidyr::spread(season, Mean) %>% 
  tab_plotly(.,title = "Surface Salinity", ylab = "Salinity (PSU)")
surface_sal_plt
```

# Habitat and abundance

## Occurrence probability

The probability of occurrence was estimated using random forest classification models (see [methods](https://noaa-edab.github.io/ECSA/#sec:methodsocc)). Probabilities were extracted for the spring and fall stock definition areas. 

```{r occ_prob, fig.height=4}
spring_occ_prob <- 
  stars_to_series(r = "occurrence_prob_spring.rdata",
                stock_code = stock_code,
                measure_name = "occurrence") %>% 
  mutate(season = "Spring")

fall_occ_prob <- 
  stars_to_series(r = "occurrence_prob_fall.rdata",
                stock_code = stock_code,
                measure_name = "occurrence") %>% 
  mutate(season = "Fall") 

occ_prob_plt <- rbind(spring_occ_prob,
                fall_occ_prob) %>% 
  tidyr::spread(season, Mean) %>% 
  tab_plotly(.,title = "Occupancy Probability", ylab = "Occupancy probability")
occ_prob_plt
```

## Biomass

```{r biomass, fig.height=4}
spring_biomass <- 
  stars_to_series(r = "biomass_spring.rdata",
                stock_code = stock_code,
                measure_name = "biomass") %>% 
  mutate(season = "Spring")

fall_biomass <- 
  stars_to_series(r = "biomass_fall.rdata",
                stock_code = stock_code,
                measure_name = "biomass") %>% 
  mutate(season = "Fall") %>% 
  dplyr::distinct()

biomass_plt <- rbind(spring_biomass,
                fall_biomass) %>% 
  tidyr::spread(season, Mean) %>% 
  tab_plotly(.,title = "Biomass", ylab = "Value")

biomass_plt
```

# Chlorophyll

The concentration of chlorophyll was measured with a suite of satellite sensors and merged into a single dataset (see [methods](https://noaa-edab.github.io/ECSA/#sec:methodschl)). Chlorophyll concentrations in the spring and fall `r common_name` stock areas are shown below.

```{r chl, fig.height=4}

fall_chl <- stars_to_series(r = "chlorophyll_conc.rdata",
                stock_code = stock_code,
                measure_name = "chl",
                process_to_season = "fall")$fall %>% 
  mutate(season = "Fall")

spring_chl <- stars_to_series(r = "chlorophyll_conc.rdata",
                stock_code = stock_code,
                measure_name = "biomass",
                process_to_season = "spring")$spring %>% 
  mutate(season = "Spring")

chl_plt <- rbind(spring_chl,
                fall_chl) %>% 
  tidyr::spread(season, Mean) %>% 
  tab_plotly(.,title = "Chlorophyll", ylab = "Chlorophyll (mg m<sup>-3</sup>)")

chl_plt
```

# Zooplankton

## Annual 

```{r zoo_1yr_spring, fig.height=4}
spring_zoo_1yr <- stars_to_series(r <- "zoo_spring_rasters_1yr.rdata",
                stock_code = stock_code,
                measure_name = "zoo",
                group_regex = "[^A-Z_](.*)(?=_)") %>% 
  mutate(season = "spring") %>% 
  left_join(rank_by_group(., group = "Grouping", N = N),
            by = "Grouping") %>% 
  dplyr::filter(!is.na(id)) %>% 
  arrange(id) %>% 
  dplyr::rename(Genera = Grouping) %>% 
  dplyr::select(-id, -M, -season) %>%
  tidyr::spread(Genera, Mean)

buttons <- create_buttons(spring_zoo_1yr)

spring_zoo_1yr_plt <- 
  tab_plotly_zoo(df = spring_zoo_1yr, 
               title = "Spring zooplankton abundance",
               ylab = "Abundance (log num m<sup>-3</sup>)",
               genera = names(spring_zoo_1yr)[names(spring_zoo_1yr) != "Time"],
               update_buttons = buttons)

spring_zoo_1yr_plt
```


```{r zoo_1yr_fall, fig.height=4}
fall_zoo_1yr <- stars_to_series(r <- "zoo_fall_rasters_1yr.rdata",
                stock_code = stock_code,
                measure_name = "zoo",
                group_regex = "[^A-Z_](.*)(?=_)") %>% 
  mutate(season = "fall") %>% 
  left_join(rank_by_group(., group = "Grouping", N = N),
            by = "Grouping") %>% 
  dplyr::filter(!is.na(id)) %>% 
  arrange(id) %>% 
  dplyr::rename(Genera = Grouping) %>% 
  dplyr::select(-id, -M, -season) %>%
  tidyr::spread(Genera, Mean)

buttons <- create_buttons(fall_zoo_1yr)

fall_zoo_1yr_plt <- 
  tab_plotly_zoo(df = fall_zoo_1yr, 
               title = "Fall zooplankton abundance",
               ylab = "Abundance (log num m<sup>-3</sup>)",
               genera = names(fall_zoo_1yr)[names(fall_zoo_1yr) != "Time"],
               update_buttons = buttons)

fall_zoo_1yr_plt
```

## 5 year rolling mean

```{r zoo_5yr_spr, fig.height=4}

spring_zoo_5yr <- stars_to_series(r <- "zoo_spring_rasters_5yr.rdata",
                stock_code = stock_code,
                measure_name = "zoo",
                group_regex = "[^A-Z_](.*)(?=_)") %>% 
  mutate(season = "spring") %>% 
  left_join(rank_by_group(., group = "Grouping", N = N),
            by = "Grouping") %>% 
  dplyr::filter(!is.na(id)) %>% 
  arrange(id) %>% 
  dplyr::rename(Genera = Grouping) %>% 
  dplyr::select(-id, -M, -season) %>%
  tidyr::spread(Genera, Mean)

buttons <- create_buttons(spring_zoo_5yr)

spring_zoo_5yr_plt <- 
  tab_plotly_zoo(df = spring_zoo_5yr, 
               title = "Spring zooplankton abundance",
               ylab = "Abundance (log num m<sup>-3</sup>)",
               genera = names(spring_zoo_5yr)[names(spring_zoo_5yr) != "Time"],
               update_buttons = buttons)

spring_zoo_5yr_plt
```

```{r zoo_5yr_fall, fig.height=4}
fall_zoo_5yr <- stars_to_series(r <- "zoo_fall_rasters_5yr.rdata",
                stock_code = stock_code,
                measure_name = "zoo",
                group_regex = "[^A-Z_](.*)(?=_)") %>% 
  mutate(season = "fall") %>% 
  left_join(rank_by_group(., group = "Grouping", N = N),
            by = "Grouping") %>% 
  dplyr::filter(!is.na(id)) %>% 
  arrange(id) %>% 
  dplyr::rename(Genera = Grouping) %>% 
  dplyr::select(-id, -M, -season) %>%
  tidyr::spread(Genera, Mean)

buttons <- create_buttons(fall_zoo_5yr)

fall_zoo_5yr_plt <- 
  tab_plotly_zoo(df = fall_zoo_5yr, 
               title = "Fall zooplankton abundance",
               ylab = "Abundance (log num m<sup>-3</sup>)",
               genera = names(fall_zoo_5yr)[names(fall_zoo_5yr) != "Time"],
               update_buttons = buttons)

fall_zoo_5yr_plt
```



