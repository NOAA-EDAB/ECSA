---
title: {{STOCK_NAME}}
#date: "`r format(Sys.time(), '%B %d, %Y')`"
always_allow_html: yes
output: 
        html_document:
          fig_caption: yes
---

```{r, include = FALSE}
## Load packages
# library(ecsa)
library(dplyr)
library(ggplot2)
library(plotly)
library(DT)
library(jpeg)
library(patchwork)
library(ggthemes)
library(AICcmodavg)
library(stringr)
library(ecotrend)
library(magrittr)
library(raster)
library(stars)
library(dplyr)
library(here)
library(zoo)
library(gt)
library(ggiraph)

knitr::opts_chunk$set(echo = F, message = F, warning = F, fig.align = 'center')

## Read in stock area vectors

all_stock_season <- readr::read_csv(here::here("data/stock_data/stock_list.csv"),
                                 col_types = readr::cols(
                                   common_name = readr::col_character(),
                                   sci_name = readr::col_character(),
                                   cc_name = readr::col_character(),
                                   stock_name = readr::col_character(),
                                   species_code = readr::col_character(),
                                   svspp = readr::col_double(),
                                   stock_season = readr::col_character(),
                                   strata = readr::col_double()))



#zooplankton lookup table
zoo_lookup <- read.csv(here::here("data-raw/zooplankton_lookup.csv"), stringsAsFactors = F)

## Put all mustaches here
common_name <- "{{COMMON_NAME}}"
stock_code <- "{{SPECIES_CODE}}"
stock_name <- "{{STOCK_NAME}}"
cc_name <- "{{CC_NAME}}"
stock_subarea <- "{{STOCK_SUBAREA}}"
# svspp <- "{{SVSPP}}"


source(here::here("R/map_strata.R"))
source(here::here("R/get_strata.R"))
source(here::here("R/crop_to_strata.R"))
source(here::here("R/stars_to_series.R"))
source(here::here("R/tab_plotly.R"))
source(here::here("R/create_buttons.R"))
source(here::here("R/STARS_v18.R"))
source(here::here("R/gls_summary.R"))
source(here::here("R/plot_sae.R"))


N <- 5
alpha <- 0.05

strata <- all_stock_season %>%   
  dplyr::filter(stock_name == !!stock_name)

svspp_ <- strata %>% pull(svspp) %>% unique()

#Specific analytical treatments were selected beforehand for each stock. These data are in data-raw/treatment_selection.csv. We import here and filter the below SAE data by treatment selection. 
treatment_selection <- 
  read.csv(here::here("data-raw/treatment_selection.csv"),
                       stringsAsFactors = F) %>% 
  filter(svspp == svspp_)

#Load swept area estimate data. Filter by svspp code and treatment selection
spring_sae <- read.csv(here::here("data-raw/spring_sae_tb_sum.csv"),
                       stringsAsFactors = F) %>% 
  filter(svspp == svspp_, treatment %in% unique(treatment_selection$treat))

fall_sae <- read.csv(here::here("data-raw/fall_sae_tb_sum.csv"),
                     stringsAsFactors = F) %>% 
  filter(svspp == svspp_, treatment %in% unique(treatment_selection$treat))

#Get available seasons for stocks
stock_season <- strata %>% pull(stock_season) %>% unique()

#Set interactive to F when pushing a draft document to google drive. Otherwise, the ggiraph figures will render as interactive. Interactive figures should only be used during the creation of the final bookdown document. 
interactive <- T
```


# Introduction
{{IntroductionStart}}
This report provides contextual ecosystem information for {{STOCK_SUBAREA}}{{COMMON_NAME}} (*{{SCI_NAME}}*) on the Northeast U.S. Continental Shelf. Data extractions for spring and fall are confined to the {{COMMON_NAME}} stock area based on respective survey strata sets. The information is intended to span a range of potential factors affecting the productivity and distribution of {{COMMON_NAME}}, including: surface and bottom temperature and salinity, chlorophyll concentrations, indices of habitat, diet composition, and abundance of key zooplankton prey of larval {{COMMON_NAME}}. These factors can be used to qualitatively inform the interpretation of population status and/or quantitatively to improve model responsiveness to ecosystem factors. The range and complexity of ecosystem data makes it unlikely to find the most relevant and comprehensive factor variables with a first evaluation; this process will require an iterative approach of evaluation and feedback. Additional indices can be included to address the needs of the working group.
{{IntroductionEnd}}

### Summary {-#summary}

{{SummaryStart}}
{{SummaryEnd}}

### Stock area {-#stock-area}

```{r strata-map, eval = T, echo = FALSE, fig.cap= "Strata map for {{COMMON_NAME}} (*{{SCI_NAME}}*) on the NE shelf", message = FALSE, warning = FALSE, fig.align='center'}
map_strata(stock_name = stock_name,
           common_name = common_name,
           stock_season = stock_season,
           strata = strata,
           overwrite = FALSE,
           save_plot = FALSE)
```

#### A note on figures {-#a-note-on-figures}

Unless otherwise noted, time series in this document are represented by dark blue lines. Estimates of linear trends and regime shifts are included on plots when found to be significant (p < 0.05), and are shown by green and light blue lines respectively. Trend strengths and confidence intervals are also included in plot titles when trends are present. Trends were modeled using a GLS model selection approach [see @hardison2019 for details].

_Last updated on `r format(Sys.Date(), format = "%B %e %Y")`._

# Temperature

{{TemperatureStart}}
An optimal interpolation procedure was used to estimate NE Shelf surface and bottom temperatures for two seasonal time frames (see [methods](#methodstempsalin)). The temperature estimates were standardized to April 3 and October 11 for spring and fall over the period 1968-2018. Surface and bottom temperature within the `r common_name` stock areas are shown below.
{{TemperatureEnd}}

## Bottom Temperature {-#bottom-temperature}

{{BottomTemperatureStart}}
{{BottomTemperatureEnd}}

```{r bot_temp_process}
spring_bottom_temp <- 
  stars_to_series(r = "bot_temp_spring_spdf.rdata",
                stock_name = stock_name, 
                common_name = common_name,
                stock_season = stock_season,
                data_season = "spring",
                measure_name = "bottom_temp") %>% 
  dplyr::filter(Time >= 1968) %>% 
  mutate(season = "Spring") %>% 
  ecotrend::glsMs(Mean ~ Time,
                data = .,
                diagnostic = T,
                fit_model  = T) 


STARS_in <- spring_bottom_temp$fit %>% 
  dplyr::select(-fit) %>% 
  as.matrix()

if (spring_bottom_temp$`selection summary`$pval[1] < 0.05){
  spring_mod <- spring_bottom_temp$model
  
  spring_bottom_temp <- spring_bottom_temp$fit %>% 
    dplyr::select(Time = time, 
                  Series = series,
                  Trend = fit)
  
  summ_ <- gls_summary(mod = spring_mod)
  trend <- summ_$Value[1]
  lci <- summ_$Value[2]
  uci <- summ_$Value[3]

  spring_title <- sprintf("Spring Trend: %s CI: (%s, %s)", trend, lci, uci)

} else {
    spring_bottom_temp <- spring_bottom_temp$fit %>% 
      dplyr::select(Time = time, 
                Series = series)
    spring_title <- "Spring"
}

spring_bottom_temp %<>%  
  left_join(.,STARS(mat.in = STARS_in),by = "Time") %>% 
  dplyr::select(-Data, -RSI, -Regime.Number,
                `Regime mean` = Regime.Mean) %>% 
  dplyr::select(which(sapply(.,var)!=0))

spring_min <- min(spring_bottom_temp$Time)

fall_bottom_temp <- 
  stars_to_series(r = "bot_temp_fall_spdf.rdata",
               stock_name = stock_name,
               common_name = common_name,
               stock_season = stock_season,
               data_season = "fall",
                measure_name = "bottom_temp") %>% 
  dplyr::filter(Time >= 1968) %>% 
  mutate(season = "fall") %>% 
  dplyr::distinct() %>% 
  ecotrend::glsMs(Mean ~ Time,
                data = .,
                diagnostic = T,
                fit_model  = T) 



STARS_in <- fall_bottom_temp$fit %>% 
  dplyr::select(-fit) %>% 
  as.matrix()

if (fall_bottom_temp$`selection summary`$pval[1] < 0.05){

  fall_mod <- fall_bottom_temp$model
  
  fall_bottom_temp <- fall_bottom_temp$fit %>% 
      dplyr::select(Time = time, 
                Series = series,
                Trend = fit)
  
  summ_ <- gls_summary(mod = fall_mod)
  trend <- summ_$Value[1]
  lci <- summ_$Value[2]
  uci <- summ_$Value[3]
  
  fall_title <- sprintf("Fall Trend: %s CI: (%s, %s)", trend, lci, uci)
} else {
    fall_bottom_temp <- fall_bottom_temp$fit %>% 
      dplyr::select(Time = time, 
                Series = series)
    fall_tile <- "Fall"
}


fall_bottom_temp %<>%
  left_join(.,STARS(mat.in = STARS_in),by = "Time") %>% 
  dplyr::select(-Data, -RSI, -Regime.Number,
                `Regime mean` = Regime.Mean) %>% 
  dplyr::select(which(sapply(.,var)!=0))

fall_min <- min(fall_bottom_temp$Time)

if (fall_min > spring_min) {
  plot_min <- spring_min
} else {
  plot_min <- fall_min
}
```


```{r bot_temp_spring_plt, fig.height=3}

spring_bottom_temp_plt <- 
  spring_bottom_temp %>% 
    tidyr::gather(Var, Value, -Time) %>% 
  mutate(tooltip = paste0("<table><tr><td>Year:</td><td>",Time,"</td></tr><tr><td>Value:  </td><td>",round(Value,3),"</td></tr></table>")) %>% 
  ggplot(aes(x = Time, 
            y = Value, color = Var, group = Var,
                 tooltip = tooltip,
                 data_id = Time)) +
  geom_line()+
  {if(interactive) geom_point_interactive(size = 0)
    else geom_line()} +
    scale_color_manual(values = 
                         c("Regime mean" = "#b2df8a",
                         "Trend" = "#a6cee3",
                         "Series" = "#1f78b4"))+
    theme_minimal() +
    theme(legend.title = element_blank()) +
    ylab("Temperature (Â°C)") +
    ggtitle(spring_title)

if (interactive){
  girafe_options(girafe(code = print(spring_bottom_temp_plt), width = 0.9,
         height_svg = 2.5),opts_hover(css = "r:2pt;") )
} else {
  spring_bottom_temp_plt
}

```


```{r bot_temp_fall_plt, fig.height=3}
fall_bottom_temp_plt <- 
  fall_bottom_temp %>% 
    tidyr::gather(Var, Value, -Time) %>% 
  mutate(tooltip = paste0("<table><tr><td>Year:</td><td>",Time,"</td></tr><tr><td>Value:  </td><td>",round(Value,3),"</td></tr></table>")) %>% 
  ggplot(aes(x = Time, 
            y = Value, color = Var, group = Var,
                 tooltip = tooltip,
                 data_id = Time)) +
  geom_line()+
  {if(interactive) geom_point_interactive(size = 0)
    else geom_line()} +
    scale_color_manual(values = 
                         c("Regime mean" = "#b2df8a",
                         "Trend" = "#a6cee3",
                         "Series" = "#1f78b4"))+
    theme_minimal() +
    theme(legend.title = element_blank()) +
    ylab("Temperature (Â°C)") +
    ggtitle(fall_title)

if (interactive){
  girafe_options(girafe(code = print(fall_bottom_temp_plt), width = 0.9,
         height_svg = 2.5),opts_hover(css = "r:2pt;") )
} else {
  fall_bottom_temp_plt
}

```


## Surface Temperature {-#surface-temperature}

{{SurfaceTemperatureStart}}
{{SurfaceTemperatureEnd}}

```{r surf_temp_process}
spring_surface_temp <- 
  stars_to_series(r = "surf_temp_spring_spdf.rdata",
                stock_name = stock_name,
                common_name = common_name,
                stock_season = stock_season,
                data_season = "spring",
                measure_name = "surface_temp") %>% 
  dplyr::filter(Time >= 1968) %>% 
  mutate(season = "Spring") %>% 
  ecotrend::glsMs(Mean ~ Time,
                data = .,
                diagnostic = T,
                fit_model  = T) 


STARS_in <- spring_surface_temp$fit %>% 
  dplyr::select(-fit) %>% 
  as.matrix()

if (spring_surface_temp$`selection summary`$pval[1] < 0.05){
  spring_mod <- spring_surface_temp$model

  spring_surface_temp <- spring_surface_temp$fit %>% 
      dplyr::select(Time = time, 
                Series = series,
                Trend = fit)
  
  summ_ <- gls_summary(mod = spring_mod)
  trend <- summ_$Value[1]
  lci <- summ_$Value[2]
  uci <- summ_$Value[3]

  spring_title <- sprintf("Spring Trend: %s CI: (%s, %s)", trend, lci, uci)
  
} else {
    spring_surface_temp <- spring_surface_temp$fit %>% 
      dplyr::select(Time = time, 
                Series = series)
    spring_title <- "Spring"
}

spring_surface_temp %<>%  
  left_join(.,STARS(mat.in = STARS_in),by = "Time") %>% 
  dplyr::select(-Data, -RSI, -Regime.Number,
                `Regime mean` = Regime.Mean) %>% 
  dplyr::select(which(sapply(.,var)!=0))

spring_min <- min(spring_surface_temp$Time)

fall_surface_temp <- 
  stars_to_series(r = "surf_temp_fall_spdf.rdata",
                stock_name = stock_name,
                common_name = common_name,
                stock_season = stock_season,
                data_season = "fall",
                measure_name = "surface_temp") %>% 
  dplyr::filter(Time >= 1968) %>% 
  mutate(season = "fall") %>% 
  dplyr::distinct() %>% 
  ecotrend::glsMs(Mean ~ Time,
                data = .,
                diagnostic = T,
                fit_model  = T) 



STARS_in <- fall_surface_temp$fit %>% 
  dplyr::select(-fit) %>% 
  as.matrix()

if (fall_surface_temp$`selection summary`$pval[1] < 0.05){
  fall_mod <- fall_surface_temp$model
  
  fall_surface_temp <- fall_surface_temp$fit %>% 
      dplyr::select(Time = time, 
                Series = series,
                Trend = fit)
  
  summ_ <- gls_summary(mod = fall_mod)
  trend <- summ_$Value[1]
  lci <- summ_$Value[2]
  uci <- summ_$Value[3]
  
  fall_title <- sprintf("Fall Trend: %s CI: (%s, %s)", trend, lci, uci)
} else {
    fall_surface_temp <- fall_surface_temp$fit %>% 
      dplyr::select(Time = time, 
                Series = series)
    fall_title <- "Fall"
}


fall_surface_temp %<>%
  left_join(.,STARS(mat.in = STARS_in),by = "Time") %>% 
  dplyr::select(-Data, -RSI, -Regime.Number,
                `Regime mean` = Regime.Mean) %>% 
  dplyr::select(which(sapply(.,var)!=0))

fall_min <- min(fall_surface_temp$Time)

if (fall_min > spring_min) {
  plot_min <- spring_min
} else {
  plot_min <- fall_min
}
```


```{r surf_temp_spring_plt, fig.height=3}

spring_surface_temp_plt <- 
  spring_surface_temp %>% 
    tidyr::gather(Var, Value, -Time) %>% 
  mutate(tooltip = paste0("<table><tr><td>Year:</td><td>",Time,"</td></tr><tr><td>Value:  </td><td>",round(Value,3),"</td></tr></table>")) %>% 
  ggplot(aes(x = Time, 
            y = Value, color = Var, group = Var,
                 tooltip = tooltip,
                 data_id = Time)) +
  geom_line()+
  {if(interactive) geom_point_interactive(size = 0)
    else geom_line()} +
    scale_color_manual(values = 
                         c("Regime mean" = "#b2df8a",
                         "Trend" = "#a6cee3",
                         "Series" = "#1f78b4"))+
    theme_minimal() +
    theme(legend.title = element_blank()) +
    ylab("Temperature (Â°C)") +
    ggtitle(spring_title)

if (interactive){
  girafe_options(girafe(code = print(spring_surface_temp_plt), width = 0.9,
         height_svg = 2.5),opts_hover(css = "r:2pt;") )
} else {
  spring_surface_temp_plt
}

```

```{r surf_temp_fall_plt, fig.height=3}

fall_surface_temp_plt <- 
  fall_surface_temp %>% 
    tidyr::gather(Var, Value, -Time) %>% 
  mutate(tooltip = paste0("<table><tr><td>Year:</td><td>",Time,"</td></tr><tr><td>Value:  </td><td>",round(Value,3),"</td></tr></table>")) %>% 
  ggplot(aes(x = Time, 
            y = Value, color = Var, group = Var,
                 tooltip = tooltip,
                 data_id = Time)) +
  geom_line()+
  {if(interactive) geom_point_interactive(size = 0)
    else geom_line()} +
    scale_color_manual(values = 
                         c("Regime mean" = "#b2df8a",
                         "Trend" = "#a6cee3",
                         "Series" = "#1f78b4"))+
    theme_minimal() +
    theme(legend.title = element_blank()) +
    ylab("Temperature (Â°C)") +
    ggtitle(fall_title)

if (interactive){
  girafe_options(girafe(code = print(fall_surface_temp_plt), width = 0.9,
         height_svg = 2.5),opts_hover(css = "r:2pt;") )
} else {
  fall_surface_temp_plt
}
```



# Salinity

{{SalinityStart}}
An optimal interpolation procedure was used to estimate NE Shelf surface and bottom salinity for two seasonal time frames (see [methods](#methodstempsalin)). Though collected with temperature data, reliable instrumentation limits this time series to 1992-2018. The salinity estimates were standardized to April 3 and October 11 for spring and fall. Surface and bottom salinities within the `r common_name` stock areas are shown below.
{{SalinityEnd}}

## Bottom Salinity

{{BottomSalinityStart}}
{{BottomSalinityEnd}}


```{r bot_sal_process}
spring_bottom_sal <- 
  stars_to_series(r = "bot_sal_spring_spdf.rdata",
                stock_name = stock_name, 
                common_name = common_name, 
                stock_season = stock_season,
                data_season = "spring",
                measure_name = "bottom_sal") %>% 
  mutate(season = "Spring") %>% 
  ecotrend::glsMs(Mean ~ Time,
                data = .,
                diagnostic = T,
                fit_model  = T)

STARS_in <- spring_bottom_sal$fit %>% 
  dplyr::select(-fit) %>% 
  as.matrix()

if (spring_bottom_sal$`selection summary`$pval[1] < 0.05){
  spring_mod <- spring_bottom_sal$model

  spring_bottom_sal <- spring_bottom_sal$fit %>% 
      dplyr::select(Time = time, 
                Series = series,
                Trend = fit)
  
  summ_ <- gls_summary(mod = spring_mod)
  trend <- summ_$Value[1]
  lci <- summ_$Value[2]
  uci <- summ_$Value[3]
  
  spring_title <- sprintf("Spring Trend: %s CI: (%s, %s)", trend, lci, uci)
  
} else {
    spring_bottom_sal <- spring_bottom_sal$fit %>% 
      dplyr::select(Time = time, 
                Series = series)
    
  spring_title <- "Spring"
}

spring_bottom_sal %<>%
  left_join(.,STARS(mat.in = STARS_in),by = "Time") %>% 
  dplyr::select(-Data, -RSI, -Regime.Number,
                `Regime mean` = Regime.Mean) %>% 
  dplyr::select(which(sapply(.,var)!=0))

spring_min <- min(spring_bottom_sal$Time)

fall_bottom_sal <- 
  stars_to_series(r = "bot_sal_fall_spdf.rdata",
               stock_name = stock_name, 
               common_name = common_name, 
               stock_season = stock_season,
               data_season = "fall",
                measure_name = "bottom_sal") %>% 
  mutate(season = "fall") %>% 
  dplyr::distinct() %>% 
  ecotrend::glsMs(Mean ~ Time,
                data = .,
                diagnostic = T,
                fit_model  = T) 



STARS_in <- fall_bottom_sal$fit %>% 
  dplyr::select(-fit) %>% 
  as.matrix()

if (fall_bottom_sal$`selection summary`$pval[1] < 0.05){
fall_mod <- fall_bottom_sal$model

  fall_bottom_sal <- fall_bottom_sal$fit %>% 
      dplyr::select(Time = time, 
                Series = series,
                Trend = fit)
  
  summ_ <- gls_summary(mod = fall_mod)
  trend <- summ_$Value[1]
  lci <- summ_$Value[2]
  uci <- summ_$Value[3]
  
  fall_title <- sprintf("Fall Trend: %s CI: (%s, %s)", trend, lci, uci)
  
} else {
    fall_bottom_sal <- fall_bottom_sal$fit %>% 
      dplyr::select(Time = time, 
                Series = series)
  
    fall_title <- "Fall"
  
}

fall_bottom_sal %<>%
  left_join(.,STARS(mat.in = STARS_in),by = "Time") %>% 
  dplyr::select(-Data, -RSI, -Regime.Number,
                `Regime mean` = Regime.Mean) %>% 
  dplyr::select(which(sapply(.,var)!=0))

fall_min <- min(fall_bottom_sal$Time)

if (fall_min > spring_min) {
  plot_min <- spring_min
} else {
  plot_min <- fall_min
}
```


```{r bot_sal_spring_plt, fig.height=3}

spring_bottom_sal_plt <- 
  spring_bottom_sal %>% 
    tidyr::gather(Var, Value, -Time) %>% 
  mutate(tooltip = paste0("<table><tr><td>Year:</td><td>",Time,"</td></tr><tr><td>Value:  </td><td>",round(Value,3),"</td></tr></table>")) %>% 
  ggplot(aes(x = Time, 
            y = Value, color = Var, group = Var,
                 tooltip = tooltip,
                 data_id = Time)) +
  geom_line()+
  {if(interactive) geom_point_interactive(size = 0)
    else geom_line()} +
    scale_color_manual(values = 
                         c("Regime mean" = "#b2df8a",
                         "Trend" = "#a6cee3",
                         "Series" = "#1f78b4"))+
    theme_minimal() +
    theme(legend.title = element_blank()) +
    ylab("Salinity (PSU)") +
    ggtitle(spring_title)

if (interactive){
  girafe_options(girafe(code = print(spring_bottom_sal_plt), width = 0.9,
         height_svg = 2.5),opts_hover(css = "r:2pt;") )
} else {
  spring_bottom_sal_plt
}
```


```{r bot_sal_fall_plt, fig.height=3}

fall_bottom_sal_plt <- 
  fall_bottom_sal %>% 
    tidyr::gather(Var, Value, -Time) %>% 
  mutate(tooltip = paste0("<table><tr><td>Year:</td><td>",Time,"</td></tr><tr><td>Value:  </td><td>",round(Value,3),"</td></tr></table>")) %>% 
  ggplot(aes(x = Time, 
            y = Value, color = Var, group = Var,
                 tooltip = tooltip,
                 data_id = Time)) +
  geom_line()+
  {if(interactive) geom_point_interactive(size = 0)
    else geom_line()} +
    scale_color_manual(values = 
                         c("Regime mean" = "#b2df8a",
                         "Trend" = "#a6cee3",
                         "Series" = "#1f78b4"))+
    theme_minimal() +
    theme(legend.title = element_blank()) +
    ylab("Salinity (PSU)") +
    ggtitle(fall_title)

if (interactive){
  girafe_options(girafe(code = print(fall_bottom_sal_plt), width = 0.9,
         height_svg = 2.5),opts_hover(css = "r:2pt;") )
} else {
  fall_bottom_sal_plt
}
```


## Surface Salinity {-#surface-salinity}

{{SurfaceSalinityStart}}
{{SurfaceSalinityEnd}}


```{r surf_sal_process}
spring_surface_sal <- 
  stars_to_series(r = "surf_sal_spring_spdf.rdata",
                stock_name = stock_name, 
                common_name = common_name, 
                stock_season = stock_season,
                data_season = "spring",
                measure_name = "surface_sal") %>% 
  mutate(season = "Spring") %>% 
  ecotrend::glsMs(Mean ~ Time,
                data = .,
                diagnostic = T,
                fit_model  = T) 

STARS_in <- spring_surface_sal$fit %>% 
  dplyr::select(-fit) %>% 
  as.matrix()

if (spring_surface_sal$`selection summary`$pval[1] < 0.05){
  spring_mod <- spring_surface_sal$model
  
  
  spring_surface_sal <- spring_surface_sal$fit %>% 
      dplyr::select(Time = time, 
                Series = series,
                Trend = fit)
  


  summ_ <- gls_summary(mod = spring_mod)
  trend <- summ_$Value[1]
  lci <- summ_$Value[2]
  uci <- summ_$Value[3]
  
  spring_title <- sprintf("Spring Trend: %s CI: (%s, %s)", trend, lci, uci)
} else {
    spring_surface_sal <- spring_surface_sal$fit %>% 
      dplyr::select(Time = time, 
                Series = series)
      spring_title <- "Spring"

}

spring_surface_sal %<>%
  left_join(.,STARS(mat.in = STARS_in),by = "Time") %>% 
  dplyr::select(-Data, -RSI, -Regime.Number,
                `Regime mean` = Regime.Mean) %>% 
  dplyr::select(which(sapply(.,var)!=0))

spring_min <- min(spring_surface_sal$Time)

fall_surface_sal <- 
  stars_to_series(r = "surf_sal_fall_spdf.rdata",
                stock_name = stock_name, 
                common_name = common_name, 
                stock_season = stock_season,
                data_season = "fall",
                measure_name = "surface_sal") %>% 
  mutate(season = "fall") %>% 
  dplyr::distinct() %>% 
  ecotrend::glsMs(Mean ~ Time,
                data = .,
                diagnostic = T,
                fit_model  = T) 

STARS_in <- fall_surface_sal$fit %>% 
  dplyr::select(-fit) %>% 
  as.matrix()

if (fall_surface_sal$`selection summary`$pval[1] < 0.05){
  fall_mod <- fall_surface_sal$model
  
  fall_surface_sal <- fall_surface_sal$fit %>% 
      dplyr::select(Time = time, 
                Series = series,
                Trend = fit)
  
  
  summ_ <- gls_summary(mod = fall_mod)
  trend <- summ_$Value[1]
  lci <- summ_$Value[2]
  uci <- summ_$Value[3]
  
  fall_title <- sprintf("Fall Trend: %s CI: (%s, %s)", trend, lci, uci)
} else {
    fall_surface_sal <- fall_surface_sal$fit %>% 
      dplyr::select(Time = time, 
                Series = series)
    fall_title <- "Fall"
}

fall_surface_sal %<>%
  left_join(.,STARS(mat.in = STARS_in),by = "Time") %>% 
  dplyr::select(-Data, -RSI, -Regime.Number,
                `Regime mean` = Regime.Mean) %>% 
  dplyr::select(which(sapply(.,var)!=0))

fall_min <- min(fall_surface_sal$Time)

if (fall_min > spring_min) {
  plot_min <- spring_min
} else {
  plot_min <- fall_min
}
```


```{r surf_sal_spring_plt, fig.height=3}
spring_surface_sal_plt <- 
  spring_surface_sal %>% 
    tidyr::gather(Var, Value, -Time) %>% 
  mutate(tooltip = paste0("<table><tr><td>Year:</td><td>",Time,"</td></tr><tr><td>Value:  </td><td>",round(Value,3),"</td></tr></table>")) %>% 
  ggplot(aes(x = Time, 
            y = Value, color = Var, group = Var,
                 tooltip = tooltip,
                 data_id = Time)) +
  geom_line()+
  {if(interactive) geom_point_interactive(size = 0)
    else geom_line()} +
    scale_color_manual(values = 
                         c("Regime mean" = "#b2df8a",
                         "Trend" = "#a6cee3",
                         "Series" = "#1f78b4"))+
    theme_minimal() +
    theme(legend.title = element_blank()) +
    ylab("Salinity (PSU)") +
    ggtitle(spring_title)

if (interactive){
  girafe_options(girafe(code = print(spring_surface_sal_plt), width = 0.9,
         height_svg = 2.5),opts_hover(css = "r:2pt;") )
} else {
  spring_surface_sal_plt
}
```


```{r surf_sal_fall_plt, fig.height=3}
fall_surface_sal_plt <- 
  fall_surface_sal %>% 
    tidyr::gather(Var, Value, -Time) %>% 
  mutate(tooltip = paste0("<table><tr><td>Year:</td><td>",Time,"</td></tr><tr><td>Value:  </td><td>",round(Value,3),"</td></tr></table>")) %>% 
  ggplot(aes(x = Time, 
            y = Value, color = Var, group = Var,
                 tooltip = tooltip,
                 data_id = Time)) +
  geom_line()+
  {if(interactive) geom_point_interactive(size = 0)
    else geom_line()} +
    scale_color_manual(values = 
                         c("Regime mean" = "#b2df8a",
                         "Trend" = "#a6cee3",
                         "Series" = "#1f78b4"))+
    theme_minimal() +
    theme(legend.title = element_blank()) +
    ylab("Salinity (PSU)") +
    ggtitle(fall_title)

if (interactive){
  girafe_options(girafe(code = print(fall_surface_sal_plt), width = 0.9,
         height_svg = 2.5),opts_hover(css = "r:2pt;") )
} else {
  fall_surface_sal_plt
}
```

# Chlorophyll

{{ChlorophyllStart}}
{{ChlorophyllEnd}}

## Chlorophyll concentration in the stock area {-#chlorophyll-concentration-in-the-stock-area}

{{ChlorophyllConcStart}}
The concentration of chlorophyll was measured with a suite of satellite sensors and merged into a single dataset (see [methods](https://noaa-edab.github.io/ECSA/#sec:methodschl)). Chlorophyll concentrations in the spring and fall `r common_name` stock areas are shown below.
{{ChlorophyllConcEnd}}

```{r chl_processing}
spring_chl <- 
stars_to_series(r = "chlorophyll_conc.rdata",
              stock_name = stock_name, 
              common_name = common_name, 
              stock_season = stock_season,
              data_season = "spring",
                measure_name = "biomass",
                process_to_season = "spring")$spring %>% 
  mutate(season = "Spring") %>% 
    dplyr::distinct() %>% 
  ecotrend::glsMs(Mean ~ Time,
                data = .,
                diagnostic = T,
                fit_model  = T)

STARS_in <- spring_chl$fit %>% 
  dplyr::select(-fit) %>% 
  as.matrix()

if (spring_chl$`selection summary`$pval[1] < 0.05){
  spring_chl <- spring_chl$fit %>% 
      dplyr::select(Time = time, 
                Series = series,
                Trend = fit)
  
  summ_ <- gls_summary(mod = spring_mod)
  trend <- summ_$Value[1]
  lci <- summ_$Value[2]
  uci <- summ_$Value[3]

  spring_title <- sprintf("Spring Trend: %s CI: (%s, %s)", trend, lci, uci)
} else {
    spring_chl <- spring_chl$fit %>% 
      dplyr::select(Time = time, 
                Series = series)
    spring_title <- "Spring"
}

spring_chl %<>%
  left_join(.,STARS(mat.in = STARS_in),by = "Time") %>% 
  dplyr::select(-Data, -RSI, -Regime.Number,
                `Regime mean` = Regime.Mean) %>% 
  dplyr::select(which(sapply(.,var)!=0))

spring_min <- min(spring_chl$Time)

fall_chl <- 
stars_to_series(r = "chlorophyll_conc.rdata",
                stock_name = stock_name, 
                common_name = common_name, 
                stock_season = stock_season,
                data_season = "fall",
                measure_name = "biomass",
                process_to_season = "fall")$fall %>% 
  mutate(season = "fall") %>% 
    dplyr::distinct() %>% 
  ecotrend::glsMs(Mean ~ Time,
                data = .,
                diagnostic = T,
                fit_model  = T)

STARS_in <- fall_chl$fit %>% 
  dplyr::select(-fit) %>% 
  as.matrix()

if (fall_chl$`selection summary`$pval[1] < 0.05){
  fall_mod <- fall_chl$model
  
  fall_chl <- fall_chl$fit %>% 
      dplyr::select(Time = time, 
                Series = series,
                Trend = fit)
  
  summ_ <- gls_summary(mod = fall_mod)
  trend <- summ_$Value[1]
  lci <- summ_$Value[2]
  uci <- summ_$Value[3]
  
  fall_title <- sprintf("Fall Trend: %s CI: (%s, %s)", trend, lci, uci)
  
} else {
    fall_chl <- fall_chl$fit %>% 
      dplyr::select(Time = time, 
                Series = series)
  fall_title <- "Fall"
}

fall_chl %<>%
  left_join(.,STARS(mat.in = STARS_in),by = "Time") %>% 
  dplyr::select(-Data, -RSI, -Regime.Number,
                `Regime mean` = Regime.Mean) %>% 
  dplyr::select(which(sapply(.,var)!=0))

fall_min <- min(fall_chl$Time)



if (fall_min > spring_min) {
  plot_min <- spring_min
} else {
  plot_min <- fall_min
}
```


```{r chl_spring_plt, fig.height=3}
spring_chl_plt <- 
  spring_chl %>% 
    tidyr::gather(Var, Value, -Time) %>% 
  mutate(tooltip = paste0("<table><tr><td>Year:</td><td>",Time,"</td></tr><tr><td>Value:  </td><td>",round(Value,3),"</td></tr></table>")) %>% 
  ggplot(aes(x = Time, 
            y = Value, color = Var, group = Var,
                 tooltip = tooltip,
                 data_id = Time)) +
  geom_line()+
  {if(interactive) geom_point_interactive(size = 0)
    else geom_line()} +
    scale_color_manual(values = 
                         c("Regime mean" = "#b2df8a",
                         "Trend" = "#a6cee3",
                         "Series" = "#1f78b4"))+
    theme_minimal() +
    theme(legend.title = element_blank()) +
    ylab(expression(paste("Chlorophyll (mg ", m^{-3}, ")")))+
    ggtitle(spring_title)

if (interactive){
  girafe_options(girafe(code = print(spring_chl_plt), width = 0.9,
         height_svg = 2.5),opts_hover(css = "r:2pt;") )
} else {
  spring_chl_plt
}
```


```{r chl_fal_plt, fig.height=3}
fall_chl_plt <- 
  fall_chl %>% 
    tidyr::gather(Var, Value, -Time) %>% 
  mutate(tooltip = paste0("<table><tr><td>Year:</td><td>",Time,"</td></tr><tr><td>Value:  </td><td>",round(Value,3),"</td></tr></table>")) %>% 
  ggplot(aes(x = Time, 
            y = Value, color = Var, group = Var,
                 tooltip = tooltip,
                 data_id = Time)) +
  geom_line()+
  {if(interactive) geom_point_interactive(size = 0)
    else geom_line()} +
    scale_color_manual(values = 
                         c("Regime mean" = "#b2df8a",
                         "Trend" = "#a6cee3",
                         "Series" = "#1f78b4"))+
    theme_minimal() +
    theme(legend.title = element_blank()) +
    ylab(expression(paste("Chlorophyll (mg ", m^{-3}, ")")))+
    ggtitle(fall_title)

if (interactive){
  girafe_options(girafe(code = print(fall_chl_plt), width = 0.9,
         height_svg = 2.5),opts_hover(css = "r:2pt;") )
} else {
  fall_chl_plt
}
```


# Zooplankton

{{ZooplanktonStart}}
{{ZooplanktonEnd}}


## Copepod abundance {-#copepod-abundance}

{{CopepodStart}}
{{CopepodEnd}}

```{r zoo_cope_spring, fig.height=5}
spring_cope <- stars_to_series(r <- "zoo_spring_rasters_1yr.rdata",
                stock_name = stock_name, 
                common_name = common_name, 
                stock_season = stock_season,
                data_season = "spring",
                measure_name = "zoo",
                group_regex = "[^A-Z_](.*)(?=_)") %>% 
  mutate(season = "spring") %>% 
  left_join(.,zoo_lookup, by = "Grouping") %>% 
  dplyr::filter(copepod == "y") %>% 
  dplyr::select(-Grouping, -season, -copepod) %>%
  tidyr::spread(full_name, Mean)

if (interactive){
  buttons <- create_buttons(spring_cope)

spring_cope_plt <-
  tab_plotly(spring_cope, add_smoother = F, showlegend = F) %>% 
  layout(title = "Spring copepod abundance",
         yaxis = list(title = "Abundance (log num m<sup>-3</sup>)",
                      hoverformat = '.3f', mirror = TRUE, showline = TRUE),
         xaxis = list(title = "", mirror = TRUE, showline = TRUE),
         updatemenus = 
        
        list(
           list(
            buttons = list(buttons[[1]],buttons[[2]],buttons[[3]]),
                      type = "buttons",
                      direction = "right",
                      xanchor = "center",
                      yanchor = "top",
                      pad = list("r"= 0, "t"= 10, "b" = 10),
                      x = 0.5,
                      y = -0.2
                      ),
          list(
           buttons = list(buttons[[4]],buttons[[5]],buttons[[6]]),
                      type = "buttons",
                      direction = "right",
                      xanchor = "center",
                      yanchor = "top",
                      pad = list("r"= 0, "t"= 10, "b" = 10),
                      x = 0.5,
                      y = -0.3
                      ),
          list(
           buttons = list(buttons[[7]],buttons[[8]]),
                      type = "buttons",
                      direction = "right",
                      xanchor = "center",
                      yanchor = "top",
                      pad = list("r"= 0, "t"= 10, "b" = 10),
                      x = 0.5,
                      y = -0.4
                      )
                     )
                    )

spring_cope_plt
  
} else {
  spring_cope %>% 
    tidyr::gather(Var, Value, -Time) %>% 
    ggplot() +
    geom_line(aes(x = Time, y = Value, group = Var)) +
    facet_wrap(Var~., scales = "free_y") +
    theme_minimal() +
    ylab(expression(paste("Abundance (log num ", m^{-3}, ")"))) +
    theme(strip.text = element_text(face = "italic")) +
    ggtitle("Spring copepod abundance")
}


```


```{r zoo_cope_fall, fig.height=5}
fall_cope <- stars_to_series(r <- "zoo_fall_rasters_1yr.rdata",
                stock_name = stock_name, 
                common_name = common_name, 
                stock_season = stock_season,
                data_season = "fall",
                measure_name = "zoo",
                group_regex = "[^A-Z_](.*)(?=_)") %>% 
  mutate(season = "fall") %>% 
  left_join(.,zoo_lookup, by = "Grouping") %>% 
  dplyr::filter(copepod == "y") %>% 
  dplyr::select(-Grouping, -season, -copepod) %>%
  tidyr::spread(full_name, Mean)

if (interactive){
  buttons <- create_buttons(fall_cope)

fall_cope_plt <-
  tab_plotly(fall_cope, add_smoother = F, showlegend = F) %>% 
  layout(title = "Fall copepod abundance",
         yaxis = list(title = "Abundance (log num m<sup>-3</sup>)",
                      hoverformat = '.3f', mirror = TRUE, showline = TRUE),
         xaxis = list(title = "", mirror = TRUE, showline = TRUE),
         updatemenus = 
        
        list(
           list(
            buttons = list(buttons[[1]],buttons[[2]],buttons[[3]]),
                      type = "buttons",
                      direction = "right",
                      xanchor = "center",
                      yanchor = "top",
                      pad = list("r"= 0, "t"= 10, "b" = 10),
                      x = 0.5,
                      y = -0.2
                      ),
          list(
           buttons = list(buttons[[4]],buttons[[5]],buttons[[6]]),
                      type = "buttons",
                      direction = "right",
                      xanchor = "center",
                      yanchor = "top",
                      pad = list("r"= 0, "t"= 10, "b" = 10),
                      x = 0.5,
                      y = -0.3
                      ),
          list(
           buttons = list(buttons[[7]],buttons[[8]]),
                      type = "buttons",
                      direction = "right",
                      xanchor = "center",
                      yanchor = "top",
                      pad = list("r"= 0, "t"= 10, "b" = 10),
                      x = 0.5,
                      y = -0.4
                      )
                     )
                    )

fall_cope_plt
  
} else {
  fall_cope %>% 
    tidyr::gather(Var, Value, -Time) %>% 
    ggplot() +
    geom_line(aes(x = Time, y = Value, group = Var)) +
    facet_wrap(Var~., scales = "free_y") +
    theme_minimal() +
    ylab(expression(paste("Abundance (log num ", m^{-3}, ")"))) +
    theme(strip.text = element_text(face = "italic"))+
    ggtitle("Fall copepod abundance")
}

```

## Non-copepod zooplankton abundance

{{NonCopepodStart}}
{{NonCopepodEnd}}


```{r zoo_spring_noncope, fig.height=5}
spring_noncope <- stars_to_series(r <- "zoo_spring_rasters_1yr.rdata",
                stock_name = stock_name, 
                common_name = common_name, 
                stock_season = stock_season,
                data_season = "spring",
                measure_name = "zoo",
                group_regex = "[^A-Z_](.*)(?=_)") %>% 
  mutate(season = "spring") %>% 
  left_join(.,zoo_lookup, by = "Grouping") %>% 
  dplyr::filter(copepod == "n") %>% 
  dplyr::select(-Grouping, -season, -copepod) %>%
  tidyr::spread(full_name, Mean)

if (interactive){

buttons <- create_buttons(spring_noncope)

spring_noncope_plt <-
  tab_plotly(spring_noncope, add_smoother = F, showlegend = F) %>% 
  layout(title = "Spring non-copepod zoo. abundance",
         yaxis = list(title = "Abundance (log num m<sup>-3</sup>)",
                      hoverformat = '.3f', mirror = TRUE, showline = TRUE),
         showlegend = F,
         updatemenus = 
        
        list(
           list(
            buttons = list(buttons[[1]],buttons[[2]],buttons[[3]],buttons[[4]]),
                      type = "buttons",
                      direction = "right",
                      xanchor = "center",
                      yanchor = "top",
                      pad = list("r"= 0, "t"= 10, "b" = 10),
                      x = 0.5,
                      y = -0.2
                      ),
          list(
           buttons = list(buttons[[5]],buttons[[6]],buttons[[7]]),
                      type = "buttons",
                      direction = "right",
                      xanchor = "center",
                      yanchor = "top",
                      pad = list("r"= 0, "t"= 10, "b" = 10),
                      x = 0.5,
                      y = -0.3
                      ),
          list(
           buttons = list(buttons[[8]],buttons[[9]],buttons[[10]]),
                      type = "buttons",
                      direction = "right",
                      xanchor = "center",
                      yanchor = "top",
                      pad = list("r"= 0, "t"= 10, "b" = 10),
                      x = 0.5,
                      y = -0.4
                      )
                     )
                    )

spring_noncope_plt

} else {
  
  spring_noncope %>% 
    tidyr::gather(Var, Value, -Time) %>% 
    ggplot() +
    geom_line(aes(x = Time, y = Value, group = Var)) +
    facet_wrap(Var~., scales = "free_y") +
    theme_minimal() +
    ylab(expression(paste("Abundance (log num ", m^{-3}, ")"))) +
    theme(strip.text = element_text(face = "italic"))+
    ggtitle("Spring non-copepod zoo. abundance")
}
```

```{r zoo_fall_noncope, fig.height=5}
fall_noncope <- stars_to_series(r <- "zoo_fall_rasters_1yr.rdata",
                stock_name = stock_name, 
                common_name = common_name, 
                stock_season = stock_season,
                data_season = "fall",
                measure_name = "zoo",
                group_regex = "[^A-Z_](.*)(?=_)") %>% 
  mutate(season = "fall") %>% 
  left_join(.,zoo_lookup, by = "Grouping") %>% 
  dplyr::filter(copepod == "n") %>% 
  dplyr::select(-Grouping, -season, -copepod) %>%
  tidyr::spread(full_name, Mean)

if (interactive){

buttons <- create_buttons(fall_noncope)

fall_noncope_plt <-
  tab_plotly(fall_noncope, add_smoother = F, showlegend = F) %>% 
  layout(title = "Fall non-copepod zoo. abundance",
         yaxis = list(title = "Abundance (log num m<sup>-3</sup>)",
                      hoverformat = '.3f', mirror = TRUE, showline = TRUE),
         showlegend = F,
         updatemenus = 
        
        list(
           list(
            buttons = list(buttons[[1]],buttons[[2]],buttons[[3]],buttons[[4]]),
                      type = "buttons",
                      direction = "right",
                      xanchor = "center",
                      yanchor = "top",
                      pad = list("r"= 0, "t"= 10, "b" = 10),
                      x = 0.5,
                      y = -0.2
                      ),
          list(
           buttons = list(buttons[[5]],buttons[[6]],buttons[[7]]),
                      type = "buttons",
                      direction = "right",
                      xanchor = "center",
                      yanchor = "top",
                      pad = list("r"= 0, "t"= 10, "b" = 10),
                      x = 0.5,
                      y = -0.3
                      ),
          list(
           buttons = list(buttons[[8]],buttons[[9]],buttons[[10]]),
                      type = "buttons",
                      direction = "right",
                      xanchor = "center",
                      yanchor = "top",
                      pad = list("r"= 0, "t"= 10, "b" = 10),
                      x = 0.5,
                      y = -0.4
                      )
                     )
                    )

fall_noncope_plt

} else {
  
  fall_noncope %>% 
    tidyr::gather(Var, Value, -Time) %>% 
    ggplot() +
    geom_line(aes(x = Time, y = Value, group = Var)) +
    facet_wrap(Var~., scales = "free_y") +
    theme_minimal() +
    ylab(expression(paste("Abundance (log num ", m^{-3}, ")"))) +
    theme(strip.text = element_text(face = "italic")) +
    ggtitle("Fall non-copepod zoo. abundance")
}
```


# Habitat and abundance

{{HabitatStart}}
{{HabitatEnd}}

## Occurrence probability {-#occurrence-probability}

{{OccurrenceStart}}
The probability of occurrence was estimated using random forest classification models (see [methods](#methods)). The mean annual probabilities were extracted for the spring and fall stock definition areas. These data provide an estimate of the potential use of the habitat associated with the stock definition.
{{OccurrenceEnd}}

```{r occ_prob, fig.height=4}
spring_occ_prob <- 
  stars_to_series(r = "occurrence_prob_spring.rdata",
                stock_name = stock_name, 
                common_name = common_name, 
                stock_season = stock_season,
                data_season = "spring",
                measure_name = "occurrence") %>% 
  dplyr::select(Spring = Mean,
                Time)

fall_occ_prob <- 
  stars_to_series(r = "occurrence_prob_fall.rdata",
                stock_name = stock_name, 
                common_name = common_name, 
                stock_season = stock_season,
                data_season = "fall",
                measure_name = "occurrence") %>% 
  dplyr::select(Fall = Mean,
                Time)

occ_prob <- spring_occ_prob %>% 
  left_join(.,fall_occ_prob, by  = "Time") %>% 
  dplyr::select(Time, Spring, Fall)

occ_prob_plt <- 
  occ_prob %>% 
    tidyr::gather(Var, Value, -Time) %>% 
  mutate(tooltip = paste0("<table><tr><td>Year:</td><td>",Time,"</td></tr><tr><td>Value:  </td><td>",round(Value,3),"</td></tr></table>")) %>% 
  ggplot(aes(x = Time, 
            y = Value, color = Var, group = Var,
                 tooltip = tooltip,
                 data_id = Time)) +
  geom_line()+
  {if(interactive) geom_point_interactive(size = 0)
    else geom_line()} +
    scale_color_manual(values = 
                         c("Fall" = "#a6cee3",
                         "Spring" = "#1f78b4"))+
    theme_minimal() +
    theme(legend.title = element_blank()) +
    ylab("Occupancy probability")+
    ggtitle("Occupancy probability")

if (interactive){
  girafe_options(girafe(code = print(occ_prob_plt), width = 0.9,
         height_svg = 2.5),opts_hover(css = "r:2pt;") )
} else {
  occ_prob_plt
}
```

## Habitat area {-#habitat-area}

{{HabitatAreaStart}}
{{HabitatAreaEnd}}


### Stock area  {-#stock-area}

{{StockAreaStart}}
{{StockAreaEnd}}


```{r stock_hab_area, fig.height=4}

```

### Ecosystem {-#ecosystem}

{{EcosystemAreaStart}}
{{EcosystemAreaEnd}}

```{r ecosys_hab_area, fig.height=4}

```

## Minimum Population Size {-#minimum-population-size}

```{r sae_processing, eval = T}

{{MinPopulationStart}}
{{MinPopulationEnd}}

do_transform <- T

fall_sae_processed <- fall_sae %>% 
  dplyr::select(-svspp) %>% 
  dplyr::rename(Time = year) %>% 
  dplyr::select(-ztotal) %>%
  mutate(total = ifelse(ciflag < 0 , NA, total),
         lowerci =ifelse(ciflag < 0 , NA, lowerci),
         upperci =ifelse(ciflag < 0 , NA, upperci)) %>% 
  mutate(Treatment = as.factor(treatment),
          total_log10 = log10(total),
         upperci_log10 = log10(upperci),
         lowerci_log10 = log10(lowerci),
         biomass = ifelse(biomass == "yes","Biomass","Abundance")) %>% 
  dplyr::select(-treatment) %>% 
  mutate(tooltip_log10 = paste0("<table><tr><td>Year:</td><td>",Time,"</td></tr><tr><td>Value:  </td><td>",round(total_log10,3),"</td></tr></table>"),
         tooltip = paste0("<table><tr><td>Year:</td><td>",Time,"</td></tr><tr><td>Value:  </td><td>",round(total,3),"</td></tr></table>"))

spring_sae_processed <- spring_sae %>% 
  dplyr::select(-svspp) %>% 
  dplyr::rename(Time = year) %>% 
  dplyr::select(-ztotal) %>%
    mutate(total = ifelse(ciflag < 0 , NA, total),
         lowerci =ifelse(ciflag < 0 , NA, lowerci),
         upperci =ifelse(ciflag < 0 , NA, upperci)) %>% 
  mutate(Treatment = as.factor(treatment),
          total_log10 = log10(total),
         upperci_log10 = log10(upperci),
         lowerci_log10 = log10(lowerci),
         biomass = ifelse(biomass == "yes","Biomass","Abundance")) %>% 
  dplyr::select(-treatment) %>% 
  mutate(tooltip_log10 = paste0("<table><tr><td>Year:</td><td>",Time,"</td></tr><tr><td>Value:  </td><td>",round(total_log10,3),"</td></tr></table>"),
         tooltip = paste0("<table><tr><td>Year:</td><td>",Time,"</td></tr><tr><td>Value:  </td><td>",round(total,3),"</td></tr></table>"))
```


### Spring numbers and biomass {-#spring-numbers-and-biomass}
{{SpringHabitatAreaStart}}
{{SpringHabitatAreaEnd}}

```{r spring_sae_plt, fig.height = 6, eval = T}
if (do_transform){
  
biomass_plt <- spring_sae_processed %>% 
    filter(biomass == "Biomass") %>% 
    ggplot(aes(x = Time, 
            y = total_log10, color = Treatment, group = Treatment)) +
     geom_line() +
       geom_ribbon(aes(x = Time, ymax = upperci_log10,
                     ymin = lowerci_log10, fill = Treatment), alpha = 0.1) +
     {if(interactive) geom_point_interactive(aes(tooltip = tooltip_log10, data_id = Time))
       else geom_point() } +

     theme_minimal() +
     guides(color = F, fill = F) +
     scale_x_continuous(expand = c(0.01, 0.01)) +
     ylab("Biomass (log10 kg)") +
     xlab("")

abundance_plt <- spring_sae_processed %>% 
    filter(biomass == "Abundance") %>% 
   ggplot(aes(x = Time, 
            y = total_log10, color = Treatment, group = Treatment)) +
     geom_line() +
       geom_ribbon(aes(x = Time, ymax = upperci_log10,
                     ymin = lowerci_log10, fill = Treatment), alpha = 0.1) +
     {if(interactive) geom_point_interactive(aes(tooltip = tooltip_log10, data_id = Time))
       else geom_point() } +
     theme_minimal() +
     theme(legend.position = "bottom") +
     scale_x_continuous(expand = c(0.01, 0.01)) +
     ylab("Abundance (log10 N)")

  } else {
    
biomass_plt <- spring_sae_processed %>% 
    filter(biomass == "Biomass") %>% 
   ggplot(aes(x = Time, 
            y = total, color = Treatment, group = Treatment)) +
     geom_line() +
       geom_ribbon(aes(x = Time, ymax = upperci,
                     ymin = lowerci, fill = Treatment), alpha = 0.1) +
     {if(interactive) geom_point_interactive(aes(tooltip = tooltip, data_id = Time))
       else geom_point() } +
     theme_minimal() +
     guides(color = F, fill = F) +
     scale_x_continuous(expand = c(0.01, 0.01)) +
     ylab("Biomass (kg)") +
     xlab("")

abundance_plt <- spring_sae_processed %>% 
    filter(biomass == "Abundance") %>% 
   ggplot(aes(x = Time, 
            y = total, color = Treatment, group = Treatment)) +
     geom_line() +
       geom_ribbon(aes(x = Time, ymax = upperci,
                     ymin = lowerci, fill = Treatment), alpha = 0.1) +
     {if(interactive) geom_point_interactive(aes(tooltip = tooltip, data_id = Time))
       else geom_point() } +
     theme_minimal() +
     theme(legend.position = "bottom") +
     scale_x_continuous(expand = c(0.01, 0.01)) +
     ylab("Abundance (N)")
  }

if (interactive){
  title <- cowplot::ggdraw() +
    cowplot::draw_label("Spring biomass & abundance",x = 0.25)

  girafe_options(girafe(code = print(title + biomass_plt +
                                       abundance_plt + plot_layout(nrow = 3)),
                        width = 0.9, height_svg = 5),opts_hover(css = "r:2pt;") )
  
} else {
  title <- cowplot::ggdraw() +
    cowplot::draw_label("Spring biomass & abundance",x = 0.25)

  cowplot::plot_grid(title, biomass_plt, abundance_plt,ncol=1, rel_heights=c(0.1, 1,1))
}

```


### Fall numbers and biomass {-#fall-numbers-and-biomass}
{{FallHabitatAreaStart}}
{{FallHabitatAreaEnd}}

```{r fall_sae_plt, fig.height = 6, eval = T}
if (do_transform){
  
biomass_plt <- fall_sae_processed %>% 
    filter(biomass == "Biomass") %>% 
    ggplot(aes(x = Time, 
            y = total_log10, color = Treatment, group = Treatment)) +
     geom_line() +
       geom_ribbon(aes(x = Time, ymax = upperci_log10,
                     ymin = lowerci_log10, fill = Treatment), alpha = 0.1) +
     {if(interactive) geom_point_interactive(aes(tooltip = tooltip_log10, data_id = Time))
       else geom_point() } +

     theme_minimal() +
     guides(color = F, fill = F) +
     scale_x_continuous(expand = c(0.01, 0.01)) +
     ylab("Biomass (log10 kg)") +
     xlab("")

abundance_plt <- fall_sae_processed %>% 
    filter(biomass == "Abundance") %>% 
   ggplot(aes(x = Time, 
            y = total_log10, color = Treatment, group = Treatment)) +
     geom_line() +
       geom_ribbon(aes(x = Time, ymax = upperci_log10,
                     ymin = lowerci_log10, fill = Treatment), alpha = 0.1) +
     {if(interactive) geom_point_interactive(aes(tooltip = tooltip_log10, data_id = Time))
       else geom_point() } +
     theme_minimal() +
     theme(legend.position = "bottom") +
     scale_x_continuous(expand = c(0.01, 0.01)) +
     ylab("Abundance (log10 N)")

  } else {
    
biomass_plt <- fall_sae_processed %>% 
    filter(biomass == "Biomass") %>% 
   ggplot(aes(x = Time, 
            y = total, color = Treatment, group = Treatment)) +
     geom_line() +
       geom_ribbon(aes(x = Time, ymax = upperci,
                     ymin = lowerci, fill = Treatment), alpha = 0.1) +
     {if(interactive) geom_point_interactive(aes(tooltip = tooltip, data_id = Time))
       else geom_point() } +
     theme_minimal() +
     guides(color = F, fill = F) +
     scale_x_continuous(expand = c(0.01, 0.01)) +
     ylab("Biomass (kg)") +
     xlab("")

abundance_plt <- fall_sae_processed %>% 
    filter(biomass == "Abundance") %>% 
   ggplot(aes(x = Time, 
            y = total, color = Treatment, group = Treatment)) +
     geom_line() +
       geom_ribbon(aes(x = Time, ymax = upperci,
                     ymin = lowerci, fill = Treatment), alpha = 0.1) +
     {if(interactive) geom_point_interactive(aes(tooltip = tooltip, data_id = Time))
       else geom_point() } +
     theme_minimal() +
     theme(legend.position = "bottom") +
     scale_x_continuous(expand = c(0.01, 0.01)) +
     ylab("Abundance (N)")
  }

if (interactive){
  title <- cowplot::ggdraw() +
    cowplot::draw_label("Fall biomass & abundance",x = 0.25)
  girafe_options(girafe(code = print(title + biomass_plt +
                                       abundance_plt + plot_layout(nrow = 3)),
                        width = 0.9, height_svg = 5),opts_hover(css = "r:2pt;") )
  
} else {
  title <- cowplot::ggdraw() +
    cowplot::draw_label("Fall biomass & abundance",x = 0.25)

  cowplot::plot_grid(title, biomass_plt, abundance_plt,ncol=1, rel_heights=c(0.1, 1,1))
}

```



# Methods {#methods}

## Surface and Bottom Temperature and Salinity {#methodstempsalin}

### Study System
The U.S. Northeast Shelf ecosystem, which roughly aligns with the boundaries of the Northeast U.S. Continental Shelf Large Marine Ecosystem (LME), is the study area for the surface and bottom thermal environments. Surface and bottom temperatures were estimated over a 0.1Â° latitude/longitude grid, termed the estimation grid, which circumscribes the range of ecosystem assessment areas in the [region](#fig:study-area). The difference between the extents of the estimation grid from the extent of the LME relate to the resource management programs that are the sources of the data, which are focused on fishery management needs in the region. 

### Data Source
Temperature and salinity were collected on the Northeast Shelf as part of ongoing resource and ecosystem surveys conducted by the Northeast Fisheries Science Center. Water column temperatures have been collected contemporaneously to trawl tows associated with a bottom trawl survey beginning in the fall of 1963 and five years later during spring [@Despres1988]. In addition, the ecosystem has been surveyed by multiple sampling programs with varying sampling designs. The two most comprehensive monitoring programs over the study period were the MARMAP (1977-1987) and the Ecosystem Monitoring Program or EcoMon (1992-present) programs, both serving as shelf-wide surveys of the ecosystem [@Sherman1998; @Kane2007]. Temperature measurements were made with a mix of Conductivity Temperature and Depth (CTD) instruments, analog XBT, digital XBT, mechanical BT, glass thermometers (bottle temps) and trawl mounted temperature loggers instruments collecting either water column profiles or temperatures  measured at targeted depths. Salinity measurements used in this analysis was limited to 1992-2017 when CTD instrument were used. Surface and bottom temperatures were identified from these measurements. Temperatures representing the spring period include data collected during the months of February to June; however, 99% of the samples were collected during the months of March to May. Likewise, the fall period samples include data collected during September to December, with 99% of the samples collected during September to November. The total number of surface temperature measurements were 14,540 and 14,666 for spring and fall, respectively; and, 14,450 and 14,656 for spring and fall bottom temperature, respectively. On average, there were 290 temperature measurements by season, depth, and year. The number of salinity observation per year were similar.

### Interpolation Procedure
Seasonal surface and bottom temperature fields were estimated using an optimal interpolation approach. The optimal interpolation combined a climatological depiction of temperature and an annual estimates based on the data for a particular depth and season. (There were a number of precursor steps that are described below.). 
The surveys used to collect the data were conducted during the same period each year, however, there was variation in survey timing. To account for this, temperatures were standardized to a collection date of April 3 for spring surveys and October 11 for fall using linear regression for each depth and season over the sample grid (see Appendix, [Figure A1](#fig:doc_correction)). For each depth and season, annual shelf-wide mean temperatures were calculated using the data from sample grid locations with at least 80% of the time series present. The annual observations were then transformed to anomalies by subtracting the appropriate annual mean. All anomalies for a season and depth were combined over years into a single anomaly field or climatology. 

The annual estimate of temperature for a depth and season was imputed by used universal kriging to estimate the temperature over the estimation grid with depth as a covariate. The kriging yielded temperature estimates and a variance estimate over the same grid. The optimal interpolation field was assembled by combining the annual estimate and information from the anomaly climatology. The climatology was re-leveled from anomaly values to temperatures by adding back the appropriate annual mean. For each location in the estimation grid, temperature was calculated as a weighted mean between the kriged annual estimate and the releveled climatology. The weightings in the calculations were partitioned based on the variance field of the annual kriging. The field was divided into quartiles from low to high variance with the weighting ratio of annual:climatology temperatures of 4:1, 3:1, 2:1, and 1:1, respectively. Hence, in areas of low variance the weighted mean was based on a weighting of 4:1, which would reflect a higher contribution of information from the annual estimate and thus be closer to an observation. In areas with high variance, the weighting ratio of 1:1 would reflect a greater effect of the climatology in determining the interpolation estimate. 

The optimal interpolation temperature fields were evaluated using cross validation and a comparison to external data. The performance of optimal interpolation was compared to the predictive skill of using either the climatology or annual interpolation alone by doing ten random cross validations of each treatment. Each random draw of training and test sets sampled 3% of the data for the test set, or about 500 observations per draw. The temperature fields were fit with the training data and compared with the test set data. The lowest error rates were realized with the optimal interpolation contrasted with highest predictive error associated with fields based on the climatology alone (see Appendix, [Figure A2](#fig:cross_val)). The spatial distribution of error had distinct depth and seasonal patterns. The spatial errors associated with the surface estimates were generally low with the exception of a few locations along the shelf break between latitudes 39-41Â°N; the spatial error in the bottom temperature varied by season, and was concentrated along the shelf break in spring and across the shelf between latitudes 36-40Â°N in fall (see Appendix, [Figure A3](#fig:oi_mae)). The optimal interpolation data were also compared to external data from other collection programs. The absolute errors between surface temperature data collected by satellites and the interpolation had interquartile ranges of approximately Â±0.75Â°C (see Appendix, [Figure A4](#fig:oi_compare)). The absolute error in a comparison of interpolated bottom temperature to opportunist sampling was approximately Â±0.75Â°C for spring bottom temperature and approximately 0.75-1.0Â°C in the fall. Salinity was estimated in the same way with the exception of collection correction, which was deemed unnecessary for the salinity data.
=======
>>>>>>> fa6713c0f5e3778fbb7c8f0291e693d208dc5ced

  girafe_options(girafe(code = print(title + biomass_plt +
                                       abundance_plt + plot_layout(nrow = 3)),
                        width = 0.9, height_svg = 5),opts_hover(css = "r:2pt;") )
  
} else {
  title <- cowplot::ggdraw() +
    cowplot::draw_label("Fall biomass & abundance",x = 0.25)

  cowplot::plot_grid(title, biomass_plt, abundance_plt,ncol=1, rel_heights=c(0.1, 1,1))
}

```

# Methods {#methods}

Generic methods will be attached to the document after editing. To view, please go to `r googledrive::drive_link("EDABranch_Drive/Products/ECSA/generic_methods.Rmd")`



