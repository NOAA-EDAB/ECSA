---
title: {{STOCK_NAME}}
always_allow_html: yes
output: 
        html_document:
          fig_caption: yes
---

```{r, include = FALSE}
## Load packages
# library(ecsa)
library(dplyr)
library(ggplot2)
library(plotly)
library(DT)
library(jpeg)
library(patchwork)
library(ggthemes)
library(AICcmodavg)
library(stringr)
library(ecotrend)
library(magrittr)
library(raster)
library(stars)
library(dplyr)
library(here)
library(zoo)
library(gt)
library(ggiraph)

knitr::opts_chunk$set(echo = F, message = F, warning = F, fig.align = 'center')

## Read in stock area vectors

all_stock_season <- readr::read_csv(here::here("data/stock_data/stock_list.csv"),
                                 col_types = readr::cols(
                                   common_name = readr::col_character(),
                                   sci_name = readr::col_character(),
                                   cc_name = readr::col_character(),
                                   stock_name = readr::col_character(),
                                   species_code = readr::col_character(),
                                   svspp = readr::col_double(),
                                   stock_season = readr::col_character(),
                                   strata = readr::col_double()))


#zooplankton lookup table
zoo_lookup <- read.csv(here::here("data-raw/zooplankton_lookup.csv"), stringsAsFactors = F)

## Put all mustaches here
stock_code <- "{{SPECIES_CODE}}"
stock_name <- "{{STOCK_NAME}}"
cc_name <- "{{CC_NAME}}"
common_name <- "{{COMMON_NAME}}"

#Get stock strata and unique identifiers
strata <- all_stock_season %>%   
  dplyr::filter(stringr::str_detect(stock_name, !!stock_name))

if (length(unique(strata$stock_name)) > 1)  {
  strata %<>% 
    tidyr::separate(., stock_name, c("stock_name","sub_area"), "_")

}
  




source(here::here("R/map_strata.R"))
source(here::here("R/get_strata.R"))
source(here::here("R/crop_to_strata.R"))
source(here::here("R/stars_to_series.R"))
source(here::here("R/tab_plotly.R"))
source(here::here("R/create_buttons.R"))
source(here::here("R/STARS_v18.R"))
source(here::here("R/gls_summary.R"))
source(here::here("R/plot_sae.R"))



svspp <- strata %>% pull(svspp) %>% unique()
sixcode <- strata %>% pull(species_code) %>% unique()

#Specific analytical treatments were selected beforehand for each stock. These data are in data-raw/treatment_selection.csv. We import here and filter the below SAE data by treatment selection. 
treatment_selection <- 
  read.csv(here::here("data-raw/treatment-selection.csv"),
                       stringsAsFactors = F) %>% 
  filter(svspp == !!svspp)

#Load swept area estimate data. Filter by svspp code and treatment selection
spring_sae <- read.csv(here::here("data-raw/spring_sae_tb_sum.csv"),
                       stringsAsFactors = F) %>% 
  filter(svspp == !!svspp, treatment %in% unique(treatment_selection$treat))

fall_sae <- read.csv(here::here("data-raw/fall_sae_tb_sum.csv"),
                     stringsAsFactors = F) %>% 
  filter(svspp == !!svspp, treatment %in% unique(treatment_selection$treat))

#Adjust knitr fig height if a facet plot is needed
if (nrow(spring_sae) > 0 & length(unique(spring_sae$stocks)) > 1){
 adjust_for_facet  <- 8
} else if (nrow(spring_sae) > 0 & length(unique(spring_sae$stocks)) > 1){
  adjust_for_facet  <- 8
} else {
  adjust_for_facet  <- 6
}

#Get available seasons for stocks
stock_season <- strata %>% pull(stock_season) %>% unique()

#Get estimates for ecosystem and stock habitat area
ecosystem_habitat_area <- read.csv(here::here("data-raw/sum_ocl_byunit_sprfall.csv"),
                                   stringsAsFactors = F) %>% 
  filter(species.code == sixcode)

stock_habitat_area <- read.csv(here::here("data-raw/sum_ocl_spr and fall.csv"),
                               stringsAsFactors = F)  %>% 
  filter(species.code == sixcode)

#Set interactive to F when pushing a draft document to google drive. Otherwise, the ggiraph figures will render as interactive. Interactive figures should only be used during the creation of the final bookdown document. 
interactive <- F
```

{{READMEStart}}

Welcome to the newest iteration of the Ecosystem Context for Stock Advice product for {{STOCK_SUBAREA}}{{COMMON_NAME}}. You are looking at an intermediate draft that still needs some work. Check out github.com/noaa-edab/ecsa for more information on the build process that moves raw data -> stock-name_draft.rmd/Google Doc template -> stock-name.rmd/.html/.pdf final series of documents. 

Do:

* Change editing mode to "Suggesting" (upper right corner of the Google Docs window, below the "share" button)
* Look at the figures and develop text on how the patterns in the data might be informative to both the assessment and future advice for this stock. 
* Modify the text between the double curly-bracket "mustaches". Anything in these sections will be harvested for the final report. 
* Add citations! If you have a citation to add, put it at the end of the section in BibTeX format (.bib; e.g., [here](https://www2.cs.arizona.edu/~collberg/Teaching/07.231/BibTeX/bibtex.html)). 
* Look at the methods section for completion and questions. For convenience, it is a [google doc](https://drive.google.com/open?id=1bTZs3YL1nc9QzUe3d1mKUjRH9XIfa6ESU8zO9jM5mzk) and will be added to the end of the final document. 

Don't:

* Alter the text in the mustaches! These are highly technical bookmarks that allow us to scrape the text from this google doc into a Rmarkdown (.rmd) file that will be rendered into both .pdf and .html reports. 
* Add new sections. If you want to add a new section, let scott.large@noaa.gov know and he will help you modify the .rmd at a later date.

{{READMEEnd}}


# Introduction

{{IntroductionStart}}

This report provides contextual ecosystem information for {{STOCK_SUBAREA}}{{COMMON_NAME}} (*{{SCI_NAME}}*) on the Northeast U.S. Continental Shelf. Data extractions for spring and fall are confined to the {{COMMON_NAME}} stock area based on respective survey strata sets. The information is intended to span a range of potential factors affecting the productivity and distribution of {{COMMON_NAME}}, including: surface and bottom temperature and salinity, chlorophyll concentrations, indices of habitat, diet composition, and abundance of key zooplankton prey of larval {{COMMON_NAME}}. These factors can be used to qualitatively inform the interpretation of population status and/or quantitatively to improve model responsiveness to ecosystem factors. The range and complexity of ecosystem data makes it unlikely to find the most relevant and comprehensive factor variables with a first evaluation; this process will require an iterative approach of evaluation and feedback. Additional indices can be included to address the needs of the working group.

{{IntroductionEnd}}

### Summary {-#summary}

{{SummaryStart}}
{{SummaryEnd}}

### Stock area {-#stock-area}

```{r strata-map, eval = T, echo = FALSE, fig.cap= "Strata map for {{COMMON_NAME}} (*{{SCI_NAME}}*) on the NE shelf", message = FALSE, warning = FALSE, fig.align='center'}
map_strata(stock_name = stock_name,
           common_name = common_name,
           stock_season = stock_season,
           strata = strata,
           overwrite = FALSE,
           save_plot = FALSE)
```

#### A note on figures {-#a-note-on-figures}

Unless otherwise noted, time series in this document are represented by dark blue lines. Estimates of linear trends and regime shifts are included on plots when found to be significant (p < 0.05), and are shown by green and light blue lines respectively. Trend strengths and confidence intervals are also included in plot titles when trends are present. Trends were modeled using a GLS model selection approach [see @hardison2019 for details].

_Last updated on `r format(Sys.Date(), format = "%B %e %Y")`._

# Temperature

{{TemperatureStart}}

An optimal interpolation procedure was used to estimate NE Shelf surface and bottom temperatures for two seasonal time frames (see [methods](#methodstempsalin)). The temperature estimates were standardized to April 3 and October 11 for spring and fall over the period 1968-2018. Surface and bottom temperature within the `r common_name` stock areas are shown below.

{{TemperatureEnd}}

## Bottom Temperature {-#bottom-temperature}

{{BottomTemperatureStart}}


{{BottomTemperatureEnd}}

```{r bot_temp_process}
spring_bottom_temp <- 
  stars_to_series(r = "bot_temp_spring_spdf.rdata",
                stock_name = stock_name, 
                common_name = common_name,
                stock_season = stock_season,
                data_season = "spring",
                measure_name = "bottom_temp") %>% 
  dplyr::filter(Time >= 1968) %>% 
  mutate(season = "Spring") %>% 
  ecotrend::glsMs(Mean ~ Time,
                data = .,
                diagnostic = T,
                fit_model  = T) 


STARS_in <- spring_bottom_temp$fit %>% 
  dplyr::select(-fit) %>% 
  as.matrix()

if (spring_bottom_temp$`selection summary`$pval[1] < 0.05){
  spring_mod <- spring_bottom_temp$model
  
  spring_bottom_temp <- spring_bottom_temp$fit %>% 
    dplyr::select(Time = time, 
                  Series = series,
                  Trend = fit)
  
  summ_ <- gls_summary(mod = spring_mod)
  trend <- summ_$Value[1]
  lci <- summ_$Value[2]
  uci <- summ_$Value[3]

  spring_title <- sprintf("Spring Trend: %s CI: (%s, %s)", trend, lci, uci)

} else {
    spring_bottom_temp <- spring_bottom_temp$fit %>% 
      dplyr::select(Time = time, 
                Series = series)
    spring_title <- "Spring"
}

spring_bottom_temp %<>%  
  left_join(.,STARS(mat.in = STARS_in),by = "Time") %>% 
  dplyr::select(-Data, -RSI, -Regime.Number,
                `Regime mean` = Regime.Mean) %>% 
  dplyr::select(which(sapply(.,var)!=0))

spring_min <- min(spring_bottom_temp$Time)

fall_bottom_temp <- 
  stars_to_series(r = "bot_temp_fall_spdf.rdata",
               stock_name = stock_name,
               common_name = common_name,
               stock_season = stock_season,
               data_season = "fall",
                measure_name = "bottom_temp") %>% 
  dplyr::filter(Time >= 1968) %>% 
  mutate(season = "fall") %>% 
  dplyr::distinct() %>% 
  ecotrend::glsMs(Mean ~ Time,
                data = .,
                diagnostic = T,
                fit_model  = T) 



STARS_in <- fall_bottom_temp$fit %>% 
  dplyr::select(-fit) %>% 
  as.matrix()

if (fall_bottom_temp$`selection summary`$pval[1] < 0.05){

  fall_mod <- fall_bottom_temp$model
  
  fall_bottom_temp <- fall_bottom_temp$fit %>% 
      dplyr::select(Time = time, 
                Series = series,
                Trend = fit)
  
  summ_ <- gls_summary(mod = fall_mod)
  trend <- summ_$Value[1]
  lci <- summ_$Value[2]
  uci <- summ_$Value[3]
  
  fall_title <- sprintf("Fall Trend: %s CI: (%s, %s)", trend, lci, uci)
} else {
    fall_bottom_temp <- fall_bottom_temp$fit %>% 
      dplyr::select(Time = time, 
                Series = series)
    fall_tile <- "Fall"
}


fall_bottom_temp %<>%
  left_join(.,STARS(mat.in = STARS_in),by = "Time") %>% 
  dplyr::select(-Data, -RSI, -Regime.Number,
                `Regime mean` = Regime.Mean) %>% 
  dplyr::select(which(sapply(.,var)!=0))

fall_min <- min(fall_bottom_temp$Time)

if (fall_min > spring_min) {
  plot_min <- spring_min
} else {
  plot_min <- fall_min
}
```


```{r bot_temp_spring_plt, fig.height=3}

spring_bottom_temp_plt <- 
  spring_bottom_temp %>% 
    tidyr::gather(Var, Value, -Time) %>% 
  mutate(tooltip = paste0("<table><tr><td>Year:</td><td>",Time,"</td></tr><tr><td>Value:  </td><td>",round(Value,3),"</td></tr></table>")) %>% 
  ggplot(aes(x = Time, 
            y = Value, color = Var, group = Var,
                 tooltip = tooltip,
                 data_id = Time)) +
  geom_line()+
  {if(interactive) geom_point_interactive(size = 0)
    else geom_line()} +
    scale_color_manual(values = 
                         c("Regime mean" = "#b2df8a",
                         "Trend" = "#a6cee3",
                         "Series" = "#1f78b4"))+
    theme_bw() +
    theme(legend.title = element_blank()) +
    ylab("Temperature (°C)") +
    ggtitle(spring_title)

if (interactive){
  girafe_options(girafe(code = print(spring_bottom_temp_plt), width = 0.9,
         height_svg = 2.5),opts_hover(css = "r:2pt;") )
} else {
  spring_bottom_temp_plt
}

```


```{r bot_temp_fall_plt, fig.height=3}
fall_bottom_temp_plt <- 
  fall_bottom_temp %>% 
    tidyr::gather(Var, Value, -Time) %>% 
  mutate(tooltip = paste0("<table><tr><td>Year:</td><td>",Time,"</td></tr><tr><td>Value:  </td><td>",round(Value,3),"</td></tr></table>")) %>% 
  ggplot(aes(x = Time, 
            y = Value, color = Var, group = Var,
                 tooltip = tooltip,
                 data_id = Time)) +
  geom_line()+
  {if(interactive) geom_point_interactive(size = 0)
    else geom_line()} +
    scale_color_manual(values = 
                         c("Regime mean" = "#b2df8a",
                         "Trend" = "#a6cee3",
                         "Series" = "#1f78b4"))+
    theme_bw() +
    theme(legend.title = element_blank()) +
    ylab("Temperature (°C)") +
    ggtitle(fall_title)

if (interactive){
  girafe_options(girafe(code = print(fall_bottom_temp_plt), width = 0.9,
         height_svg = 2.5),opts_hover(css = "r:2pt;") )
} else {
  fall_bottom_temp_plt
}

```


## Surface Temperature {-#surface-temperature}

{{SurfaceTemperatureStart}}


{{SurfaceTemperatureEnd}}

```{r surf_temp_process}
spring_surface_temp <- 
  stars_to_series(r = "surf_temp_spring_spdf.rdata",
                stock_name = stock_name,
                common_name = common_name,
                stock_season = stock_season,
                data_season = "spring",
                measure_name = "surface_temp") %>% 
  dplyr::filter(Time >= 1968) %>% 
  mutate(season = "Spring") %>% 
  ecotrend::glsMs(Mean ~ Time,
                data = .,
                diagnostic = T,
                fit_model  = T) 


STARS_in <- spring_surface_temp$fit %>% 
  dplyr::select(-fit) %>% 
  as.matrix()

if (spring_surface_temp$`selection summary`$pval[1] < 0.05){
  spring_mod <- spring_surface_temp$model

  spring_surface_temp <- spring_surface_temp$fit %>% 
      dplyr::select(Time = time, 
                Series = series,
                Trend = fit)
  
  summ_ <- gls_summary(mod = spring_mod)
  trend <- summ_$Value[1]
  lci <- summ_$Value[2]
  uci <- summ_$Value[3]

  spring_title <- sprintf("Spring Trend: %s CI: (%s, %s)", trend, lci, uci)
  
} else {
    spring_surface_temp <- spring_surface_temp$fit %>% 
      dplyr::select(Time = time, 
                Series = series)
    spring_title <- "Spring"
}

spring_surface_temp %<>%  
  left_join(.,STARS(mat.in = STARS_in),by = "Time") %>% 
  dplyr::select(-Data, -RSI, -Regime.Number,
                `Regime mean` = Regime.Mean) %>% 
  dplyr::select(which(sapply(.,var)!=0))

spring_min <- min(spring_surface_temp$Time)

fall_surface_temp <- 
  stars_to_series(r = "surf_temp_fall_spdf.rdata",
                stock_name = stock_name,
                common_name = common_name,
                stock_season = stock_season,
                data_season = "fall",
                measure_name = "surface_temp") %>% 
  dplyr::filter(Time >= 1968) %>% 
  mutate(season = "fall") %>% 
  dplyr::distinct() %>% 
  ecotrend::glsMs(Mean ~ Time,
                data = .,
                diagnostic = T,
                fit_model  = T) 



STARS_in <- fall_surface_temp$fit %>% 
  dplyr::select(-fit) %>% 
  as.matrix()

if (fall_surface_temp$`selection summary`$pval[1] < 0.05){
  fall_mod <- fall_surface_temp$model
  
  fall_surface_temp <- fall_surface_temp$fit %>% 
      dplyr::select(Time = time, 
                Series = series,
                Trend = fit)
  
  summ_ <- gls_summary(mod = fall_mod)
  trend <- summ_$Value[1]
  lci <- summ_$Value[2]
  uci <- summ_$Value[3]
  
  fall_title <- sprintf("Fall Trend: %s CI: (%s, %s)", trend, lci, uci)
} else {
    fall_surface_temp <- fall_surface_temp$fit %>% 
      dplyr::select(Time = time, 
                Series = series)
    fall_title <- "Fall"
}


fall_surface_temp %<>%
  left_join(.,STARS(mat.in = STARS_in),by = "Time") %>% 
  dplyr::select(-Data, -RSI, -Regime.Number,
                `Regime mean` = Regime.Mean) %>% 
  dplyr::select(which(sapply(.,var)!=0))

fall_min <- min(fall_surface_temp$Time)

if (fall_min > spring_min) {
  plot_min <- spring_min
} else {
  plot_min <- fall_min
}
```


```{r surf_temp_spring_plt, fig.height=3}

spring_surface_temp_plt <- 
  spring_surface_temp %>% 
    tidyr::gather(Var, Value, -Time) %>% 
  mutate(tooltip = paste0("<table><tr><td>Year:</td><td>",Time,"</td></tr><tr><td>Value:  </td><td>",round(Value,3),"</td></tr></table>")) %>% 
  ggplot(aes(x = Time, 
            y = Value, color = Var, group = Var,
                 tooltip = tooltip,
                 data_id = Time)) +
  geom_line()+
  {if(interactive) geom_point_interactive(size = 0)
    else geom_line()} +
    scale_color_manual(values = 
                         c("Regime mean" = "#b2df8a",
                         "Trend" = "#a6cee3",
                         "Series" = "#1f78b4"))+
    theme_bw() +
    theme(legend.title = element_blank()) +
    ylab("Temperature (°C)") +
    ggtitle(spring_title)

if (interactive){
  girafe_options(girafe(code = print(spring_surface_temp_plt), width = 0.9,
         height_svg = 2.5),opts_hover(css = "r:2pt;") )
} else {
  spring_surface_temp_plt
}

```

```{r surf_temp_fall_plt, fig.height=3}

fall_surface_temp_plt <- 
  fall_surface_temp %>% 
    tidyr::gather(Var, Value, -Time) %>% 
  mutate(tooltip = paste0("<table><tr><td>Year:</td><td>",Time,"</td></tr><tr><td>Value:  </td><td>",round(Value,3),"</td></tr></table>")) %>% 
  ggplot(aes(x = Time, 
            y = Value, color = Var, group = Var,
                 tooltip = tooltip,
                 data_id = Time)) +
  geom_line()+
  {if(interactive) geom_point_interactive(size = 0)
    else geom_line()} +
    scale_color_manual(values = 
                         c("Regime mean" = "#b2df8a",
                         "Trend" = "#a6cee3",
                         "Series" = "#1f78b4"))+
    theme_bw() +
    theme(legend.title = element_blank()) +
    ylab("Temperature (°C)") +
    ggtitle(fall_title)

if (interactive){
  girafe_options(girafe(code = print(fall_surface_temp_plt), width = 0.9,
         height_svg = 2.5),opts_hover(css = "r:2pt;") )
} else {
  fall_surface_temp_plt
}
```



# Salinity

{{SalinityStart}}

An optimal interpolation procedure was used to estimate NE Shelf surface and bottom salinity for two seasonal time frames (see [methods](#methodstempsalin)). Though collected with temperature data, reliable instrumentation limits this time series to 1992-2018. The salinity estimates were standardized to April 3 and October 11 for spring and fall. Surface and bottom salinities within the `r common_name` stock areas are shown below.

{{SalinityEnd}}

## Bottom Salinity

{{BottomSalinityStart}}


{{BottomSalinityEnd}}


```{r bot_sal_process}
spring_bottom_sal <- 
  stars_to_series(r = "bot_sal_spring_spdf.rdata",
                stock_name = stock_name, 
                common_name = common_name, 
                stock_season = stock_season,
                data_season = "spring",
                measure_name = "bottom_sal") %>% 
  mutate(season = "Spring") %>% 
  ecotrend::glsMs(Mean ~ Time,
                data = .,
                diagnostic = T,
                fit_model  = T)

STARS_in <- spring_bottom_sal$fit %>% 
  dplyr::select(-fit) %>% 
  as.matrix()

if (spring_bottom_sal$`selection summary`$pval[1] < 0.05){
  spring_mod <- spring_bottom_sal$model

  spring_bottom_sal <- spring_bottom_sal$fit %>% 
      dplyr::select(Time = time, 
                Series = series,
                Trend = fit)
  
  summ_ <- gls_summary(mod = spring_mod)
  trend <- summ_$Value[1]
  lci <- summ_$Value[2]
  uci <- summ_$Value[3]
  
  spring_title <- sprintf("Spring Trend: %s CI: (%s, %s)", trend, lci, uci)
  
} else {
    spring_bottom_sal <- spring_bottom_sal$fit %>% 
      dplyr::select(Time = time, 
                Series = series)
    
  spring_title <- "Spring"
}

spring_bottom_sal %<>%
  left_join(.,STARS(mat.in = STARS_in),by = "Time") %>% 
  dplyr::select(-Data, -RSI, -Regime.Number,
                `Regime mean` = Regime.Mean) %>% 
  dplyr::select(which(sapply(.,var)!=0))

spring_min <- min(spring_bottom_sal$Time)

fall_bottom_sal <- 
  stars_to_series(r = "bot_sal_fall_spdf.rdata",
               stock_name = stock_name, 
               common_name = common_name, 
               stock_season = stock_season,
               data_season = "fall",
                measure_name = "bottom_sal") %>% 
  mutate(season = "fall") %>% 
  dplyr::distinct() %>% 
  ecotrend::glsMs(Mean ~ Time,
                data = .,
                diagnostic = T,
                fit_model  = T) 



STARS_in <- fall_bottom_sal$fit %>% 
  dplyr::select(-fit) %>% 
  as.matrix()

if (fall_bottom_sal$`selection summary`$pval[1] < 0.05){
fall_mod <- fall_bottom_sal$model

  fall_bottom_sal <- fall_bottom_sal$fit %>% 
      dplyr::select(Time = time, 
                Series = series,
                Trend = fit)
  
  summ_ <- gls_summary(mod = fall_mod)
  trend <- summ_$Value[1]
  lci <- summ_$Value[2]
  uci <- summ_$Value[3]
  
  fall_title <- sprintf("Fall Trend: %s CI: (%s, %s)", trend, lci, uci)
  
} else {
    fall_bottom_sal <- fall_bottom_sal$fit %>% 
      dplyr::select(Time = time, 
                Series = series)
  
    fall_title <- "Fall"
  
}

fall_bottom_sal %<>%
  left_join(.,STARS(mat.in = STARS_in),by = "Time") %>% 
  dplyr::select(-Data, -RSI, -Regime.Number,
                `Regime mean` = Regime.Mean) %>% 
  dplyr::select(which(sapply(.,var)!=0))

fall_min <- min(fall_bottom_sal$Time)

if (fall_min > spring_min) {
  plot_min <- spring_min
} else {
  plot_min <- fall_min
}
```


```{r bot_sal_spring_plt, fig.height=3}

spring_bottom_sal_plt <- 
  spring_bottom_sal %>% 
    tidyr::gather(Var, Value, -Time) %>% 
  mutate(tooltip = paste0("<table><tr><td>Year:</td><td>",Time,"</td></tr><tr><td>Value:  </td><td>",round(Value,3),"</td></tr></table>")) %>% 
  ggplot(aes(x = Time, 
            y = Value, color = Var, group = Var,
                 tooltip = tooltip,
                 data_id = Time)) +
  geom_line()+
  {if(interactive) geom_point_interactive(size = 0)
    else geom_line()} +
    scale_color_manual(values = 
                         c("Regime mean" = "#b2df8a",
                         "Trend" = "#a6cee3",
                         "Series" = "#1f78b4"))+
    theme_bw() +
    theme(legend.title = element_blank()) +
    ylab("Salinity (PSU)") +
    ggtitle(spring_title)

if (interactive){
  girafe_options(girafe(code = print(spring_bottom_sal_plt), width = 0.9,
         height_svg = 2.5),opts_hover(css = "r:2pt;") )
} else {
  spring_bottom_sal_plt
}
```


```{r bot_sal_fall_plt, fig.height=3}

fall_bottom_sal_plt <- 
  fall_bottom_sal %>% 
    tidyr::gather(Var, Value, -Time) %>% 
  mutate(tooltip = paste0("<table><tr><td>Year:</td><td>",Time,"</td></tr><tr><td>Value:  </td><td>",round(Value,3),"</td></tr></table>")) %>% 
  ggplot(aes(x = Time, 
            y = Value, color = Var, group = Var,
                 tooltip = tooltip,
                 data_id = Time)) +
  geom_line()+
  {if(interactive) geom_point_interactive(size = 0)
    else geom_line()} +
    scale_color_manual(values = 
                         c("Regime mean" = "#b2df8a",
                         "Trend" = "#a6cee3",
                         "Series" = "#1f78b4"))+
    theme_bw() +
    theme(legend.title = element_blank()) +
    ylab("Salinity (PSU)") +
    ggtitle(fall_title)

if (interactive){
  girafe_options(girafe(code = print(fall_bottom_sal_plt), width = 0.9,
         height_svg = 2.5),opts_hover(css = "r:2pt;") )
} else {
  fall_bottom_sal_plt
}
```


## Surface Salinity {-#surface-salinity}

{{SurfaceSalinityStart}}


{{SurfaceSalinityEnd}}


```{r surf_sal_process}
spring_surface_sal <- 
  stars_to_series(r = "surf_sal_spring_spdf.rdata",
                stock_name = stock_name, 
                common_name = common_name, 
                stock_season = stock_season,
                data_season = "spring",
                measure_name = "surface_sal") %>% 
  mutate(season = "Spring") %>% 
  ecotrend::glsMs(Mean ~ Time,
                data = .,
                diagnostic = T,
                fit_model  = T) 

STARS_in <- spring_surface_sal$fit %>% 
  dplyr::select(-fit) %>% 
  as.matrix()

if (spring_surface_sal$`selection summary`$pval[1] < 0.05){
  spring_mod <- spring_surface_sal$model
  
  
  spring_surface_sal <- spring_surface_sal$fit %>% 
      dplyr::select(Time = time, 
                Series = series,
                Trend = fit)
  


  summ_ <- gls_summary(mod = spring_mod)
  trend <- summ_$Value[1]
  lci <- summ_$Value[2]
  uci <- summ_$Value[3]
  
  spring_title <- sprintf("Spring Trend: %s CI: (%s, %s)", trend, lci, uci)
} else {
    spring_surface_sal <- spring_surface_sal$fit %>% 
      dplyr::select(Time = time, 
                Series = series)
      spring_title <- "Spring"

}

spring_surface_sal %<>%
  left_join(.,STARS(mat.in = STARS_in),by = "Time") %>% 
  dplyr::select(-Data, -RSI, -Regime.Number,
                `Regime mean` = Regime.Mean) %>% 
  dplyr::select(which(sapply(.,var)!=0))

spring_min <- min(spring_surface_sal$Time)

fall_surface_sal <- 
  stars_to_series(r = "surf_sal_fall_spdf.rdata",
                stock_name = stock_name, 
                common_name = common_name, 
                stock_season = stock_season,
                data_season = "fall",
                measure_name = "surface_sal") %>% 
  mutate(season = "fall") %>% 
  dplyr::distinct() %>% 
  ecotrend::glsMs(Mean ~ Time,
                data = .,
                diagnostic = T,
                fit_model  = T) 

STARS_in <- fall_surface_sal$fit %>% 
  dplyr::select(-fit) %>% 
  as.matrix()

if (fall_surface_sal$`selection summary`$pval[1] < 0.05){
  fall_mod <- fall_surface_sal$model
  
  fall_surface_sal <- fall_surface_sal$fit %>% 
      dplyr::select(Time = time, 
                Series = series,
                Trend = fit)
  
  
  summ_ <- gls_summary(mod = fall_mod)
  trend <- summ_$Value[1]
  lci <- summ_$Value[2]
  uci <- summ_$Value[3]
  
  fall_title <- sprintf("Fall Trend: %s CI: (%s, %s)", trend, lci, uci)
} else {
    fall_surface_sal <- fall_surface_sal$fit %>% 
      dplyr::select(Time = time, 
                Series = series)
    fall_title <- "Fall"
}

fall_surface_sal %<>%
  left_join(.,STARS(mat.in = STARS_in),by = "Time") %>% 
  dplyr::select(-Data, -RSI, -Regime.Number,
                `Regime mean` = Regime.Mean) %>% 
  dplyr::select(which(sapply(.,var)!=0))

fall_min <- min(fall_surface_sal$Time)

if (fall_min > spring_min) {
  plot_min <- spring_min
} else {
  plot_min <- fall_min
}
```


```{r surf_sal_spring_plt, fig.height=3}
spring_surface_sal_plt <- 
  spring_surface_sal %>% 
    tidyr::gather(Var, Value, -Time) %>% 
  mutate(tooltip = paste0("<table><tr><td>Year:</td><td>",Time,"</td></tr><tr><td>Value:  </td><td>",round(Value,3),"</td></tr></table>")) %>% 
  ggplot(aes(x = Time, 
            y = Value, color = Var, group = Var,
                 tooltip = tooltip,
                 data_id = Time)) +
  geom_line()+
  {if(interactive) geom_point_interactive(size = 0)
    else geom_line()} +
    scale_color_manual(values = 
                         c("Regime mean" = "#b2df8a",
                         "Trend" = "#a6cee3",
                         "Series" = "#1f78b4"))+
    theme_bw() +
    theme(legend.title = element_blank()) +
    ylab("Salinity (PSU)") +
    ggtitle(spring_title)

if (interactive){
  girafe_options(girafe(code = print(spring_surface_sal_plt), width = 0.9,
         height_svg = 2.5),opts_hover(css = "r:2pt;") )
} else {
  spring_surface_sal_plt
}
```


```{r surf_sal_fall_plt, fig.height=3}
fall_surface_sal_plt <- 
  fall_surface_sal %>% 
    tidyr::gather(Var, Value, -Time) %>% 
  mutate(tooltip = paste0("<table><tr><td>Year:</td><td>",Time,"</td></tr><tr><td>Value:  </td><td>",round(Value,3),"</td></tr></table>")) %>% 
  ggplot(aes(x = Time, 
            y = Value, color = Var, group = Var,
                 tooltip = tooltip,
                 data_id = Time)) +
  geom_line()+
  {if(interactive) geom_point_interactive(size = 0)
    else geom_line()} +
    scale_color_manual(values = 
                         c("Regime mean" = "#b2df8a",
                         "Trend" = "#a6cee3",
                         "Series" = "#1f78b4"))+
    theme_bw() +
    theme(legend.title = element_blank()) +
    ylab("Salinity (PSU)") +
    ggtitle(fall_title)

if (interactive){
  girafe_options(girafe(code = print(fall_surface_sal_plt), width = 0.9,
         height_svg = 2.5),opts_hover(css = "r:2pt;") )
} else {
  fall_surface_sal_plt
}
```

# Chlorophyll

{{ChlorophyllStart}}


{{ChlorophyllEnd}}

## Chlorophyll concentration in the stock area {-#chlorophyll-concentration-in-the-stock-area}

{{ChlorophyllConcStart}}

The concentration of chlorophyll was measured with a suite of satellite sensors and merged into a single dataset (see [methods](https://noaa-edab.github.io/ECSA/#sec:methodschl)). Chlorophyll concentrations in the spring and fall `r common_name` stock areas are shown below.

{{ChlorophyllConcEnd}}

```{r chl_processing}
spring_chl <- 
stars_to_series(r = "chlorophyll_conc.rdata",
              stock_name = stock_name, 
              common_name = common_name, 
              stock_season = stock_season,
              data_season = "spring",
                measure_name = "biomass",
                process_to_season = "spring")$spring %>% 
  mutate(season = "Spring") %>% 
    dplyr::distinct() %>% 
  ecotrend::glsMs(Mean ~ Time,
                data = .,
                diagnostic = T,
                fit_model  = T)

STARS_in <- spring_chl$fit %>% 
  dplyr::select(-fit) %>% 
  as.matrix()

if (spring_chl$`selection summary`$pval[1] < 0.05){
  spring_chl <- spring_chl$fit %>% 
      dplyr::select(Time = time, 
                Series = series,
                Trend = fit)
  
  summ_ <- gls_summary(mod = spring_mod)
  trend <- summ_$Value[1]
  lci <- summ_$Value[2]
  uci <- summ_$Value[3]

  spring_title <- sprintf("Spring Trend: %s CI: (%s, %s)", trend, lci, uci)
} else {
    spring_chl <- spring_chl$fit %>% 
      dplyr::select(Time = time, 
                Series = series)
    spring_title <- "Spring"
}

spring_chl %<>%
  left_join(.,STARS(mat.in = STARS_in),by = "Time") %>% 
  dplyr::select(-Data, -RSI, -Regime.Number,
                `Regime mean` = Regime.Mean) %>% 
  dplyr::select(which(sapply(.,var)!=0))

spring_min <- min(spring_chl$Time)

fall_chl <- 
stars_to_series(r = "chlorophyll_conc.rdata",
                stock_name = stock_name, 
                common_name = common_name, 
                stock_season = stock_season,
                data_season = "fall",
                measure_name = "biomass",
                process_to_season = "fall")$fall %>% 
  mutate(season = "fall") %>% 
    dplyr::distinct() %>% 
  ecotrend::glsMs(Mean ~ Time,
                data = .,
                diagnostic = T,
                fit_model  = T)

STARS_in <- fall_chl$fit %>% 
  dplyr::select(-fit) %>% 
  as.matrix()

if (fall_chl$`selection summary`$pval[1] < 0.05){
  fall_mod <- fall_chl$model
  
  fall_chl <- fall_chl$fit %>% 
      dplyr::select(Time = time, 
                Series = series,
                Trend = fit)
  
  summ_ <- gls_summary(mod = fall_mod)
  trend <- summ_$Value[1]
  lci <- summ_$Value[2]
  uci <- summ_$Value[3]
  
  fall_title <- sprintf("Fall Trend: %s CI: (%s, %s)", trend, lci, uci)
  
} else {
    fall_chl <- fall_chl$fit %>% 
      dplyr::select(Time = time, 
                Series = series)
  fall_title <- "Fall"
}

fall_chl %<>%
  left_join(.,STARS(mat.in = STARS_in),by = "Time") %>% 
  dplyr::select(-Data, -RSI, -Regime.Number,
                `Regime mean` = Regime.Mean) %>% 
  dplyr::select(which(sapply(.,var)!=0))

fall_min <- min(fall_chl$Time)



if (fall_min > spring_min) {
  plot_min <- spring_min
} else {
  plot_min <- fall_min
}
```


```{r chl_spring_plt, fig.height=3}
spring_chl_plt <- 
  spring_chl %>% 
    tidyr::gather(Var, Value, -Time) %>% 
  mutate(tooltip = paste0("<table><tr><td>Year:</td><td>",Time,"</td></tr><tr><td>Value:  </td><td>",round(Value,3),"</td></tr></table>")) %>% 
  ggplot(aes(x = Time, 
            y = Value, color = Var, group = Var,
                 tooltip = tooltip,
                 data_id = Time)) +
  geom_line()+
  {if(interactive) geom_point_interactive(size = 0)
    else geom_line()} +
    scale_color_manual(values = 
                         c("Regime mean" = "#b2df8a",
                         "Trend" = "#a6cee3",
                         "Series" = "#1f78b4"))+
    theme_bw() +
    theme(legend.title = element_blank()) +
    ylab(expression(paste("Chlorophyll (mg ", m^{-3}, ")")))+
    ggtitle(spring_title)

if (interactive){
  girafe_options(girafe(code = print(spring_chl_plt), width = 0.9,
         height_svg = 2.5),opts_hover(css = "r:2pt;") )
} else {
  spring_chl_plt
}
```


```{r chl_fal_plt, fig.height=3}
fall_chl_plt <- 
  fall_chl %>% 
    tidyr::gather(Var, Value, -Time) %>% 
  mutate(tooltip = paste0("<table><tr><td>Year:</td><td>",Time,"</td></tr><tr><td>Value:  </td><td>",round(Value,3),"</td></tr></table>")) %>% 
  ggplot(aes(x = Time, 
            y = Value, color = Var, group = Var,
                 tooltip = tooltip,
                 data_id = Time)) +
  geom_line()+
  {if(interactive) geom_point_interactive(size = 0)
    else geom_line()} +
    scale_color_manual(values = 
                         c("Regime mean" = "#b2df8a",
                         "Trend" = "#a6cee3",
                         "Series" = "#1f78b4"))+
    theme_bw() +
    theme(legend.title = element_blank()) +
    ylab(expression(paste("Chlorophyll (mg ", m^{-3}, ")")))+
    ggtitle(fall_title)

if (interactive){
  girafe_options(girafe(code = print(fall_chl_plt), width = 0.9,
         height_svg = 2.5),opts_hover(css = "r:2pt;") )
} else {
  fall_chl_plt
}
```


# Zooplankton

{{ZooplanktonStart}}


{{ZooplanktonEnd}}


## Copepod abundance {-#copepod-abundance}

{{CopepodStart}}


{{CopepodEnd}}

```{r zoo_cope_spring, fig.height=5}
spring_cope <- stars_to_series(r <- "zoo_spring_rasters_1yr.rdata",
                stock_name = stock_name, 
                common_name = common_name, 
                stock_season = stock_season,
                data_season = "spring",
                measure_name = "zoo",
                group_regex = "[^A-Z_](.*)(?=_)") %>% 
  mutate(season = "spring") %>% 
  left_join(.,zoo_lookup, by = "Grouping") %>% 
  dplyr::filter(copepod == "y") %>% 
  dplyr::select(-Grouping, -season, -copepod) %>%
  tidyr::spread(full_name, Mean)

if (interactive){
  buttons <- create_buttons(spring_cope)

spring_cope_plt <-
  tab_plotly(spring_cope, add_smoother = F, showlegend = F) %>% 
  layout(title = "Spring copepod abundance",
         yaxis = list(title = "Abundance (log num m<sup>-3</sup>)",
                      hoverformat = '.3f', mirror = TRUE, showline = TRUE),
         xaxis = list(title = "", mirror = TRUE, showline = TRUE),
         updatemenus = 
        
        list(
           list(
            buttons = list(buttons[[1]],buttons[[2]],buttons[[3]]),
                      type = "buttons",
                      direction = "right",
                      xanchor = "center",
                      yanchor = "top",
                      pad = list("r"= 0, "t"= 10, "b" = 10),
                      x = 0.5,
                      y = -0.2
                      ),
          list(
           buttons = list(buttons[[4]],buttons[[5]],buttons[[6]]),
                      type = "buttons",
                      direction = "right",
                      xanchor = "center",
                      yanchor = "top",
                      pad = list("r"= 0, "t"= 10, "b" = 10),
                      x = 0.5,
                      y = -0.3
                      ),
          list(
           buttons = list(buttons[[7]],buttons[[8]]),
                      type = "buttons",
                      direction = "right",
                      xanchor = "center",
                      yanchor = "top",
                      pad = list("r"= 0, "t"= 10, "b" = 10),
                      x = 0.5,
                      y = -0.4
                      )
                     )
                    )

spring_cope_plt
  
} else {
  spring_cope %>% 
    tidyr::gather(Var, Value, -Time) %>% 
    ggplot() +
    geom_line(aes(x = Time, y = Value, group = Var)) +
    facet_wrap(Var~., scales = "free_y") +
    theme_bw() +
    ylab(expression(paste("Abundance (log num ", m^{-3}, ")"))) +
    theme(strip.text = element_text(face = "italic"),
          strip.background = element_blank()) +
    ggtitle("Spring copepod abundance")
}


```


```{r zoo_cope_fall, fig.height=5}
fall_cope <- stars_to_series(r <- "zoo_fall_rasters_1yr.rdata",
                stock_name = stock_name, 
                common_name = common_name, 
                stock_season = stock_season,
                data_season = "fall",
                measure_name = "zoo",
                group_regex = "[^A-Z_](.*)(?=_)") %>% 
  mutate(season = "fall") %>% 
  left_join(.,zoo_lookup, by = "Grouping") %>% 
  dplyr::filter(copepod == "y") %>% 
  dplyr::select(-Grouping, -season, -copepod) %>%
  tidyr::spread(full_name, Mean)

if (interactive){
  buttons <- create_buttons(fall_cope)

fall_cope_plt <-
  tab_plotly(fall_cope, add_smoother = F, showlegend = F) %>% 
  layout(title = "Fall copepod abundance",
         yaxis = list(title = "Abundance (log num m<sup>-3</sup>)",
                      hoverformat = '.3f', mirror = TRUE, showline = TRUE),
         xaxis = list(title = "", mirror = TRUE, showline = TRUE),
         updatemenus = 
        
        list(
           list(
            buttons = list(buttons[[1]],buttons[[2]],buttons[[3]]),
                      type = "buttons",
                      direction = "right",
                      xanchor = "center",
                      yanchor = "top",
                      pad = list("r"= 0, "t"= 10, "b" = 10),
                      x = 0.5,
                      y = -0.2
                      ),
          list(
           buttons = list(buttons[[4]],buttons[[5]],buttons[[6]]),
                      type = "buttons",
                      direction = "right",
                      xanchor = "center",
                      yanchor = "top",
                      pad = list("r"= 0, "t"= 10, "b" = 10),
                      x = 0.5,
                      y = -0.3
                      ),
          list(
           buttons = list(buttons[[7]],buttons[[8]]),
                      type = "buttons",
                      direction = "right",
                      xanchor = "center",
                      yanchor = "top",
                      pad = list("r"= 0, "t"= 10, "b" = 10),
                      x = 0.5,
                      y = -0.4
                      )
                     )
                    )

fall_cope_plt
  
} else {
  fall_cope %>% 
    tidyr::gather(Var, Value, -Time) %>% 
    ggplot() +
    geom_line(aes(x = Time, y = Value, group = Var)) +
    facet_wrap(Var~., scales = "free_y") +
    theme_bw() +
    ylab(expression(paste("Abundance (log num ", m^{-3}, ")"))) +
        theme(strip.text = element_text(face = "italic"),
          strip.background = element_blank()) +
    ggtitle("Fall copepod abundance")
}

```

## Non-copepod zooplankton abundance

{{NonCopepodStart}}


{{NonCopepodEnd}}


```{r zoo_spring_noncope, fig.height=5}
spring_noncope <- stars_to_series(r <- "zoo_spring_rasters_1yr.rdata",
                stock_name = stock_name, 
                common_name = common_name, 
                stock_season = stock_season,
                data_season = "spring",
                measure_name = "zoo",
                group_regex = "[^A-Z_](.*)(?=_)") %>% 
  mutate(season = "spring") %>% 
  left_join(.,zoo_lookup, by = "Grouping") %>% 
  dplyr::filter(copepod == "n") %>% 
  dplyr::select(-Grouping, -season, -copepod) %>%
  tidyr::spread(full_name, Mean)

if (interactive){

buttons <- create_buttons(spring_noncope)

spring_noncope_plt <-
  tab_plotly(spring_noncope, add_smoother = F, showlegend = F) %>% 
  layout(title = "Spring non-copepod zoo. abundance",
         yaxis = list(title = "Abundance (log num m<sup>-3</sup>)",
                      hoverformat = '.3f', mirror = TRUE, showline = TRUE),
         showlegend = F,
         updatemenus = 
        
        list(
           list(
            buttons = list(buttons[[1]],buttons[[2]],buttons[[3]],buttons[[4]]),
                      type = "buttons",
                      direction = "right",
                      xanchor = "center",
                      yanchor = "top",
                      pad = list("r"= 0, "t"= 10, "b" = 10),
                      x = 0.5,
                      y = -0.2
                      ),
          list(
           buttons = list(buttons[[5]],buttons[[6]],buttons[[7]]),
                      type = "buttons",
                      direction = "right",
                      xanchor = "center",
                      yanchor = "top",
                      pad = list("r"= 0, "t"= 10, "b" = 10),
                      x = 0.5,
                      y = -0.3
                      ),
          list(
           buttons = list(buttons[[8]],buttons[[9]],buttons[[10]]),
                      type = "buttons",
                      direction = "right",
                      xanchor = "center",
                      yanchor = "top",
                      pad = list("r"= 0, "t"= 10, "b" = 10),
                      x = 0.5,
                      y = -0.4
                      )
                     )
                    )

spring_noncope_plt

} else {
  
  spring_noncope %>% 
    tidyr::gather(Var, Value, -Time) %>% 
    ggplot() +
    geom_line(aes(x = Time, y = Value, group = Var)) +
    facet_wrap(Var~., scales = "free_y") +
    theme_bw() +
    ylab(expression(paste("Abundance (log num ", m^{-3}, ")"))) +
        theme(strip.text = element_text(face = "italic"),
          strip.background = element_blank()) +
    ggtitle("Spring non-copepod zoo. abundance")
}
```

```{r zoo_fall_noncope, fig.height=5}
fall_noncope <- stars_to_series(r <- "zoo_fall_rasters_1yr.rdata",
                stock_name = stock_name, 
                common_name = common_name, 
                stock_season = stock_season,
                data_season = "fall",
                measure_name = "zoo",
                group_regex = "[^A-Z_](.*)(?=_)") %>% 
  mutate(season = "fall") %>% 
  left_join(.,zoo_lookup, by = "Grouping") %>% 
  dplyr::filter(copepod == "n") %>% 
  dplyr::select(-Grouping, -season, -copepod) %>%
  tidyr::spread(full_name, Mean)

if (interactive){

buttons <- create_buttons(fall_noncope)

fall_noncope_plt <-
  tab_plotly(fall_noncope, add_smoother = F, showlegend = F) %>% 
  layout(title = "Fall non-copepod zoo. abundance",
         yaxis = list(title = "Abundance (log num m<sup>-3</sup>)",
                      hoverformat = '.3f', mirror = TRUE, showline = TRUE),
         showlegend = F,
         updatemenus = 
        
        list(
           list(
            buttons = list(buttons[[1]],buttons[[2]],buttons[[3]],buttons[[4]]),
                      type = "buttons",
                      direction = "right",
                      xanchor = "center",
                      yanchor = "top",
                      pad = list("r"= 0, "t"= 10, "b" = 10),
                      x = 0.5,
                      y = -0.2
                      ),
          list(
           buttons = list(buttons[[5]],buttons[[6]],buttons[[7]]),
                      type = "buttons",
                      direction = "right",
                      xanchor = "center",
                      yanchor = "top",
                      pad = list("r"= 0, "t"= 10, "b" = 10),
                      x = 0.5,
                      y = -0.3
                      ),
          list(
           buttons = list(buttons[[8]],buttons[[9]],buttons[[10]]),
                      type = "buttons",
                      direction = "right",
                      xanchor = "center",
                      yanchor = "top",
                      pad = list("r"= 0, "t"= 10, "b" = 10),
                      x = 0.5,
                      y = -0.4
                      )
                     )
                    )

fall_noncope_plt

} else {
  
  fall_noncope %>% 
    tidyr::gather(Var, Value, -Time) %>% 
    ggplot() +
    geom_line(aes(x = Time, y = Value, group = Var)) +
    facet_wrap(Var~., scales = "free_y") +
    theme_bw() +
    ylab(expression(paste("Abundance (log num ", m^{-3}, ")"))) +
        theme(strip.text = element_text(face = "italic"),
          strip.background = element_blank()) +
    ggtitle("Fall non-copepod zoo. abundance")
}
```


# Habitat and abundance

{{HabitatStart}}


{{HabitatEnd}}

## Occurrence probability {-#occurrence-probability}

{{OccurrenceStart}}

The probability of occurrence was estimated using random forest classification models (see [methods](#methods)). The mean annual probabilities were extracted for the spring and fall stock definition areas. These data provide an estimate of the potential use of the habitat associated with the stock definition.

{{OccurrenceEnd}}

```{r occ_prob, fig.height=4}

spring_occ_prob <- 
  stars_to_series(r = paste0("spring_",sixcode,"_occ_prob.rdata"),
                stock_name = stock_name, 
                common_name = common_name, 
                stock_season = stock_season,
                data_season = "spring",
                measure_name = "occurrence") %>% 
  dplyr::select(Spring = Mean,
                Time)

fall_occ_prob <- 
  stars_to_series(r = paste0("fall_",sixcode,"_occ_prob.rdata"),
                stock_name = stock_name, 
                common_name = common_name, 
                stock_season = stock_season,
                data_season = "fall",
                measure_name = "occurrence") %>% 
  dplyr::select(Fall = Mean,
                Time)

occ_prob <- spring_occ_prob %>% 
  left_join(.,fall_occ_prob, by  = "Time") %>% 
  dplyr::select(Time, Spring, Fall)

occ_prob_plt <- 
  occ_prob %>% 
    tidyr::gather(Var, Value, -Time) %>% 
  mutate(tooltip = paste0("<table><tr><td>Year:</td><td>",Time,"</td></tr><tr><td>Value:  </td><td>",round(Value,3),"</td></tr></table>")) %>% 
  ggplot(aes(x = Time, 
            y = Value, color = Var, group = Var,
                 tooltip = tooltip,
                 data_id = Time)) +
  geom_line()+
  {if(interactive) geom_point_interactive(size = 0)
    else geom_line()} +
    scale_color_manual(values = 
                         c("Fall" = "#a6cee3",
                         "Spring" = "#1f78b4"))+
    theme_bw() +
    theme(legend.title = element_blank()) +
    ylab("Occupancy probability")+
    ggtitle("Occupancy probability")

if (interactive){
  girafe_options(girafe(code = print(occ_prob_plt), width = 0.9,
         height_svg = 2.5),opts_hover(css = "r:2pt;") )
} else {
  occ_prob_plt
}
```

## Habitat area {-#habitat-area}

{{HabitatAreaStart}}


{{HabitatAreaEnd}}


### Stock area  {-#stock-area}

{{StockAreaStart}}


{{StockAreaEnd}}

```{r stock_hab_area, fig.height=4, eval = T}
threshold <- 0.5



stock_hab_area_df <- 
  stock_habitat_area %>% 
    dplyr::filter(threshold == !!threshold) %>% 
    dplyr::select(season, Time = year, Value = value) %>% 
  tidyr::spread(.,season, Value)  

if (any(stock_season %in% "fall")){

fall_stock_area <- stock_hab_area_df %>% 
  dplyr::select(Value = fall, Time) %>% 
  dplyr::distinct() %>% 
  ecotrend::glsMs(Value ~ Time,
                data = .,
                diagnostic = T,
                fit_model  = T)

STARS_in <- fall_stock_area$fit %>% 
  dplyr::select(-fit) %>% 
  as.matrix()

if (fall_stock_area$`selection summary`$pval[1] < 0.05){
  fall_mod <- fall_stock_area$model
  
  fall_stock_area <- fall_stock_area$fit %>% 
      dplyr::select(Time = time, 
                Series = series,
                Trend = fit)
  
  summ_ <- gls_summary(mod = fall_mod)
  trend <- summ_$Value[1]
  lci <- summ_$Value[2]
  uci <- summ_$Value[3]

  fall_title <- sprintf("Fall Trend: %s CI: (%s, %s)", trend, lci, uci)
} else {
    fall_stock_area <- fall_stock_area$fit %>% 
      dplyr::select(Time = time, 
                Series = series)
    fall_title <- "Fall"
}

fall_stock_area %<>%
  left_join(.,STARS(mat.in = STARS_in),by = "Time") %>% 
  dplyr::select(-Data, -RSI, -Regime.Number,
                `Regime mean` = Regime.Mean) %>% 
  dplyr::select(which(sapply(.,var)!=0))

}

if (any(stock_season %in% "spring")){
  
spring_stock_area <- stock_hab_area_df %>% 
  dplyr::select(Value = spring, Time) %>% 
  dplyr::distinct() %>% 
  ecotrend::glsMs(Value ~ Time,
                data = .,
                diagnostic = T,
                fit_model  = T)

STARS_in <- spring_stock_area$fit %>% 
  dplyr::select(-fit) %>% 
  as.matrix()

if (spring_stock_area$`selection summary`$pval[1] < 0.05){
  spring_mod <- spring_stock_area$model
  
  spring_stock_area <- spring_stock_area$fit %>% 
      dplyr::select(Time = time, 
                Series = series,
                Trend = fit)
  
  summ_ <- gls_summary(mod = spring_mod)
  trend <- summ_$Value[1]
  lci <- summ_$Value[2]
  uci <- summ_$Value[3]

  spring_title <- sprintf("Spring Trend: %s CI: (%s, %s)", trend, lci, uci)
} else {
    spring_stock_area <- spring_stock_area$fit %>% 
      dplyr::select(Time = time, 
                Series = series)
    spring_title <- "Spring"
}

spring_stock_area %<>%
  left_join(.,STARS(mat.in = STARS_in),by = "Time") %>% 
  dplyr::select(-Data, -RSI, -Regime.Number,
                `Regime mean` = Regime.Mean) %>% 
  dplyr::select(which(sapply(.,var)!=0))
}

```


```{r spring-hab-area-plt, fig.height=4}
if (any(stock_season %in% "spring")){
  
spring_stock_area_plt <- 
  spring_stock_area %>% 
  tidyr::gather(.,Var,Value, - Time) %>% 
  mutate(tooltip = paste0("<table><tr><td>Year:</td><td>",Time,"</td></tr><tr><td>Value:  </td><td>",round(Value,3),"</td></tr></table>")) %>% 
  
  ggplot(aes(x = Time, 
            y = Value, color = Var, group = Var,
                 tooltip = tooltip,
                 data_id = Time)) +
  geom_line()+
  {if(interactive) geom_point_interactive(size = 0)
    else geom_line()} +
    scale_color_manual(values = 
                         c("Regime mean" = "#b2df8a",
                         "Trend" = "#a6cee3",
                         "Series" = "#1f78b4"))+
    theme_bw() +
    theme(legend.title = element_blank()) +
    ylab(expression(paste("Area (",km^{2}, ")")))+
    ggtitle(spring_title)

if (interactive){
  girafe_options(girafe(code = print(spring_stock_area_plt), width = 0.9,
         height_svg = 2.5),opts_hover(css = "r:2pt;") )
} else {
  spring_stock_area_plt
}

}
```

```{r fall-hab-area-plt, fig.height=4}
if (any(stock_season %in% "fall")){
fall_stock_area_plt <- 
  fall_stock_area %>% 
  tidyr::gather(.,Var,Value, - Time) %>% 
  mutate(tooltip = paste0("<table><tr><td>Year:</td><td>",Time,"</td></tr><tr><td>Value:  </td><td>",round(Value,3),"</td></tr></table>")) %>% 
  
  ggplot(aes(x = Time, 
            y = Value, color = Var, group = Var,
                 tooltip = tooltip,
                 data_id = Time)) +
  geom_line()+
  {if(interactive) geom_point_interactive(size = 0)
    else geom_line()} +
    scale_color_manual(values = 
                         c("Regime mean" = "#b2df8a",
                         "Trend" = "#a6cee3",
                         "Series" = "#1f78b4"))+
    theme_bw() +
    theme(legend.title = element_blank()) +
    ylab(expression(paste("Area (",km^{2}, ")")))+
    ggtitle(fall_title)

if (interactive){
  girafe_options(girafe(code = print(fall_stock_area_plt), width = 0.9,
         height_svg = 2.5),opts_hover(css = "r:2pt;") )
} else {
  fall_stock_area_plt
}

}
```


### Ecosystem {-#ecosystem}

{{EcosystemAreaStart}}


{{EcosystemAreaEnd}}

```{r ecosystem_hab_area, fig.height=4, eval = T}
ecosystem_hab_area_df <- 
  ecosystem_habitat_area %>% 
    dplyr::filter(threshold == !!threshold, area == "unit") %>% 
    dplyr::select(season, Time = year, Value = value) %>% 
  tidyr::spread(.,season, Value)  

if (any(names(ecosystem_hab_area_df) == c("fall"))){
  
fall_ecosystem_area <- ecosystem_hab_area_df %>% 
  dplyr::select(Value = fall, Time) %>% 
  dplyr::distinct() %>% 
  ecotrend::glsMs(Value ~ Time,
                data = .,
                diagnostic = T,
                fit_model  = T)

STARS_in <- fall_ecosystem_area$fit %>% 
  dplyr::select(-fit) %>% 
  as.matrix()

if (fall_ecosystem_area$`selection summary`$pval[1] < 0.05){
  fall_mod <- fall_ecosystem_area$model
  
  fall_ecosystem_area <- fall_ecosystem_area$fit %>% 
      dplyr::select(Time = time, 
                Series = series,
                Trend = fit)
  
  summ_ <- gls_summary(mod = fall_mod)
  trend <- summ_$Value[1]
  lci <- summ_$Value[2]
  uci <- summ_$Value[3]

  fall_title <- sprintf("Fall Trend: %s CI: (%s, %s)", trend, lci, uci)
} else {
    fall_ecosystem_area <- fall_ecosystem_area$fit %>% 
      dplyr::select(Time = time, 
                Series = series)
    fall_title <- "Fall"
}

fall_ecosystem_area %<>%
  left_join(.,STARS(mat.in = STARS_in),by = "Time") %>% 
  dplyr::select(-Data, -RSI, -Regime.Number,
                `Regime mean` = Regime.Mean) %>% 
  dplyr::select(which(sapply(.,var)!=0))

}

if (any(names(ecosystem_hab_area_df) == c("spring"))){

spring_ecosystem_area <- ecosystem_hab_area_df %>% 
  dplyr::select(Value = spring, Time) %>% 
  dplyr::distinct() %>% 
  ecotrend::glsMs(Value ~ Time,
                data = .,
                diagnostic = T,
                fit_model  = T)

STARS_in <- spring_ecosystem_area$fit %>% 
  dplyr::select(-fit) %>% 
  as.matrix()

if (spring_ecosystem_area$`selection summary`$pval[1] < 0.05){
  spring_mod <- spring_ecosystem_area$model
  
  spring_ecosystem_area <- spring_ecosystem_area$fit %>% 
      dplyr::select(Time = time, 
                Series = series,
                Trend = fit)
  
  summ_ <- gls_summary(mod = spring_mod)
  trend <- summ_$Value[1]
  lci <- summ_$Value[2]
  uci <- summ_$Value[3]

  spring_title <- sprintf("Spring Trend: %s CI: (%s, %s)", trend, lci, uci)
} else {
    spring_ecosystem_area <- spring_ecosystem_area$fit %>% 
      dplyr::select(Time = time, 
                Series = series)
    spring_title <- "Spring"
}

spring_ecosystem_area %<>%
  left_join(.,STARS(mat.in = STARS_in),by = "Time") %>% 
  dplyr::select(-Data, -RSI, -Regime.Number,
                `Regime mean` = Regime.Mean) %>% 
  dplyr::select(which(sapply(.,var)!=0))
}
```


```{r spring-ecosystem-area-plt, fig.height=4}
if (any(names(ecosystem_hab_area_df) == c("spring"))){
  
  spring_ecosystem_area_plt <- 
    spring_ecosystem_area %>% 
    tidyr::gather(.,Var,Value, - Time) %>% 
    mutate(tooltip = paste0("<table><tr><td>Year:</td><td>",Time,"</td></tr><tr><td>Value:  </td><td>",round(Value,3),"</td></tr></table>")) %>% 
    
    ggplot(aes(x = Time, 
              y = Value, color = Var, group = Var,
                   tooltip = tooltip,
                   data_id = Time)) +
    geom_line()+
    {if(interactive) geom_point_interactive(size = 0)
      else geom_line()} +
      scale_color_manual(values = 
                           c("Regime mean" = "#b2df8a",
                           "Trend" = "#a6cee3",
                           "Series" = "#1f78b4"))+
      theme_bw() +
      theme(legend.title = element_blank()) +
      ylab(expression(paste("Area (",km^{2}, ")")))+
      ggtitle(spring_title)
  
  if (interactive){
    girafe_options(girafe(code = print(spring_ecosystem_area_plt), width = 0.9,
           height_svg = 2.5),opts_hover(css = "r:2pt;") )
  } else {
    spring_ecosystem_area_plt
  }

}
```

```{r fall-ecosystem-area-plt, fig.height=4}
if (any(names(ecosystem_hab_area_df) == c("fall"))){

  fall_ecosystem_area_plt <- 
    fall_ecosystem_area %>% 
    tidyr::gather(.,Var,Value, - Time) %>% 
    mutate(tooltip = paste0("<table><tr><td>Year:</td><td>",Time,"</td></tr><tr><td>Value:  </td><td>",round(Value,3),"</td></tr></table>")) %>% 
    
    ggplot(aes(x = Time, 
              y = Value, color = Var, group = Var,
                   tooltip = tooltip,
                   data_id = Time)) +
    geom_line()+
    {if(interactive) geom_point_interactive(size = 0)
      else geom_line()} +
      scale_color_manual(values = 
                           c("Regime mean" = "#b2df8a",
                           "Trend" = "#a6cee3",
                           "Series" = "#1f78b4"))+
      theme_bw() +
      theme(legend.title = element_blank()) +
      ylab(expression(paste("Area (",km^{2}, ")")))+
      ggtitle(fall_title)
  
  if (interactive){
    girafe_options(girafe(code = print(fall_ecosystem_area_plt), width = 0.9,
           height_svg = 2.5),opts_hover(css = "r:2pt;") )
  } else {
    fall_ecosystem_area_plt
  }

}
```

## Minimum Population Size {-#minimum-population-size}

{{MinPopulationStart}}


{{MinPopulationEnd}}


```{r sae_processing, eval = T}
do_transform <- T

if (nrow(fall_sae) != 0){
  fall_sae_processed <- fall_sae %>% 
  dplyr::select(-svspp) %>% 
  dplyr::rename(Time = year) %>% 
  dplyr::select(-ztotal) %>%
  mutate(total = ifelse(ciflag < 0 , NA, total),
         lowerci =ifelse(ciflag < 0 , NA, lowerci),
         upperci =ifelse(ciflag < 0 , NA, upperci)) %>% 
  mutate(Treatment = as.factor(treatment),
          total_log10 = log10(total),
         upperci_log10 = log10(upperci),
         lowerci_log10 = log10(lowerci),
         biomass = ifelse(biomass == "yes","Biomass","Abundance")) %>% 
  dplyr::select(-treatment) %>% 
  mutate(tooltip_log10 = paste0("<table><tr><td>Year:</td><td>",Time,"</td></tr><tr><td>Value:  </td><td>",round(total_log10,3),"</td></tr></table>"),
         tooltip = paste0("<table><tr><td>Year:</td><td>",Time,"</td></tr><tr><td>Value:  </td><td>",round(total,3),"</td></tr></table>"))
}

if (nrow(spring_sae) != 0){
  spring_sae_processed <- spring_sae %>% 
    dplyr::select(-svspp) %>% 
    dplyr::rename(Time = year) %>% 
    dplyr::select(-ztotal) %>%
      mutate(total = ifelse(ciflag < 0 , NA, total),
           lowerci =ifelse(ciflag < 0 , NA, lowerci),
           upperci =ifelse(ciflag < 0 , NA, upperci)) %>% 
    mutate(Treatment = as.factor(treatment),
            total_log10 = log10(total),
           upperci_log10 = log10(upperci),
           lowerci_log10 = log10(lowerci),
           biomass = ifelse(biomass == "yes","Biomass","Abundance")) %>% 
    dplyr::select(-treatment) %>% 
    mutate(tooltip_log10 = paste0("<table><tr><td>Year:</td><td>",Time,"</td></tr><tr><td>Value:  </td><td>",round(total_log10,3),"</td></tr></table>"),
           tooltip = paste0("<table><tr><td>Year:</td><td>",Time,"</td></tr><tr><td>Value:  </td><td>",round(total,3),"</td></tr></table>"))
}
```


### Spring numbers and biomass {-#spring-numbers-and-biomass}

{{SpringHabitatAreaStart}}


{{SpringHabitatAreaEnd}}

```{r spring_sae_plt, fig.height = adjust_for_facet, eval = T}
if (nrow(spring_sae) != 0){
  if (do_transform){
    
  biomass_plt <- spring_sae_processed %>% 
      filter(biomass == "Biomass") %>% 
      ggplot(aes(x = Time, 
              y = total_log10, group = Treatment)) +
       geom_line(aes(color = Treatment)) +
         geom_ribbon(aes(x = Time,
                         ymax = upperci_log10,
                       ymin = lowerci_log10, fill = Treatment), alpha = 0.1) +
       {if(interactive) geom_point_interactive(aes(tooltip = tooltip_log10, data_id = Time,
                                                   color = Treatment))
         else geom_point(aes(color = Treatment)) } +
  
       theme_bw() +
       guides(color = F, fill = F) +
       {if (length(unique(spring_sae_processed$stocks)) > 1) facet_wrap(stocks~., nrow = 3, scales = "free_y")} +
       scale_x_continuous(expand = c(0.01, 0.01)) +
       ylab("Biomass (log10 kg)") +
       xlab("")
  
  abundance_plt <- spring_sae_processed %>% 
      filter(biomass == "Abundance") %>% 
      ggplot(aes(x = Time, 
              y = total_log10, group = Treatment)) +
       geom_line(aes(color = Treatment)) +
         geom_ribbon(aes(x = Time, ymax = upperci_log10,
                       ymin = lowerci_log10, fill = Treatment), alpha = 0.1) +
       {if(interactive) geom_point_interactive(aes(tooltip = tooltip_log10, data_id = Time,
                                                   color = Treatment))
         else geom_point(aes(color = Treatment)) } +
       theme_bw() +
       {if (length(unique(spring_sae_processed$stocks)) > 1) facet_wrap(stocks~., nrow = 3, scales = "free_y")} +
       theme(legend.position = "bottom") +
       scale_x_continuous(expand = c(0.01, 0.01)) +
       ylab("Abundance (log10 N)")
  
    } else {
      
  biomass_plt <- spring_sae_processed %>% 
      filter(biomass == "Biomass") %>% 
      ggplot(aes(x = Time, 
              y = total, group = Treatment)) +
       geom_line(aes(color = Treatment)) +
         geom_ribbon(aes(x = Time, ymax = upperci,
                       ymin = lowerci, fill = Treatment), alpha = 0.1) +
       {if(interactive) geom_point_interactive(aes(tooltip = tooltip, data_id = Time,
                                                   color = Treatment))
         else geom_point(aes(color = Treatment)) } +
       theme_bw() +
       guides(color = F, fill = F) +
       {if (length(unique(spring_sae_processed$stocks)) > 1) facet_wrap(stocks~., nrow = 3, scales = "free_y")} +
       scale_x_continuous(expand = c(0.01, 0.01)) +
       ylab("Biomass (kg)") +
       xlab("")
  
  abundance_plt <- spring_sae_processed %>% 
      filter(biomass == "Abundance") %>% 
      ggplot(aes(x = Time, 
              y = total, group = Treatment)) +
       geom_line(aes(color = Treatment)) +
         geom_ribbon(aes(x = Time, ymax = upperci,
                       ymin = lowerci, fill = Treatment), alpha = 0.1) +
       {if(interactive) geom_point_interactive(aes(tooltip = tooltip, data_id = Time,
                                                   color = Treatment))
         else geom_point(aes(color = Treatment)) } +
       theme_bw() +
       {if (length(unique(spring_sae_processed$stocks)) > 1) facet_wrap(stocks~., nrow = 3, scales = "free_y")} +
       theme(legend.position = "bottom") +
       scale_x_continuous(expand = c(0.01, 0.01)) +
       ylab("Abundance (N)")
    }
  
  if (interactive){
    title <- cowplot::ggdraw() +
      cowplot::draw_label("Spring biomass & abundance",x = 0.25)
  
    girafe_options(girafe(code = print(title + biomass_plt +
                                         abundance_plt + plot_layout(nrow = 3)),
                          width = 0.9, height_svg = 5),opts_hover(css = "r:2pt;") )
    
  } else {
    title <- cowplot::ggdraw() +
      cowplot::draw_label("Spring biomass & abundance",x = 0.25)
  
    cowplot::plot_grid(title, biomass_plt, abundance_plt,ncol=1, rel_heights=c(0.1, 1,1))
  }
}
```


### Fall numbers and biomass {-#fall-numbers-and-biomass}

{{FallHabitatAreaStart}}


{{FallHabitatAreaEnd}}

```{r fall_sae_plt, fig.height = adjust_for_facet, eval = T}
if (nrow(fall_sae) != 0){
  if (do_transform){
    
  biomass_plt <- fall_sae_processed %>% 
      filter(biomass == "Biomass") %>% 
      ggplot(aes(x = Time, 
              y = total_log10, group = Treatment)) +
       geom_line(aes(color = Treatment)) +
         geom_ribbon(aes(x = Time,
                         ymax = upperci_log10,
                       ymin = lowerci_log10, fill = Treatment), alpha = 0.1) +
       {if(interactive) geom_point_interactive(aes(tooltip = tooltip_log10, data_id = Time,
                                                   color = Treatment))
         else geom_point(aes(color = Treatment)) } +
  
       theme_bw() +
       guides(color = F, fill = F) +
       {if (length(unique(fall_sae_processed$stocks)) > 1) facet_wrap(stocks~., nrow = 3, scales = "free_y")} +
       scale_x_continuous(expand = c(0.01, 0.01)) +
       ylab("Biomass (log10 kg)") +
       xlab("")
  
  abundance_plt <- fall_sae_processed %>% 
      filter(biomass == "Abundance") %>% 
      ggplot(aes(x = Time, 
              y = total_log10, group = Treatment)) +
       geom_line(aes(color = Treatment)) +
         geom_ribbon(aes(x = Time, ymax = upperci_log10,
                       ymin = lowerci_log10, fill = Treatment), alpha = 0.1) +
       {if(interactive) geom_point_interactive(aes(tooltip = tooltip_log10, data_id = Time,
                                                   color = Treatment))
         else geom_point(aes(color = Treatment)) } +
       theme_bw() +
       {if (length(unique(fall_sae_processed$stocks)) > 1) facet_wrap(stocks~., nrow = 3, scales = "free_y")} +
       theme(legend.position = "bottom") +
       scale_x_continuous(expand = c(0.01, 0.01)) +
       ylab("Abundance (log10 N)")
  
    } else {
      
  biomass_plt <- fall_sae_processed %>% 
      filter(biomass == "Biomass") %>% 
      ggplot(aes(x = Time, 
              y = total, group = Treatment)) +
       geom_line(aes(color = Treatment)) +
         geom_ribbon(aes(x = Time, ymax = upperci,
                       ymin = lowerci, fill = Treatment), alpha = 0.1) +
       {if(interactive) geom_point_interactive(aes(tooltip = tooltip, data_id = Time,
                                                   color = Treatment))
         else geom_point(aes(color = Treatment)) } +
       theme_bw() +
       guides(color = F, fill = F) +
       {if (length(unique(fall_sae_processed$stocks)) > 1) facet_wrap(stocks~., nrow = 3, scales = "free_y")} +
       scale_x_continuous(expand = c(0.01, 0.01)) +
       ylab("Biomass (kg)") +
       xlab("")
  
  abundance_plt <- fall_sae_processed %>% 
      filter(biomass == "Abundance") %>% 
      ggplot(aes(x = Time, 
              y = total, group = Treatment)) +
       geom_line(aes(color = Treatment)) +
         geom_ribbon(aes(x = Time, ymax = upperci,
                       ymin = lowerci, fill = Treatment), alpha = 0.1) +
       {if(interactive) geom_point_interactive(aes(tooltip = tooltip, data_id = Time,
                                                   color = Treatment))
         else geom_point(aes(color = Treatment)) } +
       theme_bw() +
       {if (length(unique(fall_sae_processed$stocks)) > 1) facet_wrap(stocks~., nrow = 3, scales = "free_y")} +
       theme(legend.position = "bottom") +
       scale_x_continuous(expand = c(0.01, 0.01)) +
       ylab("Abundance (N)")
    }
  
  if (interactive){
    title <- cowplot::ggdraw() +
      cowplot::draw_label("Fall biomass & abundance",x = 0.25)
  
    girafe_options(girafe(code = print(title + biomass_plt +
                                         abundance_plt + plot_layout(nrow = 3)),
                          width = 0.9, height_svg = 5),opts_hover(css = "r:2pt;") )
    
  } else {
    title <- cowplot::ggdraw() +
      cowplot::draw_label("Fall biomass & abundance",x = 0.25)
  
    cowplot::plot_grid(title, biomass_plt, abundance_plt,ncol=1, rel_heights=c(0.1, 1,1))
  }
}
```

# Methods {#methods}

<!-- Generic methods will be attached to the document after editing. To view, please go to `r googledrive::drive_link("EDABranch_Drive/Products/ECSA/generic_methods.Rmd")` -->



