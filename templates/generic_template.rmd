---
title:
    | 
    | Ecosystem Context for Stock Assessments:
    | {{COMMON_NAME}}
date: "`r format(Sys.time(), '%B %d, %Y')`"
always_allow_html: yes
site: "bookdown::bookdown_site"
output:
  bookdown::gitbook:
    lib_dir: "book_assets"
---

```{r setup, include = FALSE}
## Load packages
# library(ecsa)
library(dplyr)
library(ggplot2)
# library(gridExtra)
library(DT)
library(jpeg)
library(patchwork)
library(ggiraph)
library(ggthemes)
library(cowplot)
library(stringr)

# Load in survey data, right now it is only for summer flounder
# load("data/df_survdat.rda")
# colnames(survdat)
# colnames(df_survdat)

# load("data/Survdat.RData")
# tt <- survdat

## Read in stock area vectors
# all_stock_area2 <- read.csv("data/seasonal_stock_strata.csv")

## Read in stock area vectors
all_stock_area <- read.csv("data/stock_data/stock_list.csv", stringsAsFactors = FALSE)


## Put all mustaches here
stock_code <- "{{SPECIES_CODE}}"
# common_name <- "{{COMMON_NAME}}"
cc_name <- "{{CC_NAME}}"
# svspp <- "{{SVSPP}}"
# gg_int <- as.logical("{{INTERACTIVE}}")

source("R/map_strata.R")
source("R/get_strata.R")
source("R/crop_to_strata.R")

strata <- all_stock_area %>% 
  dplyr::filter(sp == stock_code)

```


## Overview 

### Introduction
This report provides contextual ecosystem information for {{COMMON_NAME}} (*{{SCI_NAME}}*) on the Northeast U.S. Continental Shelf. Data extractions for spring and fall are confined to the {{COMMON_NAME}} stock area based on respective survey strata sets. The information is intended to span a range of potential factors affecting the productivity and distribution of {{COMMON_NAME}}, including: surface and bottom temperature and salinity, chlorophyll concentrations, indices of habitat, diet composition, and abundance of key zooplankton prey of larval {{COMMON_NAME}}. These factors can be used to qualitatively inform the interpretation of population status and/or quantitatively to improve model responsiveness to ecosystem factors. The range and complexity of ecosystem data makes it unlikely to find the most relevant and comprehensive factor variables with a first evaluation; this process will require an iterative approach of evaluation and feedback. Additional indices can be included to address the needs of the working group.

#### Summary

* Add summary point 
* Add summary point 
* Add summary point 

### Strata definition
```{r strata-map, eval = TRUE, echo = FALSE, fig.cap= "Strata map for {{COMMON_NAME}} (*{{SCI_NAME}}*) on the NE shelf", message = FALSE, warning = FALSE, fig.align='center'}

map_strata(stock_code = stock_code, strata = strata, overwrite = FALSE, save_plot = FALSE)
```


### Bottom Temperature

```{r, echo = F, warning=F, fig.align='center'}

## Spring bottom temperature: If only one stock area is listed, show that area with spring data
spring_bot_temp <- try(
  crop_to_strata(r = "bot_temp_spring_spdf.rdata",
                 stock_code = stock_code, season_ = "spring") %>% 
                 as.tbl_cube() 
  )

if (class(spring_bot_temp) == "try-error"){
    spring_bot_temp <- try(
      crop_to_strata(r = "bot_temp_spring_spdf.rdata",
                     stock_code = stock_code, season_ = "fall") %>% 
                     as.tbl_cube() 
    )
}

if (class(spring_bot_temp) == "try-error"){
    spring_bot_temp <- try(
      crop_to_strata(r = "bot_temp_spring_spdf.rdata",
                     stock_code = stock_code, season_ = "both") %>% 
                     as.tbl_cube() 
    )
}

names(spring_bot_temp$mets) <- "spring_bot_temp"

mean_spring_bot_temp <- spring_bot_temp %>% 
  group_by(band) %>% 
  dplyr::summarise(Temp = mean(spring_bot_temp, na.rm = T)) %>% 
  as.data.frame() %>% 
  mutate(Time = as.numeric(str_extract(band, "\\d{4}"))) %>% 
  dplyr::select(-band)

spring_bt_plot <- 
  ggplot(data = mean_spring_bot_temp) +
  geom_line(aes(x = Time, y = Temp))


## Fall bottom temperature
fall_bot_temp <- try(
  crop_to_strata(r = "bot_temp_fall_spdf.rdata",
                 stock_code = stock_code, season_ = "fall") %>% 
                 as.tbl_cube() 
  )

if (class(fall_bot_temp) == "try-error"){
    fall_bot_temp <- try(
      crop_to_strata(r = "bot_temp_fall_spdf.rdata",
                     stock_code = stock_code, season_ = "spring") %>% 
                     as.tbl_cube() 
    )
}

if (class(fall_bot_temp) == "try-error"){
    fall_bot_temp <- try(
      crop_to_strata(r = "bot_temp_fall_spdf.rdata",
                     stock_code = stock_code, season_ = "both") %>% 
                     as.tbl_cube() 
    )
}

names(fall_bot_temp$mets) <- "fall_bot_temp"

mean_fall_bot_temp <- fall_bot_temp %>% 
  group_by(band) %>% 
  dplyr::summarise(Temp = mean(fall_bot_temp, na.rm = T)) %>% 
  as.data.frame() %>% 
  mutate(Time = as.numeric(str_extract(band, "\\d{4}"))) %>% 
  dplyr::select(-band)

fall_bt_plot <- 
  ggplot(data = mean_fall_bot_temp) +
  geom_line(aes(x = Time, y = Temp))

fall_bt_plot + spring_bt_plot

```

_Last updated on `r format(Sys.Date(), format = "%B %e %Y")`._
