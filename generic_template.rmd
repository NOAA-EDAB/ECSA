---
title:
    | 
    | Ecosystem Context for Stock Assessments:
    | {{COMMON_NAME}}
output: 
        html_document:
                fig_caption: yes
---

```{r setup, include = FALSE}
## Load packages
library(ecsa)
library(dplyr)
library(ggplot2)
library(gridExtra)
library(DT)

# Load in survey data, right now it is only for summer flounder
load("data/df_survdat.rda")

## Read in stock area vectors
all_stock_area <- read.csv("data/seasonal_stock_strata.csv")

## Put all mustaches here
stock_code <- "{{SPECIES_CODE}}"
common_name <- "{{COMMON_NAME}}"
cc_name <- "{{CC_NAME}}"
svspp <- "{{SVSPP}}"

strata_spring <- all_stock_area %>% 
  dplyr::filter(sp == stock_code,
         season == "spring") %>% 
  dplyr::pull(strata)

strata_fall <- all_stock_area %>% 
  dplyr::filter(sp == stock_code,
         season == "fall") %>% 
  dplyr::pull(strata)

```


## Overview {.tabset .tabset-fade .tabset-pills}

### Introduction
This report provides contextual ecosystem information for {{COMMON_NAME}} (*{{SCI_NAME}}*) on the NE Shelf. Data extractions for spring and fall are confined to the {{COMMON_NAME}} stock area based on respective survey strata sets. The information is intended to span a range of potential factors affecting the productivity and distribution of {{COMMON_NAME}}, including: surface and bottom temperature and salinity, chlorophyll concentrations, indices of habitat, diet composition, and abundance of key zooplankton prey of larval {{COMMON_NAME}}. These factors can be used to qualitatively inform the interpretation of population status and/or quantitatively to improve model responsiveness to ecosystem factors. The range and complexity of ecosystem data makes it unlikely to find the most relevant and comprehensive factor variables with a first evaluation; this process will require an iterative approach of evaluation and feedback. Additional indices can be included to address the needs of the working group.

### Strata definition
```{r strata-map, eval = TRUE, echo = FALSE, fig.cap= "Strata map ...", message = FALSE, warning = FALSE, fig.align='center'}

map_strata(common_name = common_name, spring_strata = spring_strata,
           fall_strata = fall_strata, overwrite = FALSE, save_plot = FALSE)


```


## Surface and bottom temperature {.tabset .tabset-fade .tabset-pills}

An optimal interpolation procedure was used to estimate NE Shelf surface and bottom temperatures for two seasonal time frames (see [methods](#sec:methods)). The temperature estimates were standardized to April 3 and October 11 for spring and fall over the period 1968-2017. Spring surface and bottom temperature within the spring {{COMMON_NAME}} stock areas are shown in the upper and lower left figures. Fall surface and bottom temperature within the fall {{COMMON_NAME}} stock areas are shown in the upper and lower right figures.

### Figure

```{r ocean temp, echo = F, fig.align='center'}
sf1 <- stock_env(variable = "temperature",type = "surface",
                  season = "spring", svspp = svspp, mask_type = "unit")
ss1 <- stock_env(variable = "temperature",type = "surface",
                 season = "fall", svspp = svspp, mask_type = "unit")

bf1 <- stock_env(variable = "temperature",type = "bottom",
                 season = "spring", svspp = svspp, mask_type = "unit")
bs1 <- stock_env(variable = "temperature",type = "bottom",
                 season = "fall", svspp = svspp, mask_type = "unit")
        
surface <- rbind(sf1, ss1)
bottom <- rbind(bf1, bs1)

xmin <- rbind(min(surface$Time),min(bottom$Time))
xmin <- min(xmin)

s_plt <- ggplot(data = surface, aes(x = Time, y = Value)) +
  ylab(expression(paste("Surface Temperature ",degree,"C"))) +
  xlab("") +
  xlim(xmin, NA) +
  geom_line() +
  geom_point() +
  facet_wrap(Season ~., nrow = 1) +
  theme_bw() +
  theme(plot.title = element_blank(),
        strip.background = element_blank(),
        strip.text.x = element_blank()) +
  annotate("text", label = c("A","B"), x = xmin, y = Inf, vjust = 1.5, size = 5)

b_plt <- ggplot(data = bottom, aes(x = Time, y = Value)) +
   ylab(expression(paste("Bottom Temperature ",degree,"C"))) +
  xlab("Year") +
  xlim(xmin, NA) +
  geom_line() +
  geom_point() +
  facet_wrap(Season ~., nrow = 1) +
  theme_bw() +
  theme(plot.title = element_blank(),
        strip.background = element_blank(),
        strip.text.x = element_blank()) +
  annotate("text", label = c("C","D"), x = xmin, y = Inf, vjust = 1.5, size = 5)

grid.arrange(s_plt, b_plt, nrow = 2)
```

### Data
```{r ocean data, echo = F}

all_dat <- rbind(surface, bottom)

datatable(all_dat, rownames = FALSE)

```

## Surface and bottom salinity {.tabset .tabset-fade .tabset-pills}

An optimal interpolation procedure was used to estimate NE Shelf surface and bottom salinity for two seasonal time frames (see [methods](#sec:methods)). Though collected with temperature data, reliable instrumentation limits this time series to 1992-2017. The salinity estimates were standardized to April 3 and October 11 for spring and fall. Spring surface and bottom salinity within the spring {{COMMON_NAME}} stock areas are shown in the upper and lower left figures. Fall surface and bottom salinity within the fall {{COMMON_NAME}} stock areas are shown in the upper and lower right figures. 

### Figures
```{r ocean sal, echo = F, fig.align='center'}
sf1 <- stock_env(variable = "salinity",type = "surface",
                  season = "spring", svspp = svspp, mask_type = "unit")
ss1 <- stock_env(variable = "salinity",type = "surface",
                 season = "fall", svspp = svspp, mask_type = "unit")

bf1 <- stock_env(variable = "salinity",type = "bottom",
                 season = "spring", svspp = svspp, mask_type = "unit")
bs1 <- stock_env(variable = "salinity",type = "bottom",
                 season = "fall", svspp = svspp, mask_type = "unit")
        
surface <- rbind(sf1, ss1)
bottom <- rbind(bf1, bs1)

xmin <- rbind(min(surface$Time),min(bottom$Time))
xmin <- min(xmin)

s_plt <- ggplot(data = surface, aes(x = Time, y = Value)) +
  ylab("Surface Salinity (PSU)") +
  xlab("") +
  xlim(xmin, NA) +
  geom_line() +
  geom_point() +
  facet_wrap(Season ~., nrow = 1) +
  theme_bw() +
  theme(plot.title = element_blank(),
        strip.background = element_blank(),
        strip.text.x = element_blank()) +
  annotate("text", label = c("A","B"), x = xmin, y = Inf, vjust = 1.5, size = 5)

b_plt <- ggplot(data = bottom, aes(x = Time, y = Value)) +
  ylab("Surface Salinity (PSU)") +
  xlab("Year") +
  xlim(xmin, NA) +
  geom_line() +
  geom_point() +
  facet_wrap(Season ~., nrow = 1) +
  theme_bw() +
  theme(plot.title = element_blank(),
        strip.background = element_blank(),
        strip.text.x = element_blank()) +
  annotate("text", label = c("C","D"), x = xmin, y = Inf, vjust = 1.5, size = 5)

grid.arrange(s_plt, b_plt, nrow = 2)
```

### Data
```{r sal data, echo = F}

all_dat <- rbind(surface, bottom)

datatable(all_dat, rownames = FALSE)

```

## Chlorophyl concentration {.tabset .tabset-fade .tabset-pills}

The concentration of chlorophyll was measured with a suite of satellite sensors and merged into a single dataset (see [methods](#sec:methods)). Chlorophyll concentrations in the spring and fall {{COMMON_NAME}} stock areas are shown in the left and right figures. The time series of spring chlorophyll concentration may have impacts on recruitment and growth of the stock, while fall chlorophyll values may affect overwintering nutrition. 

The production cycle of the Northeast Shelf is complex and varies spatially. Patterns of seasonal blooms and the overall annual primary production varies within the stock area for {{COMMON_NAME}}; investigation into the linkages between phytoplankton production and {{COMMON_NAME}} may require additional production metrics. 

### Figures
```{r chl fig, echo = F, fig.align="center", fig.height=2}

cs1 <- stock_env(variable = "chlorophyll",
                 season = "spring", svspp = svspp, mask_type = "unit")
cf1 <- stock_env(variable = "chlorophyll",
                 season = "fall", svspp = svspp, mask_type = "unit")
chl <- rbind(cs1, cf1)
xmin <- rbind(min(chl$Time),min(chl$Time))
xmin <- min(xmin)
ggplot(data = chl, aes(x = Time, y = Value)) +
    ylab("Chlorophyll mg m^-3") +
    xlab("") +
    xlim(xmin, NA) +
    geom_line() +
    geom_point() +
    facet_wrap(Season ~., nrow = 1) +
    theme_bw() +
    theme(plot.title = element_blank(),
        strip.background = element_blank(),
        strip.text.x = element_blank()) +
    annotate("text", label = c("A","B"), x = xmin, y = Inf, vjust = 1.5, size = 5)
```


### Data
```{r chl data, echo = F}


datatable(chl, rownames = FALSE)

```

## Zooplankton abundance {.tabset .tabset-fade .tabset-pills}

The primary zooplankton species identified in the diet of {{COMMON_NAME}} larvae are <!--{{Z1long}}, {{Z2long}}, and {{Z3long}} ({{Zref}})-->Centropages typicus (CTYP), Temora longicornis (TLONG), and Pseudocalanus spp. (PSEUDO) (Grover 1998). The abundance of these taxa within the respective seasonal stock areas for spring and fall depicted below (see [methods](#sec:methods)). It is assumed that the <!--{{larvalseason}}-->spring abundances of these taxa would be most relevant to the growth and survival of larval {{COMMON_NAME}}. Note that the abundance estimates are based on data that are spatially smoothed within year by first kriging the observational data before the abundances are extracted for the stock area. The spring abundance for <!--{{Z1}}, {{Z2}}, and {{Z3}}-->C. typicus, T. longicornis, and Pseudocalanus are shown in the plots on left, top to bottom, respectively. 

### Figures

```{r zooplankton, echo = F, fig.align="center", warning=F, message=F}
ct1 <- stock_env(variable = "zooplankton", genus = "centropages",
                 season = "spring", svspp = svspp, mask_type = "unit")

ct2 <- stock_env(variable = "zooplankton", genus = "centropages",
                 season = "fall", svspp = svspp, mask_type = "unit")

t1 <- stock_env(variable = "zooplankton", genus = "temora",
                 season = "spring", svspp = svspp, mask_type = "unit")

t2 <- stock_env(variable = "zooplankton", genus = "temora",
                 season = "fall", svspp = svspp, mask_type = "unit")

ps1 <- stock_env(variable = "zooplankton", genus = "pseudocalanus",
                season = "spring", svspp = svspp, mask_type = "unit")

ps2 <- stock_env(variable = "zooplankton", genus = "pseudocalanus",
                season = "fall", svspp = svspp, mask_type = "unit")


zoo <- rbind(ct1, ct2, t1, t2, ps1, ps2)

xmin <- min(zoo$Time)

ggplot(data = zoo, aes(x = Time, y = Value)) +
    ylab("Abundance log num m^-3") +
    xlab("") +
    xlim(xmin, NA) +
    geom_line() +
    geom_point() +
    facet_wrap(Var ~ ., nrow = 3, ncol = 2) +
    theme_bw() +
    theme(plot.title = element_blank(),
        strip.background = element_blank(),
        strip.text.x = element_blank()) +
    annotate("text", label = c("A","B","C",
                               "D","E","F"), x = xmin, y = Inf, vjust = 1.5, size = 5)

```

### Data
```{r zoo data, echo = F}
datatable(zoo, rownames = FALSE)
```

## Probability of occurence and habitat area {.tabset .tabset-fade .tabset-pills}



### Figures
```{r trawl-habitat, echo = FALSE, fig.align='center'}


df_survdat_spring <-
  df_survdat %>%
  dplyr::filter(YEAR > 1976,
                ## place holder for filtering survdat by species
                SEASON == "SPRING",
                STRATUM %in% strata_spring)

df_survdat_fall <-
  df_survdat %>%
  dplyr::filter(YEAR > 1976,
                ## place holder for filtering survdat by species
                SEASON == "FALL",
                STRATUM %in% strata_fall)

df_survdat2use <-
  rbind(df_survdat_spring,
        df_survdat_fall) %>%
  dplyr::mutate(pres = BIOMASS > 0)


df_prob_occ <-
  df_survdat2use %>%
  dplyr::group_by(SEASON, YEAR) %>%
  dplyr::do(calc_p(df = .)) %>% 
  ungroup() %>% 
  mutate(SEASON = tolower(SEASON),
         SEASON = factor(SEASON, levels = c("spring", "fall")))

# Make plot
ggplot(df_prob_occ, 
       aes(x = YEAR, y = p)) +
  geom_point() +
  geom_errorbar(aes(ymin = p_low, ymax = p_high), 
                size = 0.3, width = 0.3) +
  geom_line() +
  xlab("Year") +
  ylab("Probability of occurence") +
  theme_bw() +
  theme(axis.title = element_text(size = 13),
        strip.text = element_text(size = 10),
        strip.background = NULL) +
  facet_wrap(~ SEASON)

```

### Data
```{r prob data, echo = F}
datatable(df_prob_occ, rownames = FALSE)
```

## Kevin's Occupancy habitat {.tabset .tabset-fade .tabset-pills}

### Figures
add plot here

### Data


## Diet composition {.tabset .tabset-fade .tabset-pills}

### Figures
add plot here

### Data

## Methods {#sec:methods}

### Surface and Bottom Temperature and Salinity

#### Study System
The U.S. Northeast Shelf ecosystem, which roughly aligns with the boundaries of the Northeast U.S. Continental Shelf Large Marine Ecosystem (LME), is the study area for the surface and bottom thermal environments. Surface and bottom temperatures were estimated over a 0.1° latitude/longitude grid, termed the estimation grid, which circumscribes the range of ecosystem assessment areas in the region (Figure 1). The difference between the extents of the estimation grid from the extent of the LME relate to the resource management programs that are the sources of the data, which are focused on fishery management needs in the region. 

#### Data Source
Temperature and salinity were collected on the Northeast Shelf as part of ongoing resource and ecosystem surveys conducted by the Northeast Fisheries Science Center. Water column temperatures have been collected contemporaneously to trawl tows associated with a bottom trawl survey beginning in the fall of 1963 and five years later during spring (Desprespatanjo, Azarovitz & Byrne 1988). In addition, the ecosystem has been surveyed by multiple sampling programs with varying sampling designs. The two most comprehensive monitoring programs over the study period were the MARMAP (1977-1987) and the Ecosystem Monitoring Program or EcoMon (1992-present) programs, both serving as shelf-wide surveys of the ecosystem (Sherman et al. 1998; Kane 2007). Temperature measurements were made with a mix of Conductivity Temperature and Depth (CTD) instruments, analog XBT, digital XBT, mechanical BT, glass thermometers (bottle temps) and trawl mounted temperature loggers instruments collecting either water column profiles or temperatures  measured at targeted depths. Salinity measurements used in this analysis was limited to 1992-2017 when CTD instrument were used. Surface and bottom temperatures were identified from these measurements. Temperatures representing the spring period include data collected during the months of February to June; however, 99% of the samples were collected during the months of March to May. Likewise, the fall period samples include data collected during September to December, with 99% of the samples collected during September to November. The total number of surface temperature measurements were 14,540 and 14,666 for spring and fall, respectively; and, 14,450 and 14,656 for spring and fall bottom temperature, respectively. On average, there were 290 temperature measurements by season, depth, and year. The number of salinity observation per year were similar.

#### Interpolation Procedure
Seasonal surface and bottom temperature fields were estimated using an optimal interpolation approach. The optimal interpolation combined a climatological depiction of temperature and an annual estimates based on the data for a particular depth and season. (There were a number of precursor steps that are described below.).  
The surveys used to collect the data were conducted during the same period each year, however, there was variation in survey timing. To account for this, temperatures were standardized to a collection date of April 3 for spring surveys and October 11 for fall using linear regression for each depth and season over the sample grid (see Appendix A, Figure A1). For each depth and season, annual shelf-wide mean temperatures were calculated using the data from sample grid locations with at least 80% of the time series present. The annual observations were then transformed to anomalies by subtracting the appropriate annual mean. All anomalies for a season and depth were combined over years into a single anomaly field or climatology. 

The annual estimate of temperature for a depth and season was imputed by used universal kriging to estimate the temperature over the estimation grid with depth as a covariate. The kriging yielded temperature estimates and a variance estimate over the same grid. The optimal interpolation field was assembled by combining the annual estimate and information from the anomaly climatology. The climatology was re-leveled from anomaly values to temperatures by adding back the appropriate annual mean. For each location in the estimation grid, temperature was calculated as a weighted mean between the kriged annual estimate and the releveled climatology. The weightings in the calculations were partitioned based on the variance field of the annual kriging. The field was divided into quartiles from low to high variance with the weighting ratio of annual:climatology temperatures of 4:1, 3:1, 2:1, and 1:1, respectively. Hence, in areas of low variance the weighted mean was based on a weighting of 4:1, which would reflect a higher contribution of information from the annual estimate and thus be closer to an observation. In areas with high variance, the weighting ratio of 1:1 would reflect a greater effect of the climatology in determining the interpolation estimate. 

The optimal interpolation temperature fields were evaluated using cross validation and a comparison to external data. The performance of optimal interpolation was compared to the predictive skill of using either the climatology or annual interpolation alone by doing ten random cross validations of each treatment. Each random draw of training and test sets sampled 3% of the data for the test set, or about 500 observations per draw. The temperature fields were fit with the training data and compared with the test set data. The lowest error rates were realized with the optimal interpolation contrasted with highest predictive error associated with fields based on the climatology alone (see Appendix B, Figure B1). The spatial distribution of error had distinct depth and seasonal patterns. The spatial errors associated with the surface estimates were generally low with the exception of a few locations along the shelf break between latitudes 39-41°N; the spatial error in the bottom temperature varied by season, and was concentrated along the shelf break in spring and across the shelf between latitudes 36-40°N in fall (see Appendix b, Figure B2). The optimal interpolation data were also compared to external data from other collection programs. The absolute errors between surface temperature data collected by satellites and the interpolation had interquartile ranges of approximately ±0.75°C (see Appendix C). The absolute error in a comparison of interpolated bottom temperature to opportunist sampling was approximately ±0.75°C for spring bottom temperature and approximately 0.75-1.0°C in the fall. 

Salinity was estimated in the same way with the exception of collection correction, which was deemed unnecessary for the salinity data.


