---
title:
    | 
    | Ecosystem Context for Stock Assessments:
    | summer flounder
output: 
        html_document:
                fig_caption: yes
---


<!---
INSTRUCTIONS:
1) Save the ECSA_template.rmd as a new file, e.g., "ECSA_summer-flounder.rmd"
2) Change the title in the yaml to the common name
3) Modify the common name and stock code in the "setup" code chunk
4) Add the appropriate text and methods for the stock and knit!

-->

```{r setup, include=FALSE}
## Load packages
library(dplyr)
library(rvest)
library(ggplot2)

knitr::opts_chunk$set(echo = TRUE)

# Load in survey data, right now it is only for summer flounder
load("data/df_survdat.rda")

## Change these objects
common_name <- "summer-flounder"
stock_code <- "sumflo"
sci_name <- "Paralichthys dentatus"

## Read in stock area vectors
all_stock_area <- read.csv("data/season_stock_strata.csv")
clean_name <-  gsub("-", " ", common_name)

strata_spring <- all_stock_area %>% 
  dplyr::filter(sp == stock_code,
         season == "spring") %>% 
  dplyr::pull(strata)

strata_fall <- all_stock_area %>% 
  dplyr::filter(sp == stock_code,
         season == "fall") %>% 
  dplyr::pull(strata)

```


# Overview
This report provides contextual ecosystem information for `r clean_name` (*`r sci_name`*) on the NE Shelf. Data extractions for spring and fall are confined to the `r clean_name` stock areas representing the stock definition based on respective survey strata sets. The information is intended to span a range of potential factors affecting the productivity and distribution of `r clean_name`, including: . 

These factors can be used to qualitatively inform the interpretation of population status and/or quantitatively, to improve model fits. The range and complexity of ecosystem data makes it unlikely to find the most relevant and comprehensive factor variables with a first evaluation; this process will require an iterative approach of evaluation and feedback. Additional indices can be included to address the needs of the working group.

* List
* highlights
* here
* 

```{r}

# select species codes from survey, fishery, other databases
# code to get geographic footprint, might differ by survey and catch data
# define any other species specific attributes to pass to indicator code below

```


## Surface and bottom temperature

## Surface and bottom salinity

## Chlorophyll concentration

## Zooplankton abundance

## Habitat


```{r trawl-habitat, echo = FALSE}

source("R/prob_occurence.R")

df_survdat_spring <-
  df_survdat %>%
  dplyr::filter(YEAR > 1976,
                SEASON == "SPRING",
                STRATUM %in% strata_spring)

df_survdat_fall <-
  df_survdat %>%
  dplyr::filter(YEAR > 1976,
                SEASON == "FALL",
                STRATUM %in% strata_fall)

df_survdat2use <-
  rbind(df_survdat_spring,
        df_survdat_fall) %>%
  dplyr::mutate(pres = BIOMASS > 0)


df_prob_occ <-
  df_survdat2use %>%
  dplyr::group_by(SEASON, YEAR) %>%
  dplyr::do(calc_p(df = .)) %>% 
  ungroup() %>% 
  mutate(SEASON = tolower(SEASON),
         SEASON = factor(SEASON, levels = c("spring", "fall")))

# Make plot
ggplot(df_prob_occ, 
       aes(x = YEAR, y = p)) +
  geom_point() +
  geom_errorbar(aes(ymin = p_low, ymax = p_high), 
                size = 0.3, width = 0.3) +
  geom_line() +
  xlab("Year") +
  ylab("Probability of occurence") +
  theme_bw() +
  theme(axis.title = element_text(size = 13),
        strip.text = element_text(size = 10),
        strip.background = NULL) +
  facet_wrap(~ SEASON)

```

## Diet composition

## Methods

<!---
Use the following to pull indices from the current conditions or elsewhere
-->
```{r kd, eval = FALSE, echo = FALSE, fig.cap= "Kernel density is ..."}
plot_type <- "kd"
url <- sprintf("https://www.nefsc.noaa.gov/ecosys/current-conditions/figures/%s/%s-%s.png",
               plot_type,
               common_name,
               plot_type)

knitr::include_graphics(url)
```
